<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	 
	 <meta name="description" content="<p>Details of interfaces and subroutine of the cpl-library including source code</p>">
    
    <meta name="author" content="Chris MacMackin" >
    <link rel="icon" href="../favicon.png">

    <title>coupler.f90 &ndash; Fortran Program</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">Fortran Program </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
				
                
            <li><a href="../lists/files.html">Source Files</a></li>
				
				
            <li><a href="../lists/modules.html">Modules</a></li>
				
				
            <li><a href="../lists/procedures.html">Procedures</a></li>
				
								
				
          </ul>
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>coupler.f90
    <small>Source File</small>
    
    </h1>
	 
<div class="row">
<div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
    <li><i class="fa fa-code"></i><a href="../src/coupler.f90"> Source File</a></li>
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
     <li class="active">coupler.f90</li>
  </ol>
  </div>
</div>
    
  </div>
  <div class="row">
    <div class="col-lg-3">
    
  
  
  
  
  
  
  <div class="panel panel-primary">
    <div class="panel-heading text-left"><h3 class="panel-title">Modules</h3></div>
    <div class="list-group">
      
      <a class="list-group-item" href="../module/coupler.html">coupler</a>
      
    </div>
  </div>
  
  
  
  
  
  
  
  
  
  
  
  <div class="panel panel-primary">
    <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
    <div class="list-group">
      <a class="list-group-item" href="../sourcefile/coupler.f90.html#src">coupler.f90</a>
    </div>
  </div>
  
  <hr>
  
  <div class="panel panel-default">
    <div class="panel-heading text-left"><h3 class="panel-title">All Source Files</h3></div>
    <div class="list-group">
      
      <a class="list-group-item" href="../sourcefile/coupler.f90.html">coupler.f90</a>
      
      <a class="list-group-item" href="../sourcefile/coupler_module.f90.html">coupler_module.f90</a>
      
    </div>
  </div>
  
  
    </div>
    <div class="col-lg-9" id='text'>
    <p>Routines accessible from application ( molecular or continuum ) after 
 the name, in parenthesis, is the realm in which each routine must be called</p>
<ul>
<li>
<p>CPL_send_data              (cfd+md)   sends grid data exchanged between 
                                      realms ( generic interface)</p>
</li>
<li>
<p>CPL_recv_data              (cfd+md)   receives data exchanged between realms 
                                      ( generic interface)</p>
</li>
<li>
<p>CPL_cfd_get               (cfd)    returns coupler internal parameters 
                                      for CFD realm</p>
</li>
<li>
<p>CPL_md_get                 (md)    returns coupler internal parameters 
                                      for MD realm</p>
</li>
<li>
<p>CPL_md_get_save_period     (md)    auxiliary used for testing</p>
</li>
<li>
<p>CPL_md_get_average_period  (md)    returns average period of BC</p>
</li>
<li>
<p>CPL_md_get_md_per_cfd_dt   (md)  returns the number of step MD does for 
                                      each CFD step</p>
</li>
<li>
<p>CPL_md_get_nsteps          (md)    returm CFD nsteps  </p>
</li>
<li>
<p>CPL_md_get_dt_cfd          (md)    returns MD dt</p>
</li>
<li>
<p>CPL_md_set                 (md)    sets zL if CFD is 2D</p>
</li>
<li>
<p>CPL_md_get_density         (md)    gets CFD density</p>
</li>
<li>
<p>CPL_md_get_cfd_id          (md)    id for CFD code, possible values set 
                                      in coupler_parameters</p>
</li>
</ul>
<p>@author  Lucian Anton, November 2011<br>
 @author Edward Smith, Dave Trevelyan September 2012
 @see coupler_module</p>
    <br>
    <section>
    <h2><a class="anchor" name="src"></a>Source Code</h2>
    <div class="highlight"><pre><span class="c">!=============================================================================</span>
<span class="c">!</span>
<span class="c">!    ________/\\\\\\\\\__/\\\\\\\\\\\\\____/\\\_____________</span>
<span class="c">!     _____/\\\////////__\/\\\/////////\\\_\/\\\_____________</span>
<span class="c">!      ___/\\\/___________\/\\\_______\/\\\_\/\\\_____________</span>
<span class="c">!       __/\\\_____________\/\\\\\\\\\\\\\/__\/\\\_____________</span>
<span class="c">!        _\/\\\_____________\/\\\/////////____\/\\\_____________</span>
<span class="c">!         _\//\\\____________\/\\\_____________\/\\\_____________</span>
<span class="c">!          __\///\\\__________\/\\\_____________\/\\\_____________</span>
<span class="c">!           ____\////\\\\\\\\\_\/\\\_____________\/\\\\\\\\\\\\\\\_</span>
<span class="c">!            _______\/////////__\///______________\///////////////__</span>
<span class="c">!</span>
<span class="c">!</span>
<span class="c">!                         C P L  -  L I B R A R Y</span>
<span class="c">!</span>
<span class="c">!           Copyright (C) 2012-2015 Edward Smith &amp; David Trevelyan</span>
<span class="c">!</span>
<span class="c">!License</span>
<span class="c">!</span>
<span class="c">!    This file is part of CPL-Library.</span>
<span class="c">!</span>
<span class="c">!    CPL-Library is free software: you can redistribute it and/or modify</span>
<span class="c">!    it under the terms of the GNU General Public License as published by</span>
<span class="c">!    the Free Software Foundation, either version 3 of the License, or</span>
<span class="c">!    (at your option) any later version.</span>
<span class="c">!</span>
<span class="c">!    CPL-Library is distributed in the hope that it will be useful,</span>
<span class="c">!    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c">!    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c">!    GNU General Public License for more details.</span>
<span class="c">!</span>
<span class="c">!    You should have received a copy of the GNU General Public License</span>
<span class="c">!    along with CPL-Library.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c">!</span>
<span class="c">!</span>
<span class="c">!Description</span>
<span class="c">!</span>
<span class="c">!</span>
<span class="c">!Author(s)</span>
<span class="c">!</span>
<span class="c">!   Edward Smith</span>
<span class="c">!   David Trevelyan</span>
<span class="c">!</span>
<span class="c">!! Routines accessible from application ( molecular or continuum ) after </span>
<span class="c">!! the name, in parenthesis, is the realm in which each routine must be called</span>
<span class="c">!!</span>
<span class="c">! SIMULATION SIMULATION SIMULATION SIMULATION SIMULATION SIMULATION SIMULATION</span>
<span class="c">!!</span>
<span class="c">!! - CPL_send_data        	  (cfd+md)   sends grid data exchanged between </span>
<span class="c">!!                                      realms ( generic interface)</span>
<span class="c">!!</span>
<span class="c">!! - CPL_recv_data        	  (cfd+md)   receives data exchanged between realms </span>
<span class="c">!!                                      ( generic interface)</span>
<span class="c">!!</span>
<span class="c">!! - CPL_cfd_get               (cfd)    returns coupler internal parameters </span>
<span class="c">!!                                      for CFD realm</span>
<span class="c">!!</span>
<span class="c">!! - CPL_md_get                 (md)    returns coupler internal parameters </span>
<span class="c">!!                                      for MD realm</span>
<span class="c">!!</span>
<span class="c">!! - CPL_md_get_save_period     (md)    auxiliary used for testing</span>
<span class="c">!!</span>
<span class="c">!! - CPL_md_get_average_period  (md)    returns average period of BC</span>
<span class="c">!!</span>
<span class="c">!! - CPL_md_get_md_per_cfd_dt   (md) 	returns the number of step MD does for </span>
<span class="c">!!                                      each CFD step</span>
<span class="c">!!</span>
<span class="c">!! - CPL_md_get_nsteps          (md)    returm CFD nsteps  </span>
<span class="c">!!</span>
<span class="c">!! - CPL_md_get_dt_cfd          (md)    returns MD dt</span>
<span class="c">!!</span>
<span class="c">!! - CPL_md_set                 (md)    sets zL if CFD is 2D</span>
<span class="c">!!</span>
<span class="c">!! - CPL_md_get_density         (md)    gets CFD density</span>
<span class="c">!!</span>
<span class="c">!! - CPL_md_get_cfd_id          (md)    id for CFD code, possible values set </span>
<span class="c">!!                                      in coupler_parameters</span>
<span class="c">!!</span>
<span class="c">!! @author  Lucian Anton, November 2011  </span>
<span class="c">!! @author Edward Smith, Dave Trevelyan September 2012</span>
<span class="c">!! @see coupler_module</span>
<span class="c">!=============================================================================</span>

<span class="k">module </span><span class="nv">coupler</span>
	<span class="k">USE </span><span class="nv">ISO_C_BINDING</span>
    <span class="k">implicit none</span>

<span class="k">    interface </span><span class="nv">CPL_send</span>
        <span class="k">module </span><span class="nv">procedure</span> <span class="nv">CPL_send_3d</span><span class="p">,</span> <span class="nv">CPL_send_4d</span>
    <span class="k">end interface</span>

<span class="k">    interface </span><span class="nv">CPL_recv</span>
        <span class="k">module </span><span class="nv">procedure</span> <span class="nv">CPL_recv_3d</span><span class="p">,</span> <span class="nv">CPL_recv_4d</span>
    <span class="k">end interface</span>

<span class="k">    private </span><span class="nv">CPL_send_3d</span><span class="p">,</span> <span class="nv">CPL_send_4d</span><span class="p">,</span> <span class="p">&amp;</span>
        <span class="nv">CPL_send_xd</span><span class="p">,</span> <span class="nv">CPL_recv_3d</span><span class="p">,</span> <span class="nv">CPL_recv_4d</span><span class="p">,&amp;</span>
        <span class="nv">CPL_recv_xd</span>

<span class="k">contains</span>


<span class="c">!=============================================================================</span>
<span class="c">!				 _____ _                 _       _   _             </span>
<span class="c">!				/  ___(_)               | |     | | (_)            </span>
<span class="c">!				\ `--. _ _ __ ___  _   _| | __ _| |_ _  ___  _ __  </span>
<span class="c">!				 `--. \ | &#39;_ ` _ \| | | | |/ _` | __| |/ _ \| &#39;_ \</span>
<span class="c">!				/\__/ / | | | | | | |_| | | (_| | |_| | (_) | | | |</span>
<span class="c">!				\____/|_|_| |_| |_|\__,_|_|\__,_|\__|_|\___/|_| |_|</span>
<span class="c">!</span>
<span class="c">!------------------------------------------------------------------------------</span>
<span class="c">!                              CPL_gather                                     -</span>
<span class="c">!------------------------------------------------------------------------------</span>
<span class="c">!&gt;</span>
<span class="c">!! Perform gather operation on CPL_OLAP_COMM communicator. The CFD processor</span>
<span class="c">!! is the root process. The gathered data is effectively &quot;slotted&quot; into the</span>
<span class="c">!! correct part of the recvarray, and is intented for use in providing the</span>
<span class="c">!! CFD simulation boundary conditions with data obtained from the MD</span>
<span class="c">!! simulation.   </span>
<span class="c">!!</span>
<span class="c">!! - Synopsis</span>
<span class="c">!!</span>
<span class="c">!!  - CPL_gather(gatherarray,npercell,limits,recvarray)</span>
<span class="c">!!</span>
<span class="c">!! - Input</span>
<span class="c">!!</span>
<span class="c">!!  - gatherarray</span>
<span class="c">!!   - Assumed shape array of data to be gathered from each MD processor</span>
<span class="c">!!     in the overlap communicator.</span>
<span class="c">!!</span>
<span class="c">!!  - limits</span>
<span class="c">!!   - Integer array of length 6, specifying the global cell extents of the</span>
<span class="c">!!     region to be gathered, is the same on ALL processors.</span>
<span class="c">!!</span>
<span class="c">!!  - npercell</span>
<span class="c">!!   - number of data points per cell to be gathered (integer)</span>
<span class="c">!!     Note: should be the same as size(gatherarray(1)) for MD</span>
<span class="c">!!     processor. E.G. npercell = 3 for gathering 3D velocities.</span>
<span class="c">!!</span>
<span class="c">!! - Input/Output</span>
<span class="c">!!  - recvarray</span>
<span class="c">!!   - The array in which the gathered values are to be stored on the CFD</span>
<span class="c">!!     processor. The only values to be changed in recvarray are:</span>
<span class="c">!!     recvarray(limits(1):limits(2),limits(3):limits(4),limits(5):limits(6))</span>
<span class="c">!!</span>
<span class="c">!! - Output Parameters</span>
<span class="c">!!  - NONE</span>
<span class="c">!!</span>
<span class="c">!! @author David Trevelyan</span>
<span class="k">subroutine </span><span class="nv">CPL_gather</span><span class="p">(</span><span class="nv">gatherarray</span><span class="p">,</span><span class="nv">npercell</span><span class="p">,</span><span class="nv">limits</span><span class="p">,</span><span class="nv">recvarray</span><span class="p">)</span><span class="c">!todo better name than recvarray</span>
	<span class="k">use </span><span class="nv">mpi</span>
	<span class="k">use </span><span class="nv">coupler_module</span>
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">npercell</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">limits</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">dimension</span><span class="p">(:,:,:,:),</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="nv">gatherarray</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">dimension</span><span class="p">(:,:,:,:),</span> <span class="k">intent</span><span class="p">(</span><span class="nv">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">recvarray</span>

	<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">sendcount</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="nv">recvcounts</span><span class="p">,</span> <span class="nv">displs</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="nv">sendbuf</span> 
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="nv">recvbuf</span> 
    <span class="k">if</span> <span class="p">(</span><span class="ow">.not.</span> <span class="nv">CPL_overlap</span><span class="p">())</span> <span class="k">return</span>

<span class="k">    call </span><span class="nv">check_limits_consistency</span>
	
	<span class="k">call </span><span class="nv">prepare_gatherv_parameters</span>	
	
	<span class="k">if</span> <span class="p">(</span><span class="nv">realm</span><span class="ow">.eq.</span><span class="nv">md_realm</span><span class="p">)</span> <span class="k">call </span><span class="nv">pack_sendbuf</span>

	<span class="k">call </span><span class="nv">MPI_gatherv</span><span class="p">(</span><span class="nv">sendbuf</span><span class="p">,</span><span class="nv">sendcount</span><span class="p">,</span><span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,</span><span class="nv">recvbuf</span><span class="p">,</span>    <span class="p">&amp;</span>
	                 <span class="nv">recvcounts</span><span class="p">,</span><span class="nv">displs</span><span class="p">,</span><span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,</span><span class="nv">CFDid_olap</span><span class="p">,</span> <span class="p">&amp;</span>
	                 <span class="nv">CPL_OLAP_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">realm</span><span class="ow">.eq.</span><span class="nv">cfd_realm</span><span class="p">)</span> <span class="k">call </span><span class="nv">unpack_recvbuf</span> 

	<span class="k">call </span><span class="nv">deallocate_gather_u</span>
	
<span class="k">contains</span>

<span class="k">    subroutine </span><span class="nv">check_limits_consistency</span>
        <span class="k">implicit none</span>

<span class="k">        </span><span class="kt">logical</span> <span class="kd">::</span> <span class="nv">consistent</span> <span class="o">=</span> <span class="nb">.true.</span>

        <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">i</span><span class="p">,</span> <span class="nv">cfd_limits</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="nv">md_limits</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">md_limits_send</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="nv">cfd_limits_send</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

        <span class="k">select case</span> <span class="p">(</span><span class="nv">realm</span><span class="p">)</span>
        <span class="k">case</span> <span class="p">(</span><span class="nv">md_realm</span><span class="p">)</span>

            <span class="nv">md_limits</span> <span class="o">=</span> <span class="nv">limits</span>
            <span class="nv">cfd_limits</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">case</span> <span class="p">(</span><span class="nv">cfd_realm</span><span class="p">)</span>

            <span class="nv">md_limits</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="nv">cfd_limits</span> <span class="o">=</span> <span class="nv">limits</span>

        <span class="k">end select</span>

<span class="k">        </span><span class="nv">md_limits_send</span> <span class="o">=</span> <span class="nv">md_limits</span>
        <span class="nv">cfd_limits_send</span> <span class="o">=</span> <span class="nv">cfd_limits</span>

        <span class="c">! Since we set md/cfd limits to zero in opposing realms, MPI_MAX</span>
        <span class="c">! will result in the correct limits on both sides</span>
        <span class="k">call </span><span class="nv">MPI_Allreduce</span><span class="p">(</span><span class="nv">md_limits_send</span><span class="p">,</span> <span class="nv">md_limits</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="nv">MPI_INTEGER</span><span class="p">,</span> <span class="nv">MPI_MAX</span><span class="p">,</span> <span class="p">&amp;</span>
                           <span class="nv">CPL_OLAP_COMM</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
        <span class="k">call </span><span class="nv">MPI_Allreduce</span><span class="p">(</span><span class="nv">cfd_limits_send</span><span class="p">,</span> <span class="nv">cfd_limits</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="nv">MPI_INTEGER</span><span class="p">,</span> <span class="nv">MPI_MAX</span><span class="p">,</span> <span class="p">&amp;</span>
                           <span class="nv">CPL_OLAP_COMM</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

        <span class="k">do </span><span class="nv">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">md_limits</span><span class="p">(</span><span class="nv">i</span><span class="p">)</span> <span class="ow">.ne.</span> <span class="nv">cfd_limits</span><span class="p">(</span><span class="nv">i</span><span class="p">))</span> <span class="nv">consistent</span> <span class="o">=</span> <span class="nb">.false.</span>
        <span class="k">end do</span>
<span class="k">        </span>
<span class="k">        if</span> <span class="p">(</span><span class="ow">.not.</span> <span class="nv">consistent</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;MD and CFD limits not consistent in CPL_gather&quot;</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">            return</span>
<span class="k">        end if</span>

<span class="k">    end subroutine </span><span class="nv">check_limits_consistency</span>
	<span class="k">subroutine </span><span class="nv">prepare_gatherv_parameters</span>
		<span class="k">implicit none</span>

<span class="k">		</span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">coord</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">ncells</span><span class="p">,</span><span class="nv">bufsize</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">trank_olap</span><span class="p">,</span><span class="nv">tid_olap</span>
		
		<span class="c">! Check send limits are inside overlap region</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">limits</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">.lt.</span> <span class="nv">icmin</span> <span class="ow">.or.</span> <span class="p">&amp;</span>
		    <span class="nv">limits</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">.gt.</span> <span class="nv">icmax</span> <span class="ow">.or.</span> <span class="p">&amp;</span>
		    <span class="nv">limits</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="ow">.lt.</span> <span class="nv">jcmin</span> <span class="ow">.or.</span> <span class="p">&amp;</span>
		    <span class="nv">limits</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="ow">.gt.</span> <span class="nv">jcmax</span> <span class="ow">.or.</span> <span class="p">&amp;</span>
		    <span class="nv">limits</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="ow">.lt.</span> <span class="nv">kcmin</span> <span class="ow">.or.</span> <span class="p">&amp;</span>
		    <span class="nv">limits</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="ow">.lt.</span> <span class="nv">kcmax</span><span class="p">)</span> <span class="k">then</span>
<span class="k">			</span>
<span class="k">			call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;Gather limits are outside global domain. &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
			                 <span class="s2">&quot;Aborting simulation.&quot;</span><span class="p">)</span>
			
		<span class="k">end if</span> 
		

		<span class="c">! Check if CFD processor has tried to &quot;send&quot; anything</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">myid_olap</span><span class="ow">.eq.</span><span class="nv">CFDid_olap</span> <span class="ow">.and.</span> <span class="nb">product</span><span class="p">(</span><span class="nb">shape</span><span class="p">(</span><span class="nv">gatherarray</span><span class="p">))</span><span class="ow">.ne.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">			call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s1">&#39;CFD proc input to CPL_gather: &#39;</span>          <span class="o">//</span> <span class="p">&amp;</span>
							 <span class="s1">&#39;gatherarray has nonzero size. Aborting &#39;</span> <span class="o">//</span> <span class="p">&amp;</span>
							 <span class="s1">&#39;from prepare_gatherv_parameters&#39;</span> <span class="p">)</span>
		<span class="k">end if</span>

		<span class="c">! Allocate send buffer</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">realm</span><span class="ow">.eq.</span><span class="nv">md_realm</span><span class="p">)</span> <span class="k">then</span>
<span class="k">			call </span><span class="nv">CPL_Cart_coords</span><span class="p">(</span><span class="nv">CPL_CART_COMM</span><span class="p">,</span><span class="nv">rank_cart</span><span class="p">,</span><span class="nv">realm</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">coord</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> 
			<span class="k">call </span><span class="nv">CPL_proc_portion</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="nv">limits</span><span class="p">,</span><span class="nv">portion</span><span class="p">,</span><span class="nv">ncells</span><span class="p">)</span>
			<span class="nv">bufsize</span> <span class="o">=</span> <span class="nv">npercell</span><span class="o">*</span><span class="nv">ncells</span>
		<span class="k">else</span>
<span class="k">			</span><span class="nv">bufsize</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">end if</span>
<span class="k">		allocate</span><span class="p">(</span><span class="nv">sendbuf</span><span class="p">(</span><span class="nv">bufsize</span><span class="p">))</span>

		<span class="c">! Allocate array of sendbuffer sizes and populate it</span>
		<span class="k">allocate</span><span class="p">(</span><span class="nv">recvcounts</span><span class="p">(</span><span class="nv">nproc_olap</span><span class="p">))</span>
		<span class="k">do </span><span class="nv">trank_olap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">nproc_olap</span>
			<span class="nv">tid_olap</span> <span class="o">=</span> <span class="nv">trank_olap</span> <span class="o">-</span> <span class="mi">1</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">tid_olap</span> <span class="ow">.eq.</span> <span class="nv">CFDid_olap</span><span class="p">)</span> <span class="k">then</span>
<span class="k">				</span><span class="nv">recvcounts</span><span class="p">(</span><span class="nv">trank_olap</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> 
			<span class="k">else</span>
<span class="k">				call </span><span class="nv">CPL_Cart_coords</span><span class="p">(</span><span class="nv">CPL_OLAP_COMM</span><span class="p">,</span><span class="nv">trank_olap</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="p">&amp;</span>
				                     <span class="nv">coord</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> 
				<span class="k">call </span><span class="nv">CPL_proc_portion</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="nv">limits</span><span class="p">,</span><span class="nv">portion</span><span class="p">,</span><span class="nv">ncells</span><span class="p">)</span>
				<span class="nv">recvcounts</span><span class="p">(</span><span class="nv">trank_olap</span><span class="p">)</span> <span class="o">=</span> <span class="nv">npercell</span><span class="o">*</span><span class="nv">ncells</span> 
			<span class="k">end if</span>
<span class="k">		end do</span>
	
		<span class="c">! Own sendbuffer size</span>
		<span class="nv">sendcount</span> <span class="o">=</span> <span class="nv">size</span><span class="p">(</span><span class="nv">sendbuf</span><span class="p">)</span>
		<span class="c">! Sanity check</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">sendcount</span> <span class="ow">.ne.</span> <span class="nv">recvcounts</span><span class="p">(</span><span class="nv">rank_olap</span><span class="p">))</span> <span class="k">then</span>
<span class="k">			call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s1">&#39;Send buffer sizes calculated incorrectly &#39;</span><span class="o">//</span><span class="p">&amp;</span>
			                 <span class="s1">&#39;in prepare_gatherv_parameters. Aborting.&#39;</span><span class="p">)</span>
		<span class="k">end if</span>	

		<span class="c">! Allocate recvbuffer on CFD proc</span>
		<span class="k">allocate</span><span class="p">(</span><span class="nv">recvbuf</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nv">recvcounts</span><span class="p">)))</span>

		<span class="c">! Calculate displacements for each proc in array recvbuffer</span>
		<span class="k">allocate</span><span class="p">(</span><span class="nv">displs</span><span class="p">(</span><span class="nv">nproc_olap</span><span class="p">))</span>
		<span class="nv">displs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">do </span><span class="nv">trank_olap</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="nv">nproc_olap</span>
			<span class="nv">displs</span><span class="p">(</span><span class="nv">trank_olap</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nv">recvcounts</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="nv">trank_olap</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>	
		<span class="k">end do</span>

<span class="k">	end subroutine </span><span class="nv">prepare_gatherv_parameters</span>

	<span class="k">subroutine </span><span class="nv">pack_sendbuf</span>
		<span class="k">implicit none</span>

<span class="k">		</span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">pos</span><span class="p">,</span> <span class="nv">ixyz</span><span class="p">,</span> <span class="nv">icell</span><span class="p">,</span> <span class="nv">jcell</span><span class="p">,</span> <span class="nv">kcell</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">i</span><span class="p">,</span><span class="nv">j</span><span class="p">,</span><span class="nv">k</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">coord</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="nv">mdextents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

		<span class="c">! Get MD processor extents and cells portion of send region</span>
		<span class="k">call </span><span class="nv">CPL_Cart_coords</span><span class="p">(</span><span class="nv">CPL_CART_COMM</span><span class="p">,</span><span class="nv">rank_cart</span><span class="p">,</span><span class="nv">realm</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">coord</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> 
		<span class="k">call </span><span class="nv">CPL_proc_extents</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">realm</span><span class="p">,</span><span class="nv">mdextents</span><span class="p">)</span>
		<span class="k">call </span><span class="nv">CPL_proc_portion</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">realm</span><span class="p">,</span><span class="nv">limits</span><span class="p">,</span><span class="nv">portion</span><span class="p">)</span>

		<span class="c">! If MD proc has nothing to send, exit</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="nv">portion</span><span class="ow">.eq.</span><span class="nv">VOID</span><span class="p">))</span> <span class="k">return</span>

<span class="k">		</span><span class="nv">pos</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="k">do </span><span class="nv">ixyz</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">npercell</span> 
		<span class="k">do </span><span class="nv">icell</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> 
		<span class="k">do </span><span class="nv">jcell</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> 
		<span class="k">do </span><span class="nv">kcell</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> 
			<span class="c">! Map to local coords (assumed shape array has</span>
			<span class="c">! lower bound 1 by default when input to subroutine) </span>
			<span class="nv">i</span> <span class="o">=</span> <span class="nv">icell</span> <span class="o">-</span> <span class="nv">mdextents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
			<span class="nv">j</span> <span class="o">=</span> <span class="nv">jcell</span> <span class="o">-</span> <span class="nv">mdextents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
			<span class="nv">k</span> <span class="o">=</span> <span class="nv">kcell</span> <span class="o">-</span> <span class="nv">mdextents</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
			<span class="nv">sendbuf</span><span class="p">(</span><span class="nv">pos</span><span class="p">)</span> <span class="o">=</span> <span class="nv">gatherarray</span><span class="p">(</span><span class="nv">ixyz</span><span class="p">,</span><span class="nv">i</span><span class="p">,</span><span class="nv">j</span><span class="p">,</span><span class="nv">k</span><span class="p">)</span>
			<span class="nv">pos</span> <span class="o">=</span> <span class="nv">pos</span> <span class="o">+</span> <span class="mi">1</span>
		<span class="k">end do</span>
<span class="k">		end do</span>
<span class="k">		end do</span>
<span class="k">		end do</span>
<span class="k">	</span>
<span class="k">	end subroutine </span><span class="nv">pack_sendbuf</span>
	
	<span class="k">subroutine </span><span class="nv">unpack_recvbuf</span>
		<span class="k">implicit none</span>

<span class="k">		</span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">coord</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="nv">cfdextents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">trank_olap</span><span class="p">,</span> <span class="nv">tid_olap</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">pos</span><span class="p">,</span><span class="nv">ixyz</span><span class="p">,</span><span class="nv">icell</span><span class="p">,</span><span class="nv">jcell</span><span class="p">,</span><span class="nv">kcell</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">i</span><span class="p">,</span><span class="nv">j</span><span class="p">,</span><span class="nv">k</span>

		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">tempextents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

		<span class="c">! Get CFD proc coords and extents, allocate suitable array</span>
		<span class="k">call </span><span class="nv">CPL_cart_coords</span><span class="p">(</span><span class="nv">CPL_OLAP_COMM</span><span class="p">,</span><span class="nv">rank_olap</span><span class="p">,</span><span class="nv">cfd_realm</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">coord</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
		<span class="k">call </span><span class="nv">CPL_proc_extents</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">cfd_realm</span><span class="p">,</span><span class="nv">cfdextents</span><span class="p">)</span>
		<span class="k">call </span><span class="nv">CPL_proc_portion</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">cfd_realm</span><span class="p">,</span><span class="nv">limits</span><span class="p">,</span><span class="nv">portion</span><span class="p">)</span>

		<span class="c">! Loop over all processors in overlap comm</span>
		<span class="k">do </span><span class="nv">trank_olap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">nproc_olap</span>

			<span class="nv">tid_olap</span> <span class="o">=</span> <span class="nv">trank_olap</span> <span class="o">-</span> <span class="mi">1</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">tid_olap</span> <span class="ow">.eq.</span> <span class="nv">CFDid_olap</span><span class="p">)</span> <span class="k">cycle</span>

<span class="k">			call </span><span class="nv">CPL_Cart_coords</span><span class="p">(</span><span class="nv">CPL_OLAP_COMM</span><span class="p">,</span><span class="nv">trank_olap</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">coord</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
			<span class="k">call </span><span class="nv">CPL_proc_portion</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="nv">limits</span><span class="p">,</span><span class="nv">portion</span><span class="p">)</span>

			<span class="k">call </span><span class="nv">CPL_proc_extents</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="nv">tempextents</span><span class="p">)</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="nv">portion</span><span class="ow">.eq.</span><span class="nv">VOID</span><span class="p">))</span> <span class="k">cycle</span>

			<span class="c">! Set position and unpack MD proc&#39;s part of recvbuf to</span>
			<span class="c">! correct region of recvarray	</span>
			<span class="nv">pos</span> <span class="o">=</span> <span class="nv">displs</span><span class="p">(</span><span class="nv">trank_olap</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>	
			<span class="k">do </span><span class="nv">ixyz</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">npercell</span>
			<span class="k">do </span><span class="nv">icell</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
			<span class="k">do </span><span class="nv">jcell</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
			<span class="k">do </span><span class="nv">kcell</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

				<span class="nv">i</span> <span class="o">=</span> <span class="nv">icell</span> <span class="o">-</span> <span class="nv">cfdextents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> 
				<span class="nv">j</span> <span class="o">=</span> <span class="nv">jcell</span> <span class="o">-</span> <span class="nv">cfdextents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> 
				<span class="nv">k</span> <span class="o">=</span> <span class="nv">kcell</span> <span class="o">-</span> <span class="nv">cfdextents</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> 

				<span class="nv">recvarray</span><span class="p">(</span><span class="nv">ixyz</span><span class="p">,</span><span class="nv">i</span><span class="p">,</span><span class="nv">j</span><span class="p">,</span><span class="nv">k</span><span class="p">)</span> <span class="o">=</span> <span class="nv">recvbuf</span><span class="p">(</span><span class="nv">pos</span><span class="p">)</span>
				<span class="nv">pos</span> <span class="o">=</span> <span class="nv">pos</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c">!				write(8000+myid_world,&#39;(a,i4,a,i4,a,i4,a,i4,a,f20.1)&#39;),   &amp;</span>
<span class="c">!				      &#39;recvarray(&#39;,ixyz,&#39;,&#39;,icell,&#39;,&#39;,jcell,&#39;,&#39;,kcell,&#39;) =&#39;, &amp;</span>
<span class="c">!				       recvarray(ixyz,i,j,k)</span>

			<span class="k">end do	</span>
<span class="k">			end do	</span>
<span class="k">			end do</span>
<span class="k">			end do</span>
<span class="k">					</span>
<span class="k">		end do</span>

<span class="k">	end subroutine </span><span class="nv">unpack_recvbuf</span>
	
	<span class="k">subroutine </span><span class="nv">deallocate_gather_u</span>
		<span class="k">implicit none</span>

<span class="k">		if</span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">recvcounts</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="nv">recvcounts</span><span class="p">)</span>
		<span class="k">if</span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">displs</span><span class="p">))</span>     <span class="k">deallocate</span><span class="p">(</span><span class="nv">displs</span><span class="p">)</span>
		<span class="k">if</span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">sendbuf</span><span class="p">))</span>    <span class="k">deallocate</span><span class="p">(</span><span class="nv">sendbuf</span><span class="p">)</span>
		<span class="k">if</span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">recvbuf</span><span class="p">))</span>    <span class="k">deallocate</span><span class="p">(</span><span class="nv">recvbuf</span><span class="p">)</span>

	<span class="k">end subroutine </span><span class="nv">deallocate_gather_u</span>

<span class="k">end subroutine </span><span class="nv">CPL_gather</span>

<span class="c">!------------------------------------------------------------------------------</span>
<span class="c">!                              CPL_scatter                                    -</span>
<span class="c">!------------------------------------------------------------------------------</span>
<span class="c">!&gt;</span>
<span class="c">!! Scatter cell-wise data from CFD processor to corresponding MD processors</span>
<span class="c">!! on the overlap communicator CPL_OLAP_COMM.</span>
<span class="c">!!</span>
<span class="c">!! - Synopsis</span>
<span class="c">!!</span>
<span class="c">!!  - CPL_scatter(scatterarray,npercell,limits,recvarray)</span>
<span class="c">!!</span>
<span class="c">!! - Input</span>
<span class="c">!!</span>
<span class="c">!!  - scatterarray</span>
<span class="c">!!   - assumed shape array of data to be scattered (real(kind(0.d0)))</span>
<span class="c">!!</span>
<span class="c">!!  - limits</span>
<span class="c">!!   - integer array of length 6, specifying the global cell extents of the</span>
<span class="c">!!     region to be scattered, is the same on all processors.</span>
<span class="c">!!</span>
<span class="c">!!  - npercell</span>
<span class="c">!!   - number of data points per cell to be scattered (integer).</span>
<span class="c">!!     Note: should be the same as size(scatterarray(1)) for CFD proc</span>
<span class="c">!!</span>
<span class="c">!! - Input/Output</span>
<span class="c">!!  - recvarray</span>
<span class="c">!!   - the array in which the scattered values are stored on the MD</span>
<span class="c">!!     processors.</span>
<span class="c">!!</span>
<span class="c">!! - Output</span>
<span class="c">!!  - NONE</span>
<span class="c">!! </span>
<span class="c">!! @author David Trevelyan</span>
<span class="k">subroutine </span><span class="nv">CPL_scatter</span><span class="p">(</span><span class="nv">scatterarray</span><span class="p">,</span><span class="nv">npercell</span><span class="p">,</span><span class="nv">limits</span><span class="p">,</span><span class="nv">recvarray</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span>
	<span class="k">use </span><span class="nv">mpi</span>
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">integer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">npercell</span>
	<span class="kt">integer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">limits</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:,:,:,:),</span><span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="nv">scatterarray</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:,:,:,:),</span><span class="k">intent</span><span class="p">(</span><span class="nv">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">recvarray</span> 

	<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">recvcount</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="nv">displs</span><span class="p">,</span><span class="nv">sendcounts</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="nv">recvbuf</span> 
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="nv">scatterbuf</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">.not.</span> <span class="nv">CPL_overlap</span><span class="p">())</span> <span class="k">return</span>

<span class="k">	call </span><span class="nv">prepare_scatterv_parameters</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">realm</span><span class="ow">.eq.</span><span class="nv">cfd_realm</span><span class="p">)</span> <span class="k">call </span><span class="nv">pack_scatterbuf</span>

	<span class="k">call </span><span class="nv">MPI_scatterv</span><span class="p">(</span><span class="nv">scatterbuf</span><span class="p">,</span><span class="nv">sendcounts</span><span class="p">,</span><span class="nv">displs</span><span class="p">,</span><span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="p">&amp;</span>
	                  <span class="nv">recvbuf</span><span class="p">,</span><span class="nv">recvcount</span><span class="p">,</span><span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,</span><span class="nv">CFDid_olap</span><span class="p">,</span> <span class="p">&amp;</span>
	                  <span class="nv">CPL_OLAP_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> 

	<span class="k">if</span> <span class="p">(</span><span class="nv">realm</span><span class="ow">.eq.</span><span class="nv">md_realm</span><span class="p">)</span>  <span class="k">call </span><span class="nv">unpack_scatterbuf</span>

	<span class="k">call </span><span class="nv">deallocate_scatter_s</span>

<span class="k">contains</span>

<span class="k">	subroutine </span><span class="nv">prepare_scatterv_parameters</span>
		<span class="k">implicit none</span>

<span class="k">		</span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">ncells</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">coord</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">bufsize</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">trank_olap</span><span class="p">,</span> <span class="nv">tid_olap</span>

		<span class="c">! Check send limits are inside overlap region</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">limits</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">.lt.</span> <span class="nv">icmin</span> <span class="ow">.or.</span> <span class="p">&amp;</span>
		    <span class="nv">limits</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">.gt.</span> <span class="nv">icmax</span> <span class="ow">.or.</span> <span class="p">&amp;</span>
		    <span class="nv">limits</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="ow">.lt.</span> <span class="nv">jcmin</span> <span class="ow">.or.</span> <span class="p">&amp;</span>
		    <span class="nv">limits</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="ow">.gt.</span> <span class="nv">jcmax</span> <span class="ow">.or.</span> <span class="p">&amp;</span>
		    <span class="nv">limits</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="ow">.lt.</span> <span class="nv">kcmin</span> <span class="ow">.or.</span> <span class="p">&amp;</span>
		    <span class="nv">limits</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="ow">.lt.</span> <span class="nv">kcmax</span><span class="p">)</span> <span class="k">then</span>
<span class="k">			</span>
<span class="k">			call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;Scatter limits are outside global domain. &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
			                 <span class="s2">&quot;Aborting simulation.&quot;</span><span class="p">)</span>
			
		<span class="k">end if </span>

<span class="k">		if</span> <span class="p">(</span><span class="nv">realm</span><span class="ow">.eq.</span><span class="nv">cfd_realm</span><span class="p">)</span> <span class="k">then</span>
<span class="k">			call </span><span class="nv">CPL_Cart_coords</span><span class="p">(</span><span class="nv">CPL_CART_COMM</span><span class="p">,</span><span class="nv">rank_cart</span><span class="p">,</span><span class="nv">cfd_realm</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">coord</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
			<span class="k">call </span><span class="nv">CPL_proc_portion</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">cfd_realm</span><span class="p">,</span><span class="nv">limits</span><span class="p">,</span><span class="nv">portion</span><span class="p">,</span><span class="nv">ncells</span><span class="p">)</span>
			<span class="nv">bufsize</span> <span class="o">=</span> <span class="nv">npercell</span><span class="o">*</span><span class="nv">ncells</span>
		<span class="k">else</span>
<span class="k">			</span><span class="nv">bufsize</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">end if</span>

<span class="k">		allocate</span><span class="p">(</span><span class="nv">scatterbuf</span><span class="p">(</span><span class="nv">bufsize</span><span class="p">))</span>
		<span class="k">allocate</span><span class="p">(</span><span class="nv">sendcounts</span><span class="p">(</span><span class="nv">nproc_olap</span><span class="p">))</span>
		<span class="k">allocate</span><span class="p">(</span><span class="nv">displs</span><span class="p">(</span><span class="nv">nproc_olap</span><span class="p">))</span>

		<span class="c">! Loop over all procs in overlap comm</span>
		<span class="k">do </span><span class="nv">trank_olap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">nproc_olap</span>
			<span class="nv">tid_olap</span> <span class="o">=</span> <span class="nv">trank_olap</span> <span class="o">-</span> <span class="mi">1</span>
			<span class="c">! Calculate number of data points to scatter to each proc</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">tid_olap</span> <span class="ow">.eq.</span> <span class="nv">CFDid_olap</span><span class="p">)</span> <span class="k">then</span>
<span class="k">				</span><span class="nv">sendcounts</span><span class="p">(</span><span class="nv">trank_olap</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> 
			<span class="k">else</span>
<span class="k">				call </span><span class="nv">CPL_Cart_coords</span><span class="p">(</span><span class="nv">CPL_OLAP_COMM</span><span class="p">,</span><span class="nv">trank_olap</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="p">&amp;</span>
				                     <span class="nv">coord</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span> 
				<span class="k">call </span><span class="nv">CPL_proc_portion</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="nv">limits</span><span class="p">,</span><span class="nv">portion</span><span class="p">,</span><span class="nv">ncells</span><span class="p">)</span>
				<span class="nv">sendcounts</span><span class="p">(</span><span class="nv">trank_olap</span><span class="p">)</span> <span class="o">=</span> <span class="nv">npercell</span><span class="o">*</span><span class="nv">ncells</span> 
			<span class="k">end if</span>
<span class="k">		end do</span>

		<span class="c">! Get number of data points this MD proc will receive</span>
		<span class="nv">recvcount</span> <span class="o">=</span> <span class="nv">sendcounts</span><span class="p">(</span><span class="nv">rank_olap</span><span class="p">)</span>

		<span class="c">! Calculate starting positions of each MD proc region in</span>
		<span class="c">! scatterbuf array</span>
		<span class="nv">displs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">do </span><span class="nv">trank_olap</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="nv">nproc_olap</span>
			<span class="nv">displs</span><span class="p">(</span><span class="nv">trank_olap</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nv">sendcounts</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="nv">trank_olap</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>	
		<span class="k">end do</span>

		<span class="c">! Allocate space to receive data</span>
		<span class="k">allocate</span><span class="p">(</span><span class="nv">recvbuf</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nv">sendcounts</span><span class="p">)))</span>

	<span class="k">end subroutine </span><span class="nv">prepare_scatterv_parameters</span>

	<span class="k">subroutine </span><span class="nv">pack_scatterbuf</span>
		<span class="k">implicit none</span>
<span class="k">		</span>
<span class="k">		</span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">pos</span><span class="p">,</span> <span class="nv">n</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">tid_olap</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">coord</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="nv">cfdextents</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">ixyz</span><span class="p">,</span> <span class="nv">icell</span><span class="p">,</span> <span class="nv">jcell</span><span class="p">,</span> <span class="nv">kcell</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">i</span><span class="p">,</span><span class="nv">j</span><span class="p">,</span><span class="nv">k</span>

		<span class="c">! Grab CFD proc extents to be used for local cell mapping (when an </span>
		<span class="c">! array is an input to subroutine it has lower bound 1 by default)</span>
		<span class="k">call </span><span class="nv">CPL_cart_coords</span><span class="p">(</span><span class="nv">CPL_CART_COMM</span><span class="p">,</span><span class="nv">rank_cart</span><span class="p">,</span><span class="nv">cfd_realm</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">coord</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
		<span class="k">call </span><span class="nv">CPL_proc_extents</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">cfd_realm</span><span class="p">,</span><span class="nv">cfdextents</span><span class="p">)</span>

		<span class="c">! Loop over procs in olap comm and pack scatter buffer </span>
		<span class="c">! in separate regions for each MD proc</span>
		<span class="nv">pos</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="k">do </span><span class="nv">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">nproc_olap</span>

			<span class="nv">tid_olap</span> <span class="o">=</span> <span class="nv">n</span> <span class="o">-</span> <span class="mi">1</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">tid_olap</span><span class="ow">.eq.</span><span class="nv">CFDid_olap</span><span class="p">)</span> <span class="k">cycle</span>

<span class="k">			call </span><span class="nv">CPL_Cart_coords</span><span class="p">(</span><span class="nv">CPL_OLAP_COMM</span><span class="p">,</span><span class="nv">n</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">coord</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
			<span class="k">call </span><span class="nv">CPL_proc_portion</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="nv">limits</span><span class="p">,</span><span class="nv">portion</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="nv">portion</span><span class="ow">.eq.</span><span class="nv">VOID</span><span class="p">))</span> <span class="k">cycle</span>

<span class="k">			do </span><span class="nv">ixyz</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">npercell</span>
			<span class="k">do </span><span class="nv">icell</span><span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
			<span class="k">do </span><span class="nv">jcell</span><span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
			<span class="k">do </span><span class="nv">kcell</span><span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
				<span class="nv">i</span> <span class="o">=</span> <span class="nv">icell</span> <span class="o">-</span> <span class="nv">cfdextents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
				<span class="nv">j</span> <span class="o">=</span> <span class="nv">jcell</span> <span class="o">-</span> <span class="nv">cfdextents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
				<span class="nv">k</span> <span class="o">=</span> <span class="nv">kcell</span> <span class="o">-</span> <span class="nv">cfdextents</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
				<span class="nv">scatterbuf</span><span class="p">(</span><span class="nv">pos</span><span class="p">)</span> <span class="o">=</span> <span class="nv">scatterarray</span><span class="p">(</span><span class="nv">ixyz</span><span class="p">,</span><span class="nv">i</span><span class="p">,</span><span class="nv">j</span><span class="p">,</span><span class="nv">k</span><span class="p">)</span>
				<span class="nv">pos</span> <span class="o">=</span> <span class="nv">pos</span> <span class="o">+</span> <span class="mi">1</span>
			<span class="k">end do</span>
<span class="k">			end do</span>
<span class="k">			end do</span>
<span class="k">			end do</span>
<span class="k">			</span>
<span class="k">		end do</span>
<span class="k">	</span>
<span class="k">	end subroutine </span><span class="nv">pack_scatterbuf</span>	

	<span class="k">subroutine </span><span class="nv">unpack_scatterbuf</span>
		<span class="k">implicit none</span>

<span class="k">        </span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">pos</span><span class="p">,</span> <span class="nv">ierr</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">coord</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="nv">extents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">ixyz</span><span class="p">,</span><span class="nv">icell</span><span class="p">,</span><span class="nv">jcell</span><span class="p">,</span><span class="nv">kcell</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">i</span><span class="p">,</span><span class="nv">j</span><span class="p">,</span><span class="nv">k</span>

		<span class="k">call </span><span class="nv">CPL_cart_coords</span><span class="p">(</span><span class="nv">CPL_OLAP_COMM</span><span class="p">,</span><span class="nv">rank_olap</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">coord</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
		<span class="k">call </span><span class="nv">CPL_proc_extents</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">realm</span><span class="p">,</span><span class="nv">extents</span><span class="p">)</span>
		<span class="k">call </span><span class="nv">CPL_proc_portion</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">realm</span><span class="p">,</span><span class="nv">limits</span><span class="p">,</span><span class="nv">portion</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="nv">portion</span><span class="ow">.eq.</span><span class="nv">VOID</span><span class="p">))</span> <span class="k">return</span>

<span class="k">		</span><span class="nv">pos</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="k">do </span><span class="nv">ixyz</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">npercell</span>
		<span class="k">do </span><span class="nv">icell</span><span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
		<span class="k">do </span><span class="nv">jcell</span><span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
		<span class="k">do </span><span class="nv">kcell</span><span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="nv">portion</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
			<span class="nv">i</span> <span class="o">=</span> <span class="nv">icell</span> <span class="o">-</span> <span class="nv">extents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
			<span class="nv">j</span> <span class="o">=</span> <span class="nv">jcell</span> <span class="o">-</span> <span class="nv">extents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
			<span class="nv">k</span> <span class="o">=</span> <span class="nv">kcell</span> <span class="o">-</span> <span class="nv">extents</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
			<span class="nv">recvarray</span><span class="p">(</span><span class="nv">ixyz</span><span class="p">,</span><span class="nv">i</span><span class="p">,</span><span class="nv">j</span><span class="p">,</span><span class="nv">k</span><span class="p">)</span> <span class="o">=</span> <span class="nv">recvbuf</span><span class="p">(</span><span class="nv">pos</span><span class="p">)</span>
<span class="c">!			write(7000+myid_realm,&#39;(i4,a,i4,a,i4,a,i4,a,i4,a,f20.1)&#39;),        &amp;</span>
<span class="c">!				  rank_cart,&#39; recvarray(&#39;,ixyz,&#39;,&#39;,icell,&#39;,&#39;,jcell,&#39;,&#39;,kcell, &amp;</span>
<span class="c">!				  &#39;) =&#39;,recvarray(ixyz,i,j,k)</span>
			<span class="nv">pos</span> <span class="o">=</span> <span class="nv">pos</span> <span class="o">+</span> <span class="mi">1</span>
		<span class="k">end do	</span>
<span class="k">		end do	</span>
<span class="k">		end do</span>
<span class="k">		end do</span>

<span class="k">	end subroutine </span><span class="nv">unpack_scatterbuf</span>
	
	<span class="k">subroutine </span><span class="nv">deallocate_scatter_s</span>
		<span class="k">implicit none</span>

<span class="k">		if</span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">displs</span><span class="p">))</span>     <span class="k">deallocate</span><span class="p">(</span><span class="nv">displs</span><span class="p">)</span>
		<span class="k">if</span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">scatterbuf</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="nv">scatterbuf</span><span class="p">)</span>
		<span class="k">if</span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">recvbuf</span><span class="p">))</span>    <span class="k">deallocate</span><span class="p">(</span><span class="nv">recvbuf</span><span class="p">)</span>
		<span class="k">if</span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">sendcounts</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="nv">sendcounts</span><span class="p">)</span>

	<span class="k">end subroutine </span><span class="nv">deallocate_scatter_s</span>

<span class="k">end subroutine </span><span class="nv">CPL_scatter</span>


<span class="c">!=============================================================================</span>
<span class="c">!&gt;</span>
<span class="c">!! CPL_send_data wrapper for 3d arrays</span>
<span class="c">!! see CPL_send_xd for input description</span>
<span class="c">!! @see coupler#subroutine_CPL_send_xd</span>
<span class="c">!-----------------------------------------------------------------------------</span>
<span class="k">subroutine </span><span class="nv">CPL_send_3d</span><span class="p">(</span><span class="nv">temp</span><span class="p">,</span><span class="nv">icmin_send</span><span class="p">,</span><span class="nv">icmax_send</span><span class="p">,</span><span class="nv">jcmin_send</span><span class="p">,</span> <span class="p">&amp;</span> 
							<span class="nv">jcmax_send</span><span class="p">,</span><span class="nv">kcmin_send</span><span class="p">,</span><span class="nv">kcmax_send</span><span class="p">,</span><span class="nv">send_flag</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> <span class="nv">icmin_olap</span><span class="p">,</span><span class="nv">icmax_olap</span><span class="p">,</span> <span class="p">&amp;</span> 
							   <span class="nv">jcmin_olap</span><span class="p">,</span><span class="nv">jcmax_olap</span><span class="p">,</span> <span class="p">&amp;</span>
							   <span class="nv">kcmin_olap</span><span class="p">,</span><span class="nv">kcmax_olap</span><span class="p">,</span><span class="nv">error_abort</span>
    <span class="k">implicit none</span>
<span class="k"> </span>
<span class="k">	</span><span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">),</span> <span class="k">optional</span>						<span class="kd">::</span> <span class="nv">send_flag</span>
 	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">),</span> <span class="k">optional</span>						<span class="kd">::</span> <span class="nv">icmax_send</span><span class="p">,</span><span class="nv">icmin_send</span>
 	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">),</span> <span class="k">optional</span>						<span class="kd">::</span> <span class="nv">jcmax_send</span><span class="p">,</span><span class="nv">jcmin_send</span>
 	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">),</span> <span class="k">optional</span>						<span class="kd">::</span> <span class="nv">kcmax_send</span><span class="p">,</span><span class="nv">kcmin_send</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:,:,:),</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="nv">temp</span>
    
    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">n1</span><span class="p">,</span><span class="nv">n2</span><span class="p">,</span><span class="nv">n3</span><span class="p">,</span><span class="nv">n4</span>
	<span class="kt">integer</span>	<span class="kd">::</span> <span class="nv">icmin</span><span class="p">,</span><span class="nv">icmax</span><span class="p">,</span><span class="nv">jcmin</span><span class="p">,</span><span class="nv">jcmax</span><span class="p">,</span><span class="nv">kcmin</span><span class="p">,</span><span class="nv">kcmax</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:,:,:,:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="nv">asend</span>


	<span class="c">!Revert to default i domain sending - top of overlap to bottom of overlap</span>
	<span class="k">if</span> <span class="p">((</span><span class="nb">present</span><span class="p">(</span><span class="nv">icmax_send</span><span class="p">))</span> <span class="ow">.and.</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">icmin_send</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">icmax</span> <span class="o">=</span> <span class="nv">icmax_send</span><span class="p">;</span>	<span class="nv">icmin</span> <span class="o">=</span> <span class="nv">icmin_send</span>
	<span class="nv">elseif</span> <span class="p">((</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">icmax_send</span><span class="p">))</span><span class="ow">.and.</span><span class="p">(</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">icmin_send</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">icmax</span> <span class="o">=</span> <span class="nv">icmax_olap</span><span class="p">;</span>	<span class="nv">icmin</span> <span class="o">=</span> <span class="nv">icmin_olap</span>
	<span class="k">else</span>
<span class="k">		call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_send error - both max and min i limits &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
						 <span class="s2">&quot;required and only one supplied&quot;</span><span class="p">)</span>
	<span class="k">endif</span>

	<span class="c">!Revert to default j domain sending - top of overlap to bottom of overlap</span>
	<span class="k">if</span> <span class="p">((</span><span class="nb">present</span><span class="p">(</span><span class="nv">jcmax_send</span><span class="p">))</span> <span class="ow">.and.</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">jcmin_send</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">jcmax</span> <span class="o">=</span> <span class="nv">jcmax_send</span><span class="p">;</span>	<span class="nv">jcmin</span> <span class="o">=</span> <span class="nv">jcmin_send</span>
	<span class="nv">elseif</span> <span class="p">((</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">jcmax_send</span><span class="p">))</span><span class="ow">.and.</span><span class="p">(</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">jcmin_send</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">jcmax</span> <span class="o">=</span> <span class="nv">jcmax_olap</span><span class="p">;</span>	<span class="nv">jcmin</span> <span class="o">=</span> <span class="nv">jcmin_olap</span>
	<span class="k">else</span>
<span class="k">		call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_send error - both max and min j limits &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
						 <span class="s2">&quot;required and only one supplied&quot;</span><span class="p">)</span>
	<span class="k">endif</span>

	<span class="c">!Revert to default k domain sending - top of overlap to bottom of overlap</span>
	<span class="k">if</span> <span class="p">((</span><span class="nb">present</span><span class="p">(</span><span class="nv">kcmax_send</span><span class="p">))</span> <span class="ow">.and.</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">kcmin_send</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">kcmax</span> <span class="o">=</span> <span class="nv">kcmax_send</span><span class="p">;</span> <span class="nv">kcmin</span> <span class="o">=</span> <span class="nv">kcmin_send</span>
	<span class="nv">elseif</span> <span class="p">((</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">kcmax_send</span><span class="p">))</span><span class="ow">.and.</span><span class="p">(</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">kcmin_send</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">kcmax</span> <span class="o">=</span> <span class="nv">kcmax_olap</span><span class="p">;</span>	<span class="nv">kcmin</span> <span class="o">=</span> <span class="nv">kcmin_olap</span>
	<span class="k">else</span>
<span class="k">		call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_send error - both max and min k limits &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
						 <span class="s2">&quot;required and only one supplied&quot;</span><span class="p">)</span>
	<span class="k">endif</span>

<span class="k">   </span>
<span class="k">    </span><span class="nv">n1</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="nv">n2</span> <span class="o">=</span> <span class="nv">size</span><span class="p">(</span><span class="nv">temp</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="nv">n3</span> <span class="o">=</span> <span class="nv">size</span><span class="p">(</span><span class="nv">temp</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="nv">n4</span> <span class="o">=</span> <span class="nv">size</span><span class="p">(</span><span class="nv">temp</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

	<span class="c">!Add padding column to 3D array to make it 4D</span>
	<span class="k">allocate</span><span class="p">(</span><span class="nv">asend</span><span class="p">(</span><span class="nv">n1</span><span class="p">,</span><span class="nv">n2</span><span class="p">,</span><span class="nv">n3</span><span class="p">,</span><span class="nv">n4</span><span class="p">))</span>
	<span class="nv">asend</span><span class="p">(</span><span class="mi">1</span><span class="p">,:,:,:)</span> <span class="o">=</span> <span class="nv">temp</span><span class="p">(:,:,:)</span>

    <span class="k">call </span><span class="nv">CPL_send_xd</span><span class="p">(</span><span class="nv">asend</span><span class="p">,</span><span class="nv">icmax</span><span class="p">,</span><span class="nv">icmin</span><span class="p">,</span><span class="nv">jcmax</span><span class="p">,</span> <span class="p">&amp;</span> 
						   <span class="nv">jcmin</span><span class="p">,</span><span class="nv">kcmax</span><span class="p">,</span><span class="nv">kcmin</span><span class="p">,</span><span class="nv">send_flag</span> <span class="p">)</span>

<span class="k">end subroutine </span><span class="nv">CPL_send_3d</span>

<span class="c">!=============================================================================</span>
<span class="c">!&gt;</span>
<span class="c">!! CPL_send_data wrapper for 4d arrays</span>
<span class="c">!! see CPL_send_xd for input description</span>
<span class="c">!! @see coupler#subroutine_CPL_send_xd</span>
<span class="c">!-----------------------------------------------------------------------------</span>
<span class="k">subroutine </span><span class="nv">CPL_send_4d</span><span class="p">(</span><span class="nv">asend</span><span class="p">,</span><span class="nv">icmin_send</span><span class="p">,</span><span class="nv">icmax_send</span><span class="p">,</span><span class="nv">jcmin_send</span><span class="p">,</span> <span class="p">&amp;</span> 
							 <span class="nv">jcmax_send</span><span class="p">,</span><span class="nv">kcmin_send</span><span class="p">,</span><span class="nv">kcmax_send</span><span class="p">,</span><span class="nv">send_flag</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> <span class="nv">icmin_olap</span><span class="p">,</span><span class="nv">icmax_olap</span><span class="p">,</span> <span class="p">&amp;</span> 
							   <span class="nv">jcmin_olap</span><span class="p">,</span><span class="nv">jcmax_olap</span><span class="p">,</span> <span class="p">&amp;</span>
							   <span class="nv">kcmin_olap</span><span class="p">,</span><span class="nv">kcmax_olap</span><span class="p">,</span><span class="nv">error_abort</span>
    <span class="k">implicit none</span>
<span class="k"> </span>
<span class="k">	</span><span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">),</span> <span class="k">optional</span>						<span class="kd">::</span> <span class="nv">send_flag</span>
 	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">),</span> <span class="k">optional</span>						<span class="kd">::</span> <span class="nv">icmax_send</span><span class="p">,</span><span class="nv">icmin_send</span>
 	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">),</span> <span class="k">optional</span>						<span class="kd">::</span> <span class="nv">jcmax_send</span><span class="p">,</span><span class="nv">jcmin_send</span>
 	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">),</span> <span class="k">optional</span>						<span class="kd">::</span> <span class="nv">kcmax_send</span><span class="p">,</span><span class="nv">kcmin_send</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:,:,:,:),</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">asend</span>
    
    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">npercell</span>
	<span class="kt">integer</span>	<span class="kd">::</span> <span class="nv">icmin</span><span class="p">,</span><span class="nv">icmax</span><span class="p">,</span><span class="nv">jcmin</span><span class="p">,</span><span class="nv">jcmax</span><span class="p">,</span><span class="nv">kcmin</span><span class="p">,</span><span class="nv">kcmax</span>

	<span class="nv">npercell</span> <span class="o">=</span> <span class="nv">size</span><span class="p">(</span><span class="nv">asend</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
	<span class="c">!if ((present(icmax_send))) print*, &#39;icmax_send&#39;, icmax_send</span>
	<span class="c">!if ((present(icmin_send))) print*, &#39;icmin_send&#39;, icmin_send</span>
	<span class="c">!if ((present(jcmax_send))) print*, &#39;jcmax_send&#39;, jcmax_send</span>
	<span class="c">!if ((present(jcmin_send))) print*, &#39;jcmin_send&#39;, jcmin_send</span>
	<span class="c">!if ((present(kcmax_send))) print*, &#39;kcmax_send&#39;, kcmax_send</span>
	<span class="c">!if ((present(kcmin_send))) print*, &#39;kcmin_send&#39;, kcmin_send</span>

	<span class="c">!Revert to default i domain sending - top of overlap to bottom of overlap</span>
	<span class="k">if</span> <span class="p">((</span><span class="nb">present</span><span class="p">(</span><span class="nv">icmax_send</span><span class="p">))</span> <span class="ow">.and.</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">icmin_send</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">icmax</span> <span class="o">=</span> <span class="nv">icmax_send</span><span class="p">;</span>	<span class="nv">icmin</span> <span class="o">=</span> <span class="nv">icmin_send</span>
	<span class="nv">elseif</span> <span class="p">((</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">icmax_send</span><span class="p">))</span><span class="ow">.and.</span><span class="p">(</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">icmin_send</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">icmax</span> <span class="o">=</span> <span class="nv">icmax_olap</span><span class="p">;</span>	<span class="nv">icmin</span> <span class="o">=</span> <span class="nv">icmin_olap</span>
	<span class="k">else</span>
<span class="k">		call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_send error - both max and min i limits &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
						 <span class="s2">&quot;required and only one supplied&quot;</span><span class="p">)</span>
	<span class="k">endif</span>

	<span class="c">!Revert to default j domain sending - top of overlap to bottom of overlap</span>
	<span class="k">if</span> <span class="p">((</span><span class="nb">present</span><span class="p">(</span><span class="nv">jcmax_send</span><span class="p">))</span> <span class="ow">.and.</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">jcmin_send</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">jcmax</span> <span class="o">=</span> <span class="nv">jcmax_send</span><span class="p">;</span>	<span class="nv">jcmin</span> <span class="o">=</span> <span class="nv">jcmin_send</span>
	<span class="nv">elseif</span> <span class="p">((</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">jcmax_send</span><span class="p">))</span><span class="ow">.and.</span><span class="p">(</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">jcmin_send</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">jcmax</span> <span class="o">=</span> <span class="nv">jcmax_olap</span><span class="p">;</span>	<span class="nv">jcmin</span> <span class="o">=</span> <span class="nv">jcmin_olap</span>
	<span class="k">else</span>
<span class="k">		call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_send error - both max and min j limits &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
						 <span class="s2">&quot;required and only one supplied&quot;</span><span class="p">)</span>
	<span class="k">endif</span>

	<span class="c">!Revert to default k domain sending - top of overlap to bottom of overlap</span>
	<span class="k">if</span> <span class="p">((</span><span class="nb">present</span><span class="p">(</span><span class="nv">kcmax_send</span><span class="p">))</span> <span class="ow">.and.</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">kcmin_send</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">kcmax</span> <span class="o">=</span> <span class="nv">kcmax_send</span><span class="p">;</span> <span class="nv">kcmin</span> <span class="o">=</span> <span class="nv">kcmin_send</span>
	<span class="nv">elseif</span> <span class="p">((</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">kcmax_send</span><span class="p">))</span><span class="ow">.and.</span><span class="p">(</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">kcmin_send</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">kcmax</span> <span class="o">=</span> <span class="nv">kcmax_olap</span><span class="p">;</span>	<span class="nv">kcmin</span> <span class="o">=</span> <span class="nv">kcmin_olap</span>
	<span class="k">else</span>
<span class="k">		call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_send error - both max and min k limits &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
						 <span class="s2">&quot;required and only one supplied&quot;</span><span class="p">)</span>
	<span class="k">endif</span>

	<span class="c">!send_extents = (/npercell,icmax-icmin+1,jcmax-jcmin+1,kcmax-kcmin+1 /) </span>
	<span class="c">!if (any(shape(asend) .lt. send_extents)) then</span>
	<span class="c">!	print&#39;(2(a,4i5))&#39;, &#39;  Shape of input array = &#39;, shape(asend), &amp; </span>
	<span class="c">!					  &#39;  Passed range = &#39;,send_extents </span>
	<span class="c">!	call error_abort(&quot;CPL_send error - Specified send range is greater&quot; // &amp;</span>
	<span class="c">!					 &quot;than the number of cells on processor&quot;)</span>
	<span class="c">!endif</span>
 
    <span class="k">call </span><span class="nv">CPL_send_xd</span><span class="p">(</span><span class="nv">asend</span><span class="p">,</span><span class="nv">icmin</span><span class="p">,</span><span class="nv">icmax</span><span class="p">,</span><span class="nv">jcmin</span><span class="p">,</span> <span class="p">&amp;</span> 
						   <span class="nv">jcmax</span><span class="p">,</span><span class="nv">kcmin</span><span class="p">,</span><span class="nv">kcmax</span><span class="p">,</span><span class="nv">send_flag</span> <span class="p">)</span>

<span class="k">end subroutine </span><span class="nv">CPL_send_4d</span>

<span class="c">!=============================================================================</span>
<span class="c">!						CPL_send_xd</span>
<span class="c">!&gt;</span>
<span class="c">!! Send data from the local grid to the associated ranks from the other </span>
<span class="c">!! realm</span>
<span class="c">!!</span>
<span class="c">!! - Synopsis</span>
<span class="c">!!</span>
<span class="c">!!  - CPL_send_xd(asend,icmin_send,icmax_send,jcmin_send,  </span>
<span class="c">!!						     jcmax_send,kcmin_send,kcmax_send,send_flag)</span>
<span class="c">!!</span>
<span class="c">!! - Input Parameters</span>
<span class="c">!!</span>
<span class="c">!!   - asend</span>
<span class="c">!!</span>
<span class="c">!!   - icmin_send</span>
<span class="c">!!</span>
<span class="c">!!   - icmax_send</span>
<span class="c">!!</span>
<span class="c">!!   - jcmin_send</span>
<span class="c">!!</span>
<span class="c">!!   - jcmax_send</span>
<span class="c">!!</span>
<span class="c">!!   - kcmin_send</span>
<span class="c">!!</span>
<span class="c">!!   - kcmax_send</span>
<span class="c">!!</span>
<span class="c">!! - Output Parameter</span>
<span class="c">!!</span>
<span class="c">!!   - send_flag</span>
<span class="c">!!</span>
<span class="c">!! @author Edward Smith</span>
<span class="c">! ----------------------------------------------------------------------------</span>
<span class="k">subroutine </span><span class="nv">CPL_send_xd</span><span class="p">(</span><span class="nv">asend</span><span class="p">,</span><span class="nv">icmin_send</span><span class="p">,</span><span class="nv">icmax_send</span><span class="p">,</span><span class="nv">jcmin_send</span><span class="p">,</span> <span class="p">&amp;</span> 
						     <span class="nv">jcmax_send</span><span class="p">,</span><span class="nv">kcmin_send</span><span class="p">,</span><span class="nv">kcmax_send</span><span class="p">,</span><span class="nv">send_flag</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">mpi</span>
    <span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> <span class="nv">md_realm</span><span class="p">,</span><span class="nv">cfd_realm</span><span class="p">,</span> <span class="p">&amp;</span> 
	                           <span class="nv">error_abort</span><span class="p">,</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span><span class="nv">myid_graph</span><span class="p">,</span><span class="nv">olap_mask</span><span class="p">,</span> <span class="p">&amp;</span>
                               <span class="nv">rank_world</span><span class="p">,</span> <span class="nv">realm</span><span class="p">,</span> <span class="p">&amp;</span> 
							   <span class="nv">iblock_realm</span><span class="p">,</span><span class="nv">jblock_realm</span><span class="p">,</span><span class="nv">kblock_realm</span><span class="p">,</span><span class="nv">ierr</span><span class="p">,</span> <span class="nv">VOID</span>
	<span class="k">implicit none</span>

	<span class="c">!Flag set if processor has passed data</span>
	<span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">),</span> <span class="k">optional</span>	<span class="kd">::</span> <span class="nv">send_flag</span>

    <span class="c">! Minimum and maximum values to send</span>
 	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>	<span class="kd">::</span> <span class="nv">icmax_send</span><span class="p">,</span><span class="nv">icmin_send</span><span class="p">,</span> <span class="p">&amp;</span> 
						   <span class="nv">jcmax_send</span><span class="p">,</span><span class="nv">jcmin_send</span><span class="p">,</span> <span class="p">&amp;</span> 
						   <span class="nv">kcmax_send</span><span class="p">,</span><span class="nv">kcmin_send</span>

   <span class="c">! Array containing data distributed on the grid</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:,:,:,:),</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span><span class="kd">::</span> <span class="nv">asend</span>
   
	<span class="c">!Number of halos</span>
    <span class="c">!integer :: nh = 1 !?? todo needed?</span>

	<span class="c">!Neighbours</span>
	<span class="kt">integer</span>								<span class="kd">::</span> <span class="nv">nneighbors</span>   
	<span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span>	<span class="kd">::</span> <span class="nv">id_neighbors</span>

    <span class="c">! local indices </span>
	<span class="kt">integer</span>	<span class="kd">::</span> <span class="nv">icell</span><span class="p">,</span><span class="nv">jcell</span><span class="p">,</span><span class="nv">kcell</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">ix</span><span class="p">,</span><span class="nv">iy</span><span class="p">,</span><span class="nv">iz</span><span class="p">,</span><span class="nv">icmin</span><span class="p">,</span><span class="nv">icmax</span><span class="p">,</span><span class="nv">jcmin</span><span class="p">,</span><span class="nv">jcmax</span><span class="p">,</span><span class="nv">kcmin</span><span class="p">,</span><span class="nv">kcmax</span>
	<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">n</span><span class="p">,</span><span class="nv">pos</span><span class="p">,</span><span class="nv">iclmin</span><span class="p">,</span><span class="nv">iclmax</span><span class="p">,</span><span class="nv">jclmin</span><span class="p">,</span><span class="nv">jclmax</span><span class="p">,</span><span class="nv">kclmin</span><span class="p">,</span><span class="nv">kclmax</span>
	<span class="kt">integer</span>	<span class="kd">::</span> <span class="nv">npercell</span>

    <span class="c">! auxiliaries </span>
    <span class="kt">integer</span>								<span class="kd">::</span> <span class="nv">nbr</span><span class="p">,</span><span class="nv">ndata</span><span class="p">,</span><span class="nv">itag</span><span class="p">,</span><span class="nv">destid</span><span class="p">,</span><span class="nv">ncells</span>
    <span class="kt">integer</span>                             <span class="kd">::</span> <span class="nv">pcoords</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
	<span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>				<span class="kd">::</span> <span class="nv">extents</span><span class="p">,</span><span class="nv">limits</span><span class="p">,</span><span class="nv">portion</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">allocatable</span> 	<span class="kd">::</span> <span class="nv">vbuf</span><span class="p">(:)</span>

	<span class="c">! This local CFD domain is outside MD overlap zone </span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">olap_mask</span><span class="p">(</span><span class="nv">rank_world</span><span class="p">)</span> <span class="ow">.eqv.</span> <span class="nb">.false.</span><span class="p">)</span> <span class="k">return</span>

	<span class="c">! Save limits array of Minimum and maximum values to send</span>
	<span class="nv">limits</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="nv">icmin_send</span><span class="p">,</span><span class="nv">icmax_send</span><span class="p">,</span><span class="nv">jcmin_send</span><span class="p">,</span><span class="nv">jcmax_send</span><span class="p">,</span><span class="nv">kcmin_send</span><span class="p">,</span><span class="nv">kcmax_send</span> <span class="o">/</span><span class="p">)</span>

    <span class="c">! Get local grid box ranges seen by this rank for CFD</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">cfd_realm</span><span class="p">)</span> <span class="k">then</span> 
		<span class="c">!Load extents of CFD processor</span>
		<span class="nv">pcoords</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="nv">iblock_realm</span><span class="p">,</span><span class="nv">jblock_realm</span><span class="p">,</span><span class="nv">kblock_realm</span> <span class="o">/</span><span class="p">)</span>
		<span class="k">call </span><span class="nv">CPL_proc_extents</span><span class="p">(</span><span class="nv">pcoords</span><span class="p">,</span><span class="nv">cfd_realm</span><span class="p">,</span><span class="nv">extents</span><span class="p">)</span>
	<span class="k">endif</span>

    <span class="c">! Number of components at each grid point</span>
    <span class="nv">npercell</span> <span class="o">=</span> <span class="nv">size</span><span class="p">(</span><span class="nv">asend</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

	<span class="c">!Get neighbours</span>
	<span class="k">call </span><span class="nv">MPI_Graph_neighbors_count</span><span class="p">(</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span><span class="nv">myid_graph</span><span class="p">,</span><span class="nv">nneighbors</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
	<span class="k">allocate</span><span class="p">(</span><span class="nv">id_neighbors</span><span class="p">(</span><span class="nv">nneighbors</span><span class="p">))</span>
	<span class="k">call </span><span class="nv">MPI_Graph_neighbors</span><span class="p">(</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span><span class="nv">myid_graph</span><span class="p">,</span><span class="nv">nneighbors</span><span class="p">,</span><span class="nv">id_neighbors</span><span class="p">,</span><span class="nv">ierr</span> <span class="p">)</span>

	<span class="c">!Set sendflag to false and only change if anything is sent</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">send_flag</span><span class="p">))</span> <span class="nv">send_flag</span> <span class="o">=</span> <span class="nb">.false.</span>
  
    <span class="c">! loop through the maps and send the corresponding sections of asend</span>
    <span class="k">do </span><span class="nv">nbr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">nneighbors</span>

		<span class="c">!Get taget processor from mapping</span>
        <span class="nv">destid</span> <span class="o">=</span> <span class="nv">id_neighbors</span><span class="p">(</span><span class="nv">nbr</span><span class="p">)</span>

		<span class="c">! ----------------- pack data for destid-----------------------------</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">cfd_realm</span><span class="p">)</span> <span class="k">then</span>
			<span class="c">!Get extents of nbr MD processor to send to</span>
			<span class="k">call </span><span class="nv">CPL_Cart_coords</span><span class="p">(</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span> <span class="nv">destid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>  <span class="nv">md_realm</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nv">pcoords</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span> 
		<span class="nv">elseif</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">md_realm</span><span class="p">)</span> <span class="k">then</span>
			<span class="c">!Data to send is based on current processor as MD proc size &lt; CFD proc size</span>
			<span class="nv">pcoords</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="nv">iblock_realm</span><span class="p">,</span><span class="nv">jblock_realm</span><span class="p">,</span><span class="nv">kblock_realm</span> <span class="o">/</span><span class="p">)</span>
			<span class="c">!Get extents of current processor</span>
			<span class="k">call </span><span class="nv">CPL_proc_extents</span><span class="p">(</span><span class="nv">pcoords</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="nv">extents</span><span class="p">)</span>
		<span class="k">endif</span>

		<span class="c">! If limits passed to send routine, use these instead</span>
		<span class="c">! of overlap/processor limits</span>
		<span class="k">call </span><span class="nv">CPL_proc_portion</span><span class="p">(</span><span class="nv">pcoords</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="nv">limits</span><span class="p">,</span><span class="nv">portion</span><span class="p">,</span><span class="nv">ncells</span><span class="p">)</span>

        <span class="c">! Amount of data to be sent</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="nv">portion</span><span class="ow">.eq.</span><span class="nv">VOID</span><span class="p">))</span> <span class="k">then</span>
			<span class="c">!print*, &#39;VOID send qqqq&#39;,realm_name(realm),rank_world,rank_realm</span>
			<span class="nv">ndata</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">else</span>

			<span class="c">! Get data range on processor&#39;s local extents</span>
			<span class="nv">iclmin</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="nv">extents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>	<span class="nv">iclmax</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="nv">extents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
			<span class="nv">jclmin</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="nv">extents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>	<span class="nv">jclmax</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="nv">extents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
			<span class="nv">kclmin</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">-</span><span class="nv">extents</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>	<span class="nv">kclmax</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">-</span><span class="nv">extents</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>

	        <span class="nv">ndata</span> <span class="o">=</span> <span class="nv">npercell</span> <span class="o">*</span> <span class="nv">ncells</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">vbuf</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="nv">vbuf</span><span class="p">);</span> <span class="k">allocate</span><span class="p">(</span><span class="nv">vbuf</span><span class="p">(</span><span class="nv">ndata</span><span class="p">))</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">send_flag</span><span class="p">))</span> <span class="nv">send_flag</span> <span class="o">=</span> <span class="nb">.true.</span>
			<span class="c">! Pack array into buffer</span>
			<span class="nv">pos</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="c">!print&#39;(a,5i4,2i6,i4,24i4)&#39;, &#39;send qqqq&#39;,rank_world,rank_realm,rank_olap,ndata,nbr,destid, &amp; </span>
			<span class="c">!						size(asend),pos,&amp;</span>
			<span class="c">!						iclmin,   iclmax,   jclmin,   jclmax,   kclmin,   kclmax,     &amp;</span>
			<span class="c">!						icmin_send,icmax_send,jcmin_send,jcmax_send,kcmin_send,kcmax_send, &amp; </span>
			<span class="c">!						portion, extents</span>
			<span class="k">do </span><span class="nv">kcell</span><span class="o">=</span><span class="nv">kclmin</span><span class="p">,</span><span class="nv">kclmax</span>
			<span class="k">do </span><span class="nv">jcell</span><span class="o">=</span><span class="nv">jclmin</span><span class="p">,</span><span class="nv">jclmax</span>
			<span class="k">do </span><span class="nv">icell</span><span class="o">=</span><span class="nv">iclmin</span><span class="p">,</span><span class="nv">iclmax</span>
			<span class="k">do </span><span class="nv">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">npercell</span>
				<span class="nv">vbuf</span><span class="p">(</span><span class="nv">pos</span><span class="p">)</span> <span class="o">=</span> <span class="nv">asend</span><span class="p">(</span><span class="nv">n</span><span class="p">,</span><span class="nv">icell</span><span class="p">,</span><span class="nv">jcell</span><span class="p">,</span><span class="nv">kcell</span><span class="p">)</span>
				<span class="c">!write(98000+destid+1+10*rank_world,&#39;(3i8,f20.5)&#39;) rank_world,destid+1,n, vbuf(pos)</span>
				<span class="nv">pos</span> <span class="o">=</span> <span class="nv">pos</span> <span class="o">+</span> <span class="mi">1</span>
			<span class="k">end do</span>
<span class="k">			end do</span>
<span class="k">			end do</span>
<span class="k">			end do</span>
			<span class="c">! ----------------- pack data for destid -----------------------------</span>

 			<span class="c">! Send data </span>
	        <span class="nv">itag</span> <span class="o">=</span> <span class="mi">0</span> <span class="c">!mod( ncalls, MPI_TAG_UB) !Attention ncall could go over max tag value for long runs!!</span>
			<span class="k">call </span><span class="nv">MPI_send</span><span class="p">(</span><span class="nv">vbuf</span><span class="p">,</span> <span class="nv">ndata</span><span class="p">,</span> <span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="nv">destid</span><span class="p">,</span> <span class="nv">itag</span><span class="p">,</span> <span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

		<span class="k">endif</span>

<span class="k">    </span><span class="nv">enddo</span>

<span class="k">end subroutine </span><span class="nv">CPL_send_xd</span>

<span class="c">!=============================================================================</span>
<span class="c">!&gt;</span>
<span class="c">!! CPL_recv_xd wrapper for 3d arrays</span>
<span class="c">!! see CPL_recv_xd for input description</span>
<span class="c">!! @see coupler#subroutine_CPL_recv_xd</span>
<span class="c">!-----------------------------------------------------------------------------</span>
<span class="k">subroutine </span><span class="nv">CPL_recv_3d</span><span class="p">(</span><span class="nv">temp</span><span class="p">,</span><span class="nv">icmin_recv</span><span class="p">,</span><span class="nv">icmax_recv</span><span class="p">,</span><span class="nv">jcmin_recv</span><span class="p">,</span> <span class="p">&amp;</span> 
							<span class="nv">jcmax_recv</span><span class="p">,</span><span class="nv">kcmin_recv</span><span class="p">,</span><span class="nv">kcmax_recv</span><span class="p">,</span><span class="nv">recv_flag</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> <span class="nv">icmin_olap</span><span class="p">,</span><span class="nv">icmax_olap</span><span class="p">,</span> <span class="p">&amp;</span> 
							   <span class="nv">jcmin_olap</span><span class="p">,</span><span class="nv">jcmax_olap</span><span class="p">,</span> <span class="p">&amp;</span>
							   <span class="nv">kcmin_olap</span><span class="p">,</span><span class="nv">kcmax_olap</span><span class="p">,</span><span class="nv">error_abort</span>
    <span class="k">implicit none</span>

<span class="k">	</span><span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">),</span> <span class="k">optional</span>					<span class="kd">::</span> <span class="nv">recv_flag</span>
  	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">),</span> <span class="k">optional</span>					<span class="kd">::</span> <span class="nv">icmax_recv</span><span class="p">,</span><span class="nv">icmin_recv</span>
 	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">),</span> <span class="k">optional</span>					<span class="kd">::</span> <span class="nv">jcmax_recv</span><span class="p">,</span><span class="nv">jcmin_recv</span>
 	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">),</span> <span class="k">optional</span>					<span class="kd">::</span> <span class="nv">kcmax_recv</span><span class="p">,</span><span class="nv">kcmin_recv</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:,:,:),</span><span class="k">intent</span><span class="p">(</span><span class="nv">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">temp</span> 
                                                          
    <span class="kt">integer</span>	<span class="kd">::</span> <span class="nv">n1</span><span class="p">,</span><span class="nv">n2</span><span class="p">,</span><span class="nv">n3</span><span class="p">,</span><span class="nv">n4</span>
	<span class="kt">integer</span>	<span class="kd">::</span> <span class="nv">icmin</span><span class="p">,</span><span class="nv">icmax</span><span class="p">,</span><span class="nv">jcmin</span><span class="p">,</span><span class="nv">jcmax</span><span class="p">,</span><span class="nv">kcmin</span><span class="p">,</span><span class="nv">kcmax</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:,:,:,:),</span><span class="k">allocatable</span>	 <span class="kd">::</span> <span class="nv">arecv</span>

	<span class="c">!if ((present(icmax_recv))) print*, &#39;icmax_recv&#39;, icmax_recv</span>
	<span class="c">!if ((present(icmin_recv))) print*, &#39;icmin_recv&#39;, icmin_recv</span>
	<span class="c">!if ((present(jcmax_recv))) print*, &#39;jcmax_recv&#39;, jcmax_recv</span>
	<span class="c">!if ((present(jcmin_recv))) print*, &#39;jcmin_recv&#39;, jcmin_recv</span>
	<span class="c">!if ((present(kcmax_recv))) print*, &#39;kcmax_recv&#39;, kcmax_recv</span>
	<span class="c">!if ((present(kcmin_recv))) print*, &#39;kcmin_recv&#39;, kcmin_recv</span>

	<span class="c">!Revert to default i domain sending - top of overlap to bottom of overlap</span>
	<span class="k">if</span> <span class="p">((</span><span class="nb">present</span><span class="p">(</span><span class="nv">icmax_recv</span><span class="p">))</span> <span class="ow">.and.</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">icmin_recv</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">icmax</span> <span class="o">=</span> <span class="nv">icmax_recv</span><span class="p">;</span>	<span class="nv">icmin</span> <span class="o">=</span> <span class="nv">icmin_recv</span>
	<span class="nv">elseif</span> <span class="p">((</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">icmax_recv</span><span class="p">))</span><span class="ow">.and.</span><span class="p">(</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">icmin_recv</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">icmax</span> <span class="o">=</span> <span class="nv">icmax_olap</span><span class="p">;</span>	<span class="nv">icmin</span> <span class="o">=</span> <span class="nv">icmin_olap</span>
	<span class="k">else</span>
<span class="k">		call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_recv error - both max and min i limits &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
						 <span class="s2">&quot;required and only one supplied&quot;</span><span class="p">)</span>
	<span class="k">endif</span>

	<span class="c">!Revert to default j domain sending - top of overlap to bottom of overlap</span>
	<span class="k">if</span> <span class="p">((</span><span class="nb">present</span><span class="p">(</span><span class="nv">jcmax_recv</span><span class="p">))</span> <span class="ow">.and.</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">jcmin_recv</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">jcmax</span> <span class="o">=</span> <span class="nv">jcmax_recv</span><span class="p">;</span>	<span class="nv">jcmin</span> <span class="o">=</span> <span class="nv">jcmin_recv</span>
	<span class="nv">elseif</span> <span class="p">((</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">jcmax_recv</span><span class="p">))</span><span class="ow">.and.</span><span class="p">(</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">jcmin_recv</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">jcmax</span> <span class="o">=</span> <span class="nv">jcmax_olap</span><span class="p">;</span>	<span class="nv">jcmin</span> <span class="o">=</span> <span class="nv">jcmin_olap</span>
	<span class="k">else</span>
<span class="k">		call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_recv error - both max and min j limits &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
						 <span class="s2">&quot;required and only one supplied&quot;</span><span class="p">)</span>
	<span class="k">endif</span>

	<span class="c">!Revert to default k domain sending - top of overlap to bottom of overlap</span>
	<span class="k">if</span> <span class="p">((</span><span class="nb">present</span><span class="p">(</span><span class="nv">kcmax_recv</span><span class="p">))</span> <span class="ow">.and.</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">kcmin_recv</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">kcmax</span> <span class="o">=</span> <span class="nv">kcmax_recv</span><span class="p">;</span> <span class="nv">kcmin</span> <span class="o">=</span> <span class="nv">kcmin_recv</span>
	<span class="nv">elseif</span> <span class="p">((</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">kcmax_recv</span><span class="p">))</span><span class="ow">.and.</span><span class="p">(</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">kcmin_recv</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">kcmax</span> <span class="o">=</span> <span class="nv">kcmax_olap</span><span class="p">;</span>	<span class="nv">kcmin</span> <span class="o">=</span> <span class="nv">kcmin_olap</span>
	<span class="k">else</span>
<span class="k">		call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_recv error - both max and min k limits &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
						 <span class="s2">&quot;required and only one supplied&quot;</span><span class="p">)</span>
	<span class="k">endif</span>
<span class="k"> </span>
<span class="k">    </span><span class="nv">n1</span> <span class="o">=</span> <span class="mi">1</span> 
    <span class="nv">n2</span> <span class="o">=</span> <span class="nv">size</span><span class="p">(</span><span class="nv">temp</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="nv">n3</span> <span class="o">=</span> <span class="nv">size</span><span class="p">(</span><span class="nv">temp</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="nv">n4</span> <span class="o">=</span> <span class="nv">size</span><span class="p">(</span><span class="nv">temp</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

	<span class="c">!Add padding column to 3D array to make it 4D</span>
	<span class="k">allocate</span><span class="p">(</span><span class="nv">arecv</span><span class="p">(</span><span class="nv">n1</span><span class="p">,</span><span class="nv">n2</span><span class="p">,</span><span class="nv">n3</span><span class="p">,</span><span class="nv">n4</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">CPL_recv_xd</span><span class="p">(</span><span class="nv">arecv</span><span class="p">,</span><span class="nv">icmin</span><span class="p">,</span><span class="nv">icmax</span><span class="p">,</span><span class="nv">jcmin</span><span class="p">,</span> <span class="p">&amp;</span> 
						   <span class="nv">jcmax</span><span class="p">,</span><span class="nv">kcmin</span><span class="p">,</span><span class="nv">kcmax</span><span class="p">,</span><span class="nv">recv_flag</span><span class="p">)</span>
	<span class="nv">temp</span><span class="p">(:,:,:)</span> <span class="o">=</span> 	<span class="nv">arecv</span><span class="p">(</span><span class="mi">1</span><span class="p">,:,:,:)</span> 

<span class="k">end subroutine </span><span class="nv">CPL_recv_3d</span>

<span class="c">!=============================================================================</span>
<span class="c">!&gt;</span>
<span class="c">!! CPL_recv_xd  wrapper for 4d arrays</span>
<span class="c">!! See CPL_recv_xd for input description</span>
<span class="c">!! @see coupler#subroutine_CPL_recv_xd</span>
<span class="c">!-----------------------------------------------------------------------------</span>
<span class="k">subroutine </span><span class="nv">CPL_recv_4d</span><span class="p">(</span><span class="nv">arecv</span><span class="p">,</span><span class="nv">icmin_recv</span><span class="p">,</span><span class="nv">icmax_recv</span><span class="p">,</span><span class="nv">jcmin_recv</span><span class="p">,</span> <span class="p">&amp;</span> 
							 <span class="nv">jcmax_recv</span><span class="p">,</span><span class="nv">kcmin_recv</span><span class="p">,</span><span class="nv">kcmax_recv</span><span class="p">,</span><span class="nv">recv_flag</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> <span class="nv">icmin_olap</span><span class="p">,</span><span class="nv">icmax_olap</span><span class="p">,</span> <span class="p">&amp;</span> 
							   <span class="nv">jcmin_olap</span><span class="p">,</span><span class="nv">jcmax_olap</span><span class="p">,</span> <span class="p">&amp;</span>
							   <span class="nv">kcmin_olap</span><span class="p">,</span><span class="nv">kcmax_olap</span><span class="p">,</span><span class="nv">error_abort</span>
    <span class="k">implicit none</span>
<span class="k"> </span>
<span class="k">	</span><span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">),</span> <span class="k">optional</span>						  <span class="kd">::</span> <span class="nv">recv_flag</span>
 	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">),</span> <span class="k">optional</span>						  <span class="kd">::</span> <span class="nv">icmax_recv</span><span class="p">,</span><span class="nv">icmin_recv</span>
 	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">),</span> <span class="k">optional</span>						  <span class="kd">::</span> <span class="nv">jcmax_recv</span><span class="p">,</span><span class="nv">jcmin_recv</span>
 	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">),</span> <span class="k">optional</span>						  <span class="kd">::</span> <span class="nv">kcmax_recv</span><span class="p">,</span><span class="nv">kcmin_recv</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:,:,:,:),</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">arecv</span>
    
    <span class="kt">integer</span>	<span class="kd">::</span> <span class="nv">n1</span><span class="p">,</span><span class="nv">n2</span><span class="p">,</span><span class="nv">n3</span><span class="p">,</span><span class="nv">n4</span>
	<span class="kt">integer</span>	<span class="kd">::</span> <span class="nv">icmin</span><span class="p">,</span><span class="nv">icmax</span><span class="p">,</span><span class="nv">jcmin</span><span class="p">,</span><span class="nv">jcmax</span><span class="p">,</span><span class="nv">kcmin</span><span class="p">,</span><span class="nv">kcmax</span>

	<span class="c">!if ((present(icmax_recv))) print*, &#39;icmax_recv&#39;, icmax_recv</span>
	<span class="c">!if ((present(icmin_recv))) print*, &#39;icmin_recv&#39;, icmin_recv</span>
	<span class="c">!if ((present(jcmax_recv))) print*, &#39;jcmax_recv&#39;, jcmax_recv</span>
	<span class="c">!if ((present(jcmin_recv))) print*, &#39;jcmin_recv&#39;, jcmin_recv</span>
	<span class="c">!if ((present(kcmax_recv))) print*, &#39;kcmax_recv&#39;, kcmax_recv</span>
	<span class="c">!if ((present(kcmin_recv))) print*, &#39;kcmin_recv&#39;, kcmin_recv</span>

	<span class="c">!Revert to default i domain sending - top of overlap to bottom of overlap</span>
	<span class="k">if</span> <span class="p">((</span><span class="nb">present</span><span class="p">(</span><span class="nv">icmax_recv</span><span class="p">))</span> <span class="ow">.and.</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">icmin_recv</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">icmax</span> <span class="o">=</span> <span class="nv">icmax_recv</span><span class="p">;</span>	<span class="nv">icmin</span> <span class="o">=</span> <span class="nv">icmin_recv</span>
	<span class="nv">elseif</span> <span class="p">((</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">icmax_recv</span><span class="p">))</span><span class="ow">.and.</span><span class="p">(</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">icmin_recv</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">icmax</span> <span class="o">=</span> <span class="nv">icmax_olap</span><span class="p">;</span>	<span class="nv">icmin</span> <span class="o">=</span> <span class="nv">icmin_olap</span>
	<span class="k">else</span>
<span class="k">		call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_recv error - both max and min i limits &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
						 <span class="s2">&quot;required and only one supplied&quot;</span><span class="p">)</span>
	<span class="k">endif</span>

	<span class="c">!Revert to default j domain sending - top of overlap to bottom of overlap</span>
	<span class="k">if</span> <span class="p">((</span><span class="nb">present</span><span class="p">(</span><span class="nv">jcmax_recv</span><span class="p">))</span> <span class="ow">.and.</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">jcmin_recv</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">jcmax</span> <span class="o">=</span> <span class="nv">jcmax_recv</span><span class="p">;</span>	<span class="nv">jcmin</span> <span class="o">=</span> <span class="nv">jcmin_recv</span>
	<span class="nv">elseif</span> <span class="p">((</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">jcmax_recv</span><span class="p">))</span><span class="ow">.and.</span><span class="p">(</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">jcmin_recv</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">jcmax</span> <span class="o">=</span> <span class="nv">jcmax_olap</span><span class="p">;</span>	<span class="nv">jcmin</span> <span class="o">=</span> <span class="nv">jcmin_olap</span>
	<span class="k">else</span>
<span class="k">		call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_recv error - both max and min j limits &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
						 <span class="s2">&quot;required and only one supplied&quot;</span><span class="p">)</span>
	<span class="k">endif</span>

	<span class="c">!Revert to default k domain sending - top of overlap to bottom of overlap</span>
	<span class="k">if</span> <span class="p">((</span><span class="nb">present</span><span class="p">(</span><span class="nv">kcmax_recv</span><span class="p">))</span> <span class="ow">.and.</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">kcmin_recv</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">kcmax</span> <span class="o">=</span> <span class="nv">kcmax_recv</span><span class="p">;</span> <span class="nv">kcmin</span> <span class="o">=</span> <span class="nv">kcmin_recv</span>
	<span class="nv">elseif</span> <span class="p">((</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">kcmax_recv</span><span class="p">))</span><span class="ow">.and.</span><span class="p">(</span><span class="ow">.not.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">kcmin_recv</span><span class="p">)))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">kcmax</span> <span class="o">=</span> <span class="nv">kcmax_olap</span><span class="p">;</span>	<span class="nv">kcmin</span> <span class="o">=</span> <span class="nv">kcmin_olap</span>
	<span class="k">else</span>
<span class="k">		call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_recv error - both max and min k limits &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
						 <span class="s2">&quot;required and only one supplied&quot;</span><span class="p">)</span>
	<span class="k">endif</span>
<span class="k"> </span>
<span class="k">    call </span><span class="nv">CPL_recv_xd</span><span class="p">(</span><span class="nv">arecv</span><span class="p">,</span><span class="nv">icmin</span><span class="p">,</span><span class="nv">icmax</span><span class="p">,</span><span class="nv">jcmin</span><span class="p">,</span> <span class="p">&amp;</span> 
						   <span class="nv">jcmax</span><span class="p">,</span><span class="nv">kcmin</span><span class="p">,</span><span class="nv">kcmax</span><span class="p">,</span><span class="nv">recv_flag</span><span class="p">)</span>

<span class="k">end subroutine </span><span class="nv">CPL_recv_4d</span>


<span class="c">!=============================================================================</span>
<span class="c">!						CPL_recv_xd</span>
<span class="c">!&gt;</span>
<span class="c">!! Receive data from to local grid from the associated ranks from the other </span>
<span class="c">!! realm</span>
<span class="c">!!</span>
<span class="c">!! - Synopsis</span>
<span class="c">!!</span>
<span class="c">!!  - CPL_recv_xd(arecv,icmin_recv,icmax_recv,jcmin_recv,  </span>
<span class="c">!!						     jcmax_recv,kcmin_recv,kcmax_recv,recv_flag)</span>
<span class="c">!!</span>
<span class="c">!! - Input Parameters</span>
<span class="c">!!</span>
<span class="c">!!   - arecv</span>
<span class="c">!!</span>
<span class="c">!!   - icmin_recv</span>
<span class="c">!!</span>
<span class="c">!!   - icmax_recv</span>
<span class="c">!!</span>
<span class="c">!!   - jcmin_recv</span>
<span class="c">!!</span>
<span class="c">!!   - jcmax_recv</span>
<span class="c">!!</span>
<span class="c">!!   - kcmin_recv</span>
<span class="c">!!</span>
<span class="c">!!   - kcmax_recv</span>
<span class="c">!!</span>
<span class="c">!! - Output Parameter</span>
<span class="c">!!</span>
<span class="c">!!   - recv_flag</span>
<span class="c">!!</span>
<span class="c">!! @author Edward Smith</span>
<span class="c">! ----------------------------------------------------------------------------</span>
<span class="c">!-----------------------------------------------------------------------------</span>
<span class="k">subroutine </span><span class="nv">CPL_recv_xd</span><span class="p">(</span><span class="nv">arecv</span><span class="p">,</span><span class="nv">icmin_recv</span><span class="p">,</span><span class="nv">icmax_recv</span><span class="p">,</span><span class="nv">jcmin_recv</span><span class="p">,</span> <span class="p">&amp;</span> 
						     <span class="nv">jcmax_recv</span><span class="p">,</span><span class="nv">kcmin_recv</span><span class="p">,</span><span class="nv">kcmax_recv</span><span class="p">,</span><span class="nv">recv_flag</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">mpi</span>
    <span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> <span class="nv">md_realm</span><span class="p">,</span><span class="nv">cfd_realm</span><span class="p">,</span> <span class="p">&amp;</span> 
                               <span class="nv">rank_graph</span><span class="p">,</span> <span class="p">&amp;</span>
	                           <span class="nv">error_abort</span><span class="p">,</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span><span class="nv">myid_graph</span><span class="p">,</span><span class="nv">olap_mask</span><span class="p">,</span> <span class="p">&amp;</span>
                               <span class="nv">rank_world</span><span class="p">,</span> <span class="nv">realm</span><span class="p">,</span> <span class="p">&amp;</span> 
							   <span class="nv">iblock_realm</span><span class="p">,</span><span class="nv">jblock_realm</span><span class="p">,</span><span class="nv">kblock_realm</span><span class="p">,</span><span class="nv">VOID</span><span class="p">,</span><span class="nv">ierr</span>
	<span class="k">implicit none</span>

	<span class="c">!Flag set if processor has received data</span>
	<span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">),</span> <span class="k">optional</span>					<span class="kd">::</span> <span class="nv">recv_flag</span>

    <span class="c">! Minimum and maximum values of j to send</span>
 	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>	<span class="kd">::</span> <span class="nv">icmax_recv</span><span class="p">,</span><span class="nv">icmin_recv</span><span class="p">,</span> <span class="p">&amp;</span> 
						   <span class="nv">jcmax_recv</span><span class="p">,</span><span class="nv">jcmin_recv</span><span class="p">,</span> <span class="p">&amp;</span> 
						   <span class="nv">kcmax_recv</span><span class="p">,</span><span class="nv">kcmin_recv</span>

    <span class="c">! Array that recieves grid distributed data </span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">dimension</span><span class="p">(:,:,:,:),</span><span class="k">intent</span><span class="p">(</span><span class="nv">inout</span><span class="p">)</span><span class="kd">::</span> <span class="nv">arecv</span>     

	<span class="c">!Neighbours</span>
	<span class="kt">integer</span>								<span class="kd">::</span> <span class="nv">nneighbors</span>   
	<span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span>	<span class="kd">::</span> <span class="nv">id_neighbors</span>
                                                         
    <span class="c">! local indices </span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">n</span><span class="p">,</span><span class="nv">nbr</span><span class="p">,</span><span class="nv">icell</span><span class="p">,</span><span class="nv">jcell</span><span class="p">,</span><span class="nv">kcell</span>
	<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">pos</span><span class="p">,</span><span class="nv">iclmin</span><span class="p">,</span><span class="nv">iclmax</span><span class="p">,</span><span class="nv">jclmin</span><span class="p">,</span><span class="nv">jclmax</span><span class="p">,</span><span class="nv">kclmin</span><span class="p">,</span><span class="nv">kclmax</span>
	<span class="kt">integer</span>	<span class="kd">::</span> <span class="nv">pcoords</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="nv">npercell</span><span class="p">,</span><span class="nv">ndata</span><span class="p">,</span><span class="nv">ncells</span>
    <span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">extents</span><span class="p">,</span><span class="nv">portion</span><span class="p">,</span><span class="nv">limits</span>

    <span class="c">! auxiliaries </span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">itag</span><span class="p">,</span> <span class="nv">sourceid</span><span class="p">,</span><span class="nv">start_address</span>
	<span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span>   <span class="kd">::</span> <span class="nv">req</span>
	<span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(:,:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="nv">status</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span>  <span class="nv">vbuf</span>
 
	<span class="c">! This local CFD domain is outside MD overlap zone </span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">olap_mask</span><span class="p">(</span><span class="nv">rank_world</span><span class="p">)</span><span class="ow">.eqv.</span> <span class="nb">.false.</span><span class="p">)</span> <span class="k">return</span>

	<span class="c">! Save limits array of Minimum and maximum values to recv</span>
	<span class="nv">limits</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="nv">icmin_recv</span><span class="p">,</span><span class="nv">icmax_recv</span><span class="p">,</span><span class="nv">jcmin_recv</span><span class="p">,</span><span class="nv">jcmax_recv</span><span class="p">,</span><span class="nv">kcmin_recv</span><span class="p">,</span><span class="nv">kcmax_recv</span> <span class="o">/</span><span class="p">)</span>

    <span class="c">! Number of components at each grid point</span>
	<span class="nv">npercell</span> <span class="o">=</span> <span class="nv">size</span><span class="p">(</span><span class="nv">arecv</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="c">! Get local grid box ranges seen by this rank for CFD and allocate buffer</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">cfd_realm</span><span class="p">)</span> <span class="k">then</span> 

		<span class="c">!Load CFD cells per processor</span>
		<span class="k">call </span><span class="nv">CPL_Cart_coords</span><span class="p">(</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span> <span class="nv">rank_graph</span><span class="p">,</span> <span class="nv">cfd_realm</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nv">pcoords</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span> 
		<span class="k">call </span><span class="nv">CPL_proc_extents</span><span class="p">(</span><span class="nv">pcoords</span><span class="p">,</span><span class="nv">cfd_realm</span><span class="p">,</span><span class="nv">extents</span><span class="p">)</span>

		<span class="c">! If limits passed to recv routine, use these instead</span>
		<span class="c">! of overlap/processor limits</span>
		<span class="k">call </span><span class="nv">CPL_proc_portion</span><span class="p">(</span><span class="nv">pcoords</span><span class="p">,</span><span class="nv">cfd_realm</span><span class="p">,</span><span class="nv">limits</span><span class="p">,</span><span class="nv">portion</span><span class="p">,</span><span class="nv">ncells</span><span class="p">)</span>

		<span class="c">! Amount of data to receive from all MD processors</span>
		<span class="nv">ndata</span> <span class="o">=</span> <span class="nv">npercell</span> <span class="o">*</span> <span class="nv">ncells</span>
		<span class="k">allocate</span><span class="p">(</span><span class="nv">vbuf</span><span class="p">(</span><span class="nv">ndata</span><span class="p">));</span> <span class="nv">vbuf</span> <span class="o">=</span> <span class="mf">0.</span><span class="nv">d0</span>

	<span class="k">endif</span>

	<span class="c">!Get neighbours</span>
	<span class="k">call </span><span class="nv">MPI_Graph_neighbors_count</span><span class="p">(</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span><span class="nv">myid_graph</span><span class="p">,</span><span class="nv">nneighbors</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
	<span class="k">allocate</span><span class="p">(</span><span class="nv">id_neighbors</span><span class="p">(</span><span class="nv">nneighbors</span><span class="p">))</span>
	<span class="k">call </span><span class="nv">MPI_Graph_neighbors</span><span class="p">(</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span><span class="nv">myid_graph</span><span class="p">,</span><span class="nv">nneighbors</span><span class="p">,</span><span class="nv">id_neighbors</span><span class="p">,</span><span class="nv">ierr</span> <span class="p">)</span>

    <span class="c">! Receive from all attached processors</span>
	<span class="k">allocate</span><span class="p">(</span><span class="nv">req</span><span class="p">(</span><span class="nv">nneighbors</span><span class="p">))</span>
	<span class="k">allocate</span><span class="p">(</span><span class="nv">status</span><span class="p">(</span><span class="nv">MPI_STATUS_SIZE</span><span class="p">,</span><span class="nv">nneighbors</span><span class="p">))</span>
    <span class="nv">start_address</span> <span class="o">=</span> <span class="mi">1</span> 
    <span class="k">do </span><span class="nv">nbr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">nneighbors</span>

		<span class="c">!Get source processor from topology graph</span>
        <span class="nv">sourceid</span> <span class="o">=</span>  <span class="nv">id_neighbors</span><span class="p">(</span><span class="nv">nbr</span><span class="p">)</span>

	    <span class="c">! Get size of data to receive from source processors</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">cfd_realm</span><span class="p">)</span> <span class="k">then</span>
			<span class="c">!CFD realm receives data based on size of MD processor domain</span>
			<span class="k">call </span><span class="nv">CPL_Cart_coords</span><span class="p">(</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span> <span class="nv">sourceid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nv">md_realm</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nv">pcoords</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span> 
		<span class="nv">elseif</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">md_realm</span><span class="p">)</span> <span class="k">then</span>
			<span class="c">!MD realm receives data as big as own processor domain</span>
			<span class="nv">pcoords</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="nv">iblock_realm</span><span class="p">,</span><span class="nv">jblock_realm</span><span class="p">,</span><span class="nv">kblock_realm</span> <span class="o">/</span><span class="p">)</span>
		<span class="k">endif</span>

		<span class="c">! If limits passed to recv routine, use these instead</span>
		<span class="c">! of overlap/processor limits</span>
		<span class="k">call </span><span class="nv">CPL_proc_portion</span><span class="p">(</span><span class="nv">pcoords</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="nv">limits</span><span class="p">,</span><span class="nv">portion</span><span class="p">,</span><span class="nv">ncells</span><span class="p">)</span>

		<span class="c">!Only receive if overlapping</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="nv">portion</span><span class="ow">.eq.</span><span class="nv">VOID</span><span class="p">))</span> <span class="k">then</span>
<span class="k">			</span><span class="nv">ndata</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="nv">req</span><span class="p">(</span><span class="nv">nbr</span><span class="p">)</span> <span class="o">=</span> <span class="nv">MPI_REQUEST_NULL</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">recv_flag</span><span class="p">))</span> <span class="nv">recv_flag</span> <span class="o">=</span> <span class="nb">.false.</span>
		<span class="k">else</span>
			<span class="c">! Amount of data to receive</span>
	        <span class="nv">ndata</span> <span class="o">=</span> <span class="nv">npercell</span> <span class="o">*</span> <span class="nv">ncells</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">recv_flag</span><span class="p">))</span> <span class="nv">recv_flag</span> <span class="o">=</span> <span class="nb">.true.</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">md_realm</span><span class="p">)</span> <span class="k">then</span>
				<span class="c">!Allocate receive buffer for MD processors</span>
				<span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">vbuf</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="nv">vbuf</span><span class="p">);</span> <span class="k">allocate</span><span class="p">(</span><span class="nv">vbuf</span><span class="p">(</span><span class="nv">ndata</span><span class="p">));</span> <span class="nv">vbuf</span><span class="o">=</span><span class="mf">0.</span><span class="nv">d0</span>
			<span class="k">endif</span>

			<span class="c">! Receive section of data</span>
			<span class="nv">itag</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">call </span><span class="nv">MPI_irecv</span><span class="p">(</span><span class="nv">vbuf</span><span class="p">(</span><span class="nv">start_address</span><span class="p">),</span><span class="nv">ndata</span><span class="p">,</span><span class="nv">MPI_DOUBLE_PRECISION</span><span class="p">,</span><span class="nv">sourceid</span><span class="p">,</span><span class="nv">itag</span><span class="p">,&amp;</span>
            						<span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span><span class="nv">req</span><span class="p">(</span><span class="nv">nbr</span><span class="p">),</span><span class="nv">ierr</span><span class="p">)</span>

		<span class="k">endif</span>

		<span class="c">!Increment pointer ready to receive next piece of data		</span>
		<span class="nv">start_address</span> <span class="o">=</span> <span class="nv">start_address</span> <span class="o">+</span> <span class="nv">ndata</span>

    <span class="nv">enddo</span>
    <span class="k">call </span><span class="nv">MPI_waitall</span><span class="p">(</span><span class="nv">nneighbors</span><span class="p">,</span> <span class="nv">req</span><span class="p">,</span> <span class="nv">status</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

	<span class="c">!if (rank_world .eq. 33) then</span>
	<span class="c">!	do n = 1,size(vbuf)</span>
	<span class="c">!		write(98000+rank_world,*) rank_world,n, vbuf(n)</span>
	<span class="c">!	enddo</span>
	<span class="c">!endif</span>

	<span class="c">! ----------------- Unpack data -----------------------------</span>
	<span class="nv">start_address</span> <span class="o">=</span> <span class="mi">1</span>
	<span class="k">do </span><span class="nv">nbr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">nneighbors</span>

		<span class="c">!Get source processor from topology graph</span>
        <span class="nv">sourceid</span> <span class="o">=</span>  <span class="nv">id_neighbors</span><span class="p">(</span><span class="nv">nbr</span><span class="p">)</span>

	    <span class="c">! Get size of data to receive from source processors</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">cfd_realm</span><span class="p">)</span> <span class="k">then</span>
			<span class="c">!CFD always receives data</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">recv_flag</span><span class="p">))</span> <span class="nv">recv_flag</span> <span class="o">=</span> <span class="nb">.true.</span>
			<span class="c">!CFD realm receives data based on size of MD processor domain</span>
			<span class="k">call </span><span class="nv">CPL_Cart_coords</span><span class="p">(</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span> <span class="nv">sourceid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nv">md_realm</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nv">pcoords</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span> 
		<span class="nv">elseif</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">md_realm</span><span class="p">)</span> <span class="k">then</span>
			<span class="c">!MD realm receives data as big as own processor domain</span>
			<span class="nv">pcoords</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="nv">iblock_realm</span><span class="p">,</span><span class="nv">jblock_realm</span><span class="p">,</span><span class="nv">kblock_realm</span> <span class="o">/</span><span class="p">)</span>
			<span class="c">!Get extents of current processor/overlap region</span>
			<span class="k">call </span><span class="nv">CPL_proc_extents</span><span class="p">(</span><span class="nv">pcoords</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="nv">extents</span><span class="p">)</span>
		<span class="k">endif</span>

		<span class="c">! If limits passed to recv routine, use these instead</span>
		<span class="c">! of overlap/processor limits</span>
		<span class="k">call </span><span class="nv">CPL_proc_portion</span><span class="p">(</span><span class="nv">pcoords</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="nv">limits</span><span class="p">,</span><span class="nv">portion</span><span class="p">,</span><span class="nv">ncells</span><span class="p">)</span>
				
		<span class="c">! Unpack array into buffer</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="nv">portion</span><span class="ow">.eq.</span><span class="nv">VOID</span><span class="p">))</span> <span class="k">then</span>
			<span class="c">!print*, &#39;VOID recv qqqq&#39;,realm_name(realm),rank_world,rank_realm,rank_graph2rank_world(sourceid+1),recv_flag</span>
			<span class="nv">ndata</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">else</span>
			<span class="c">! Get local extents in received region</span>
			<span class="nv">pos</span> <span class="o">=</span> <span class="nv">start_address</span><span class="p">;</span> <span class="nv">ndata</span> <span class="o">=</span> <span class="nv">npercell</span> <span class="o">*</span> <span class="nv">ncells</span>
			<span class="nv">iclmin</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="nv">extents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>	<span class="nv">iclmax</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="nv">extents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
			<span class="nv">jclmin</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="nv">extents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>	<span class="nv">jclmax</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="nv">extents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
			<span class="nv">kclmin</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">-</span><span class="nv">extents</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>	<span class="nv">kclmax</span> <span class="o">=</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">-</span><span class="nv">extents</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
			<span class="c">!print&#39;(a,5i4,2i6,i4,18i4,l)&#39;, &#39;recv qqqq&#39;,rank_world,rank_realm,rank_olap,ndata,nbr, &amp; </span>
			<span class="c">!							rank_graph2rank_world(sourceid+1),size(arecv),start_address,&amp;</span>
			<span class="c">!							iclmin,iclmax,jclmin,jclmax,kclmin,kclmax, &amp; </span>
			<span class="c">!							portion,extents,recv_flag</span>
			<span class="k">do </span><span class="nv">kcell</span><span class="o">=</span><span class="nv">kclmin</span><span class="p">,</span><span class="nv">kclmax</span>
			<span class="k">do </span><span class="nv">jcell</span><span class="o">=</span><span class="nv">jclmin</span><span class="p">,</span><span class="nv">jclmax</span>
			<span class="k">do </span><span class="nv">icell</span><span class="o">=</span><span class="nv">iclmin</span><span class="p">,</span><span class="nv">iclmax</span>
			<span class="k">do </span><span class="nv">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">npercell</span>
				<span class="nv">arecv</span><span class="p">(</span><span class="nv">n</span><span class="p">,</span><span class="nv">icell</span><span class="p">,</span><span class="nv">jcell</span><span class="p">,</span><span class="nv">kcell</span><span class="p">)</span> <span class="o">=</span> <span class="nv">vbuf</span><span class="p">(</span><span class="nv">pos</span><span class="p">)</span>
				<span class="c">!print&#39;(6i5,f15.5)&#39;, rank_world,pos,n,icell,jcell,kcell,vbuf(pos)</span>
				<span class="nv">pos</span> <span class="o">=</span> <span class="nv">pos</span> <span class="o">+</span> <span class="mi">1</span>
			<span class="k">end do</span>
<span class="k">			end do</span>
<span class="k">			end do</span>
<span class="k">			end do</span>


<span class="k">		endif</span>

		<span class="c">!Increment reading position of packed data</span>
		<span class="nv">start_address</span> <span class="o">=</span> <span class="nv">start_address</span> <span class="o">+</span> <span class="nv">ndata</span>

	<span class="nv">enddo</span>
	<span class="c">! ----------------- Unpack data -----------------------------</span>
           
<span class="k">end subroutine </span><span class="nv">CPL_recv_xd</span>

<span class="c">!-------------------------------------------------------------------</span>

<span class="k">subroutine </span><span class="nv">CPL_pack</span><span class="p">(</span><span class="nv">unpacked</span><span class="p">,</span><span class="nv">packed</span><span class="p">,</span><span class="nv">realm</span><span class="p">,</span><span class="nv">icmax_pack</span><span class="p">,</span><span class="nv">icmin_pack</span><span class="p">,</span><span class="nv">jcmax_pack</span><span class="p">,</span> <span class="p">&amp;</span> 
	                                      <span class="nv">jcmin_pack</span><span class="p">,</span><span class="nv">kcmax_pack</span><span class="p">,</span><span class="nv">kcmin_pack</span>    <span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> <span class="nv">CPL_CART_COMM</span><span class="p">,</span><span class="nv">rank_cart</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="nv">cfd_realm</span><span class="p">,</span> <span class="p">&amp;</span> 
	                           <span class="nv">error_abort</span><span class="p">,</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span><span class="nv">myid_graph</span><span class="p">,</span><span class="nv">realm_name</span>
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>											<span class="kd">::</span> <span class="nv">realm</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:,:,:,:),</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>		<span class="kd">::</span> <span class="nv">unpacked</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>	<span class="kd">::</span> <span class="nv">packed</span>

    <span class="c">! Optional minimum and maximum values to pack</span>
 	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">),</span> <span class="k">optional</span>    <span class="kd">::</span> <span class="nv">icmax_pack</span><span class="p">,</span><span class="nv">icmin_pack</span>
 	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">),</span> <span class="k">optional</span>    <span class="kd">::</span> <span class="nv">jcmax_pack</span><span class="p">,</span><span class="nv">jcmin_pack</span>
 	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">),</span> <span class="k">optional</span>    <span class="kd">::</span> <span class="nv">kcmax_pack</span><span class="p">,</span><span class="nv">kcmin_pack</span>

	<span class="kt">integer</span>                          <span class="kd">::</span> <span class="nv">pos</span><span class="p">,</span><span class="nv">n</span><span class="p">,</span><span class="nv">nbr</span><span class="p">,</span><span class="nv">id_nbr</span><span class="p">,</span><span class="nv">icell</span><span class="p">,</span><span class="nv">jcell</span><span class="p">,</span><span class="nv">kcell</span><span class="p">,</span><span class="nv">ierr</span>
	<span class="kt">integer</span>                          <span class="kd">::</span> <span class="nv">npercell</span><span class="p">,</span><span class="nv">ncells</span><span class="p">,</span><span class="nv">nneighbors</span>
	<span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>			 <span class="kd">::</span> <span class="nv">coord</span>
	<span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>			 <span class="kd">::</span> <span class="nv">extents</span><span class="p">,</span><span class="nv">gextents</span>
	<span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="nv">id_neighbors</span>

	<span class="c">!Amount of data per cell</span>
	<span class="nv">npercell</span> <span class="o">=</span> <span class="nv">size</span><span class="p">(</span><span class="nv">unpacked</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

	<span class="c">!Allocate packing buffer</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">packed</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="nv">packed</span><span class="p">)</span>
	<span class="k">allocate</span><span class="p">(</span><span class="nv">packed</span><span class="p">(</span><span class="nv">size</span><span class="p">(</span><span class="nv">unpacked</span><span class="p">)))</span>

	<span class="c">! Get neighbour topology to determine ordering of packed data</span>
	<span class="k">call </span><span class="nv">MPI_Graph_neighbors_count</span><span class="p">(</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span><span class="nv">myid_graph</span><span class="p">,</span><span class="nv">nneighbors</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">id_neighbors</span><span class="p">(</span><span class="nv">nneighbors</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_Graph_neighbors</span><span class="p">(</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span><span class="nv">myid_graph</span><span class="p">,</span><span class="nv">nneighbors</span><span class="p">,</span><span class="nv">id_neighbors</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>

	<span class="c">! Loop through all neighbours which will be sent to and order the data </span>
	<span class="c">! appropriately to send each correctly</span>
	<span class="k">do </span><span class="nv">nbr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">nneighbors</span>

		<span class="k">if</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">cfd_realm</span><span class="p">)</span> <span class="k">then</span>

			<span class="c">! Get MD neighbour</span>
			<span class="nv">id_nbr</span> <span class="o">=</span> <span class="nv">id_neighbors</span><span class="p">(</span><span class="nv">nbr</span><span class="p">)</span>
			<span class="k">call </span><span class="nv">CPL_Cart_coords</span><span class="p">(</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span><span class="nv">id_nbr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">coord</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> 
			<span class="k">call </span><span class="nv">CPL_olap_extents</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="nv">extents</span><span class="p">,</span><span class="nv">ncells</span><span class="p">)</span>

			<span class="c">! Get offset of neighbouring processor</span>
			<span class="nv">pos</span> <span class="o">=</span> <span class="nv">id_nbr</span> <span class="o">*</span> <span class="nv">npercell</span> <span class="o">*</span> <span class="nv">ncells</span>

			<span class="c">!print*,&#39;Pack&#39;,rank_cart,realm_name(realm),coord,nbr,id_nbr,extents,coord</span>

		<span class="nv">elseif</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">md_realm</span><span class="p">)</span> <span class="k">then</span>
			<span class="c">!Get own processor coordinates </span>
			<span class="k">call </span><span class="nv">CPL_Cart_coords</span><span class="p">(</span><span class="nv">CPL_CART_COMM</span><span class="p">,</span><span class="nv">rank_cart</span><span class="p">,</span><span class="nv">realm</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">coord</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> 
			<span class="k">call </span><span class="nv">CPL_olap_extents</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">realm</span><span class="p">,</span><span class="nv">gextents</span><span class="p">,</span><span class="nv">ncells</span><span class="p">)</span>
			<span class="c">! Get local extents</span>
			<span class="nv">extents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="nv">extents</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="nv">gextents</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="nv">gextents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
			<span class="nv">extents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="nv">extents</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="nv">gextents</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="nv">gextents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
			<span class="nv">extents</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="nv">extents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="nv">gextents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">-</span><span class="nv">gextents</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
			<span class="nv">pos</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="k">endif</span>

		<span class="c">! Pack array into buffer</span>
		<span class="k">do </span><span class="nv">kcell</span><span class="o">=</span><span class="nv">extents</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="nv">extents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
		<span class="k">do </span><span class="nv">jcell</span><span class="o">=</span><span class="nv">extents</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="nv">extents</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
		<span class="k">do </span><span class="nv">icell</span><span class="o">=</span><span class="nv">extents</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="nv">extents</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
		<span class="k">do </span><span class="nv">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">npercell</span>

			<span class="nv">packed</span><span class="p">(</span><span class="nv">pos</span><span class="p">)</span> <span class="o">=</span> <span class="nv">unpacked</span><span class="p">(</span><span class="nv">n</span><span class="p">,</span><span class="nv">icell</span><span class="p">,</span><span class="nv">jcell</span><span class="p">,</span><span class="nv">kcell</span><span class="p">)</span>
			<span class="nv">pos</span> <span class="o">=</span> <span class="nv">pos</span> <span class="o">+</span> <span class="mi">1</span>

		<span class="k">end do</span>
<span class="k">		end do</span>
<span class="k">		end do</span>
<span class="k">		end do</span>

<span class="k">	end do</span>

	<span class="c">!Sanity check</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">size</span><span class="p">(</span><span class="nv">packed</span><span class="p">)</span> <span class="ow">.ne.</span> <span class="nv">npercell</span><span class="o">*</span><span class="nv">ncells</span><span class="p">)</span> <span class="k">then</span>
		<span class="c">!print*, &#39;data size&#39;, size(packed), &#39;expected size&#39;, npercell*ncells</span>
		<span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_pack error - cell array does not match expected extents&quot;</span><span class="p">)</span>
	<span class="k">endif</span>

<span class="k">end subroutine </span><span class="nv">CPL_pack</span>


<span class="c">!-------------------------------------------------------------------</span>

<span class="k">subroutine </span><span class="nv">CPL_unpack</span><span class="p">(</span><span class="nv">packed</span><span class="p">,</span><span class="nv">unpacked</span><span class="p">,</span><span class="nv">realm</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> <span class="nv">CPL_CART_COMM</span><span class="p">,</span><span class="nv">rank_cart</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="nv">cfd_realm</span><span class="p">,</span> <span class="p">&amp;</span> 
	                           <span class="nv">error_abort</span><span class="p">,</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span><span class="nv">myid_graph</span>
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>											      <span class="kd">::</span> <span class="nv">realm</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:,:,:,:),</span><span class="k">allocatable</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">unpacked</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">inout</span><span class="p">)</span>     <span class="kd">::</span> <span class="nv">packed</span>

	<span class="kt">integer</span>                          <span class="kd">::</span> <span class="nv">pos</span><span class="p">,</span><span class="nv">n</span><span class="p">,</span><span class="nv">nbr</span><span class="p">,</span><span class="nv">id_nbr</span><span class="p">,</span><span class="nv">icell</span><span class="p">,</span><span class="nv">jcell</span><span class="p">,</span><span class="nv">kcell</span><span class="p">,</span><span class="nv">ierr</span>
	<span class="kt">integer</span>                          <span class="kd">::</span> <span class="nv">npercell</span><span class="p">,</span><span class="nv">ncells</span><span class="p">,</span><span class="nv">nneighbors</span>
	<span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>			 <span class="kd">::</span> <span class="nv">coord</span>
	<span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>			 <span class="kd">::</span> <span class="nv">extents</span><span class="p">,</span><span class="nv">gextents</span>
	<span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="nv">id_neighbors</span>

	<span class="k">call </span><span class="nv">CPL_Cart_coords</span><span class="p">(</span><span class="nv">CPL_CART_COMM</span><span class="p">,</span><span class="nv">rank_cart</span><span class="p">,</span><span class="nv">realm</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">coord</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> 
	<span class="k">call </span><span class="nv">CPL_proc_extents</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">realm</span><span class="p">,</span><span class="nv">extents</span><span class="p">,</span><span class="nv">ncells</span><span class="p">)</span>

	<span class="c">!Amount of data per cell</span>
	<span class="nv">npercell</span> <span class="o">=</span> <span class="nv">size</span><span class="p">(</span><span class="nv">packed</span><span class="p">)</span><span class="o">/</span><span class="nv">ncells</span>

	<span class="c">!Allocate packing buffer</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">unpacked</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="nv">unpacked</span><span class="p">)</span>
	<span class="k">allocate</span><span class="p">(</span><span class="nv">unpacked</span><span class="p">(</span><span class="nv">npercell</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="nv">extents</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="nv">extents</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">&amp;</span>
	                 		   <span class="mi">1</span><span class="p">:</span><span class="nv">extents</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="nv">extents</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">&amp;</span>
	                 		   <span class="mi">1</span><span class="p">:</span><span class="nv">extents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">-</span><span class="nv">extents</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>

	<span class="c">! Get neighbour topology to determine ordering of packed data</span>
	<span class="k">call </span><span class="nv">MPI_Graph_neighbors_count</span><span class="p">(</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span><span class="nv">myid_graph</span><span class="p">,</span><span class="nv">nneighbors</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">id_neighbors</span><span class="p">(</span><span class="nv">nneighbors</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_Graph_neighbors</span><span class="p">(</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span><span class="nv">myid_graph</span><span class="p">,</span><span class="nv">nneighbors</span><span class="p">,</span><span class="nv">id_neighbors</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>

	<span class="c">! Loop through all neighbours which will be sent to and order the data </span>
	<span class="c">! appropriately to send each correctly</span>
	<span class="k">do </span><span class="nv">nbr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">nneighbors</span>

		<span class="k">if</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">cfd_realm</span><span class="p">)</span> <span class="k">then</span>
			<span class="c">! Get MD neighbour</span>
			<span class="nv">id_nbr</span> <span class="o">=</span> <span class="nv">id_neighbors</span><span class="p">(</span><span class="nv">nbr</span><span class="p">)</span>
			<span class="k">call </span><span class="nv">CPL_Cart_coords</span><span class="p">(</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span><span class="nv">id_nbr</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">coord</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> 
			<span class="k">call </span><span class="nv">CPL_proc_extents</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">md_realm</span><span class="p">,</span><span class="nv">extents</span><span class="p">,</span><span class="nv">ncells</span><span class="p">)</span>
			<span class="c">! Get offset of neighbouring processor</span>
			<span class="nv">pos</span> <span class="o">=</span> <span class="nv">id_nbr</span> <span class="o">*</span> <span class="nv">npercell</span> <span class="o">*</span> <span class="nv">ncells</span>	<span class="c">!ASSUMES all ncell the same!!</span>
		<span class="nv">elseif</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">md_realm</span><span class="p">)</span> <span class="k">then</span>
			<span class="c">!Get own processor coordinates </span>
			<span class="k">call </span><span class="nv">CPL_Cart_coords</span><span class="p">(</span><span class="nv">CPL_CART_COMM</span><span class="p">,</span><span class="nv">rank_cart</span><span class="p">,</span><span class="nv">realm</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">coord</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> 
			<span class="k">call </span><span class="nv">CPL_proc_extents</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">realm</span><span class="p">,</span><span class="nv">gextents</span><span class="p">,</span><span class="nv">ncells</span><span class="p">)</span>
			<span class="c">! Get local extents</span>
			<span class="nv">extents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="nv">extents</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="nv">gextents</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="nv">gextents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
			<span class="nv">extents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="nv">extents</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="nv">gextents</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="nv">gextents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
			<span class="nv">extents</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="nv">extents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="nv">gextents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">-</span><span class="nv">gextents</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
			<span class="nv">pos</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="k">endif</span>

		<span class="c">! Unpack buffer into array</span>
		<span class="k">do </span><span class="nv">kcell</span><span class="o">=</span><span class="nv">extents</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="nv">extents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
		<span class="k">do </span><span class="nv">jcell</span><span class="o">=</span><span class="nv">extents</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="nv">extents</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
		<span class="k">do </span><span class="nv">icell</span><span class="o">=</span><span class="nv">extents</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="nv">extents</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
		<span class="k">do </span><span class="nv">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">npercell</span>

			<span class="nv">unpacked</span><span class="p">(</span><span class="nv">n</span><span class="p">,</span><span class="nv">icell</span><span class="p">,</span><span class="nv">jcell</span><span class="p">,</span><span class="nv">kcell</span><span class="p">)</span> <span class="o">=</span> <span class="nv">packed</span><span class="p">(</span><span class="nv">pos</span><span class="p">)</span>
			<span class="nv">pos</span> <span class="o">=</span> <span class="nv">pos</span> <span class="o">+</span> <span class="mi">1</span>

		<span class="k">end do</span>
<span class="k">		end do</span>
<span class="k">		end do</span>
<span class="k">		end do</span>

<span class="k">	end do</span>

	<span class="c">!Deallocate packed buffer</span>
	<span class="k">deallocate</span><span class="p">(</span><span class="nv">packed</span><span class="p">)</span>

<span class="k">end subroutine </span><span class="nv">CPL_unpack</span>


<span class="c">!-------------------------------------------------------------------</span>
<span class="c">! 					CPL_proc_extents  			      -</span>
<span class="c">!-------------------------------------------------------------------</span>
<span class="c">!&gt;</span>
<span class="c">!!</span>
<span class="c">!! Gets maximum and minimum cells for processor coordinates</span>
<span class="c">!!</span>
<span class="c">!! - Synopsis</span>
<span class="c">!!</span>
<span class="c">!!  - CPL_proc_extents(coord,realm,extents,ncells)</span>
<span class="c">!!</span>
<span class="c">!! - Input</span>
<span class="c">!!</span>
<span class="c">!!  - coord</span>
<span class="c">!!   - processor cartesian coordinate (3 x integer) </span>
<span class="c">!!</span>
<span class="c">!!  - realm</span>
<span class="c">!!   - cfd_realm (1) or md_realm (2) (integer) </span>
<span class="c">!!</span>
<span class="c">!! - Input/Output</span>
<span class="c">!!  - NONE</span>
<span class="c">!!</span>
<span class="c">!! - Output</span>
<span class="c">!!</span>
<span class="c">!!  - extents</span>
<span class="c">!!   - Six components array which defines processor extents</span>
<span class="c">!!     xmin,xmax,ymin,ymax,zmin,zmax (6 x integer) </span>
<span class="c">!!</span>
<span class="c">!!  - ncells (optional)</span>
<span class="c">!!   - number of cells on processor (integer) </span>
<span class="c">!!</span>
<span class="c">!! @author David Trevelyan</span>
<span class="k">subroutine </span><span class="nv">CPL_proc_extents</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">realm</span><span class="p">,</span><span class="nv">extents</span><span class="p">,</span><span class="nv">ncells</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">mpi</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">md_realm</span><span class="p">,</span>      <span class="nv">cfd_realm</span><span class="p">,</span>      <span class="p">&amp;</span>
	                          <span class="nv">icPmin_md</span><span class="p">,</span>     <span class="nv">icPmax_md</span><span class="p">,</span>      <span class="p">&amp;</span>
	                          <span class="nv">jcPmin_md</span><span class="p">,</span>     <span class="nv">jcPmax_md</span><span class="p">,</span>      <span class="p">&amp;</span>
	                          <span class="nv">kcPmin_md</span><span class="p">,</span>     <span class="nv">kcPmax_md</span><span class="p">,</span>      <span class="p">&amp;</span>
	                          <span class="nv">icPmin_cfd</span><span class="p">,</span>    <span class="nv">icPmax_cfd</span><span class="p">,</span>     <span class="p">&amp;</span>
	                          <span class="nv">jcPmin_cfd</span><span class="p">,</span>    <span class="nv">jcPmax_cfd</span><span class="p">,</span>     <span class="p">&amp;</span>
	                          <span class="nv">kcPmin_cfd</span><span class="p">,</span>    <span class="nv">kcPmax_cfd</span><span class="p">,</span>     <span class="p">&amp;</span>
	                          <span class="nv">error_abort</span>
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="nv">coord</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="nv">realm</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">extents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">ncells</span>

	<span class="k">select case</span><span class="p">(</span><span class="nv">realm</span><span class="p">)</span>
	<span class="k">case</span><span class="p">(</span><span class="nv">md_realm</span><span class="p">)</span>
		<span class="nv">extents</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="nv">icPmin_md</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="nv">icPmax_md</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="p">&amp;</span> 
		            <span class="nv">jcPmin_md</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="nv">jcPmax_md</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> <span class="p">&amp;</span> 
		            <span class="nv">kcPmin_md</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="nv">kcPmax_md</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="p">)</span>
	<span class="k">case</span><span class="p">(</span><span class="nv">cfd_realm</span><span class="p">)</span>
		<span class="nv">extents</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="nv">icPmin_cfd</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="nv">icPmax_cfd</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="p">&amp;</span> 
		            <span class="nv">jcPmin_cfd</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="nv">jcPmax_cfd</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> <span class="p">&amp;</span> 
		            <span class="nv">kcPmin_cfd</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="nv">kcPmax_cfd</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="p">)</span>

	<span class="k">case </span><span class="nv">default</span>
		<span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s1">&#39;Wrong realm in CPL_proc_extents&#39;</span><span class="p">)</span>
	<span class="k">end select</span>

<span class="k">	if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">ncells</span><span class="p">))</span> <span class="k">then</span>
<span class="k">		</span><span class="nv">ncells</span> <span class="o">=</span> <span class="p">(</span><span class="nv">extents</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nv">extents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">&amp;</span>
				 <span class="p">(</span><span class="nv">extents</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="nv">extents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">&amp;</span>
				 <span class="p">(</span><span class="nv">extents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="nv">extents</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
	<span class="k">end if</span>

<span class="k">end subroutine </span><span class="nv">CPL_proc_extents</span>

<span class="c">!-------------------------------------------------------------------</span>
<span class="c">! 					CPL_olap_extents  			      -</span>
<span class="c">!-------------------------------------------------------------------</span>
<span class="c">!&gt;</span>
<span class="c">!!</span>
<span class="c">!! Get maximum and minimum cells for current communicator within</span>
<span class="c">!! the overlapping region only</span>
<span class="c">!!</span>
<span class="c">!! - Synopsis </span>
<span class="c">!!</span>
<span class="c">!!  - CPL_olap_extents(coord,realm,extents,ncells)</span>
<span class="c">!!</span>
<span class="c">!! - Input </span>
<span class="c">!!</span>
<span class="c">!!  - coord</span>
<span class="c">!!   - processor cartesian coordinate (3 x integer) </span>
<span class="c">!!</span>
<span class="c">!!  - realm</span>
<span class="c">!!   - cfd_realm (1) or md_realm (2) (integer) </span>
<span class="c">!!</span>
<span class="c">!! - Input/Output</span>
<span class="c">!!  - NONE</span>
<span class="c">!!</span>
<span class="c">!! - Output </span>
<span class="c">!!</span>
<span class="c">!!  - extents</span>
<span class="c">!!   - Six components array which defines processor extents within</span>
<span class="c">!!     the overlap region only: xmin,xmax,ymin,ymax,zmin,zmax (6 x integer) </span>
<span class="c">!!</span>
<span class="c">!!  - ncells (optional)</span>
<span class="c">!!   - number of cells on processor (integer) </span>
<span class="c">!!</span>
<span class="c">!! @author David Trevelyan</span>
<span class="k">subroutine </span><span class="nv">CPL_olap_extents</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">realm</span><span class="p">,</span><span class="nv">extents</span><span class="p">,</span><span class="nv">ncells</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">mpi</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">md_realm</span><span class="p">,</span>      <span class="nv">cfd_realm</span><span class="p">,</span>      <span class="p">&amp;</span>
	                          <span class="nv">icPmin_md</span><span class="p">,</span>     <span class="nv">icPmax_md</span><span class="p">,</span>      <span class="p">&amp;</span>
	                          <span class="nv">jcPmin_md</span><span class="p">,</span>     <span class="nv">jcPmax_md</span><span class="p">,</span>      <span class="p">&amp;</span>
	                          <span class="nv">kcPmin_md</span><span class="p">,</span>     <span class="nv">kcPmax_md</span><span class="p">,</span>      <span class="p">&amp;</span>
	                          <span class="nv">icPmin_cfd</span><span class="p">,</span>    <span class="nv">icPmax_cfd</span><span class="p">,</span>     <span class="p">&amp;</span>
	                          <span class="nv">jcPmin_cfd</span><span class="p">,</span>    <span class="nv">jcPmax_cfd</span><span class="p">,</span>     <span class="p">&amp;</span>
	                          <span class="nv">kcPmin_cfd</span><span class="p">,</span>    <span class="nv">kcPmax_cfd</span><span class="p">,</span>     <span class="p">&amp;</span>
	                          <span class="nv">icmin_olap</span><span class="p">,</span>    <span class="nv">icmax_olap</span><span class="p">,</span>     <span class="p">&amp;</span> 
	                          <span class="nv">jcmin_olap</span><span class="p">,</span>    <span class="nv">jcmax_olap</span><span class="p">,</span>     <span class="p">&amp;</span> 
	                          <span class="nv">kcmin_olap</span><span class="p">,</span>    <span class="nv">kcmax_olap</span><span class="p">,</span>     <span class="p">&amp;</span> 
	                          <span class="nv">error_abort</span>
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="nv">coord</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="nv">realm</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">extents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">ncells</span>

	<span class="k">select case</span><span class="p">(</span><span class="nv">realm</span><span class="p">)</span>
	<span class="k">case</span><span class="p">(</span><span class="nv">md_realm</span><span class="p">)</span>
		<span class="nv">extents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nv">icPmin_md</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="nv">icmin_olap</span><span class="p">)</span>
		<span class="nv">extents</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nv">icPmax_md</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="nv">icmax_olap</span><span class="p">)</span> 
		<span class="nv">extents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nv">jcPmin_md</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="nv">jcmin_olap</span><span class="p">)</span> 
		<span class="nv">extents</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nv">jcPmax_md</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="nv">jcmax_olap</span><span class="p">)</span> 
		<span class="nv">extents</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nv">kcPmin_md</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="nv">kcmin_olap</span><span class="p">)</span> 
		<span class="nv">extents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nv">kcPmax_md</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="nv">kcmax_olap</span><span class="p">)</span> 
	<span class="k">case</span><span class="p">(</span><span class="nv">cfd_realm</span><span class="p">)</span>
		<span class="nv">extents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nv">icPmin_cfd</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="nv">icmin_olap</span><span class="p">)</span>
		<span class="nv">extents</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nv">icPmax_cfd</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="nv">icmax_olap</span><span class="p">)</span> 
		<span class="nv">extents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nv">jcPmin_cfd</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="nv">jcmin_olap</span><span class="p">)</span> 
		<span class="nv">extents</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nv">jcPmax_cfd</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="nv">jcmax_olap</span><span class="p">)</span> 
		<span class="nv">extents</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nv">kcPmin_cfd</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="nv">kcmin_olap</span><span class="p">)</span> 
		<span class="nv">extents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nv">kcPmax_cfd</span><span class="p">(</span><span class="nv">coord</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="nv">kcmax_olap</span><span class="p">)</span> 
	<span class="k">case </span><span class="nv">default</span>
		<span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s1">&#39;Wrong realm in CPL_olap_extents&#39;</span><span class="p">)</span>
	<span class="k">end select</span>

<span class="k">	if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">ncells</span><span class="p">))</span> <span class="k">then</span>
<span class="k">		</span><span class="nv">ncells</span> <span class="o">=</span> <span class="p">(</span><span class="nv">extents</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nv">extents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">&amp;</span>
				 <span class="p">(</span><span class="nv">extents</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="nv">extents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">&amp;</span>
				 <span class="p">(</span><span class="nv">extents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="nv">extents</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
	<span class="k">end if</span>

<span class="k">end subroutine </span><span class="nv">CPL_olap_extents</span>

<span class="c">!-------------------------------------------------------------------</span>
<span class="c">! 					CPL_proc_portion  			      -</span>
<span class="c">!-------------------------------------------------------------------</span>
<span class="c">!&gt;</span>
<span class="c">!! Get maximum and minimum cell indices, i.e. the &#39;portion&#39;, of the</span>
<span class="c">!! input cell extents &#39;limits&#39; that is contributed by the current</span>
<span class="c">!! overlapping processor. </span>
<span class="c">!!</span>
<span class="c">!! - Synopsis</span>
<span class="c">!!  - CPL_proc_portion(coord,realm,limits,portion,ncells)</span>
<span class="c">!!</span>
<span class="c">!! - Input</span>
<span class="c">!!</span>
<span class="c">!!  - coord</span>
<span class="c">!!   - processor cartesian coordinate (3 x integer) </span>
<span class="c">!!</span>
<span class="c">!!  - realm</span>
<span class="c">!!   - cfd_realm (1) or md_realm (2) (integer) </span>
<span class="c">!!</span>
<span class="c">!!  - limits(6)</span>
<span class="c">!!   - Array of cell extents that specify the input region. </span>
<span class="c">!!</span>
<span class="c">!! - Input/Output</span>
<span class="c">!!  - NONE</span>
<span class="c">!!</span>
<span class="c">!! - Output</span>
<span class="c">!!</span>
<span class="c">!!  - portion(6) </span>
<span class="c">!!   - Array of cell extents that define the local processor&#39;s</span>
<span class="c">!!     contribution to the input region &#39;limits&#39;.</span>
<span class="c">!!</span>
<span class="c">!!   - ncells (optional)</span>
<span class="c">!!    - number of cells in portion (integer) </span>
<span class="c">!!</span>
<span class="c">!! - Note: limits(6) and portion(6) are of the form:</span>
<span class="c">!!   (xmin,xmax,ymin,ymax,zmin,zmax)</span>
<span class="c">!!</span>
<span class="c">!! @author David Trevelyan</span>

<span class="k">subroutine </span><span class="nv">CPL_proc_portion</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">realm</span><span class="p">,</span><span class="nv">limits</span><span class="p">,</span><span class="nv">portion</span><span class="p">,</span><span class="nv">ncells</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">mpi</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">VOID</span>
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="nv">coord</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="nv">limits</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="nv">realm</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">ncells</span>
	<span class="kt">integer</span> <span class="kd">::</span> <span class="nv">extents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

	<span class="k">call </span><span class="nv">CPL_proc_extents</span><span class="p">(</span><span class="nv">coord</span><span class="p">,</span><span class="nv">realm</span><span class="p">,</span><span class="nv">extents</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="nv">extents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="ow">.gt.</span><span class="nv">limits</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">.or.</span> <span class="p">&amp;</span>
		<span class="nv">extents</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="ow">.lt.</span><span class="nv">limits</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">.or.</span> <span class="p">&amp;</span>
		<span class="nv">extents</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="ow">.gt.</span><span class="nv">limits</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="ow">.or.</span> <span class="p">&amp;</span>
	    <span class="nv">extents</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="ow">.lt.</span><span class="nv">limits</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="ow">.or.</span> <span class="p">&amp;</span>
	    <span class="nv">extents</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="ow">.gt.</span><span class="nv">limits</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="ow">.or.</span> <span class="p">&amp;</span>
	    <span class="nv">extents</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="ow">.lt.</span><span class="nv">limits</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="k">then</span>

<span class="k">		</span><span class="nv">portion</span><span class="p">(:)</span> <span class="o">=</span> <span class="nv">VOID</span>
		<span class="k">if</span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">ncells</span><span class="p">))</span> <span class="nv">ncells</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">return</span>
<span class="k">		</span>
<span class="k">	end if</span>

<span class="k">	</span><span class="nv">portion</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nv">extents</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="nv">limits</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>							
	<span class="nv">portion</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nv">extents</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="nv">limits</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>							
	<span class="nv">portion</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nv">extents</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="nv">limits</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>							
	<span class="nv">portion</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nv">extents</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="nv">limits</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>							
	<span class="nv">portion</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nv">extents</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="nv">limits</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>							
	<span class="nv">portion</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nv">extents</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="nv">limits</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>							

	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">ncells</span><span class="p">))</span> <span class="k">then</span>
<span class="k">		</span><span class="nv">ncells</span> <span class="o">=</span> <span class="p">(</span><span class="nv">portion</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">&amp;</span>
				 <span class="p">(</span><span class="nv">portion</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">&amp;</span>
				 <span class="p">(</span><span class="nv">portion</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="nv">portion</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
	<span class="k">end if</span>

<span class="k">end subroutine </span><span class="nv">CPL_proc_portion</span> 

<span class="c">!-------------------------------------------------------------------</span>
<span class="c">! 					CPL_Cart_coords								   -</span>
<span class="c">!-------------------------------------------------------------------</span>

<span class="c">!&gt;</span>
<span class="c">!! Determines process coords in appropriate realm&#39;s cartesian topology </span>
<span class="c">!! given a rank in any communicator</span>
<span class="c">!!</span>
<span class="c">!! - Synopsis</span>
<span class="c">!!</span>
<span class="c">!!  - CPL_Cart_coords(COMM, rank, realm, maxdims, coords, ierr)</span>
<span class="c">!!</span>
<span class="c">!! - Input Parameters</span>
<span class="c">!!</span>
<span class="c">!!  - comm</span>
<span class="c">!!   - communicator with cartesian structure (handle) </span>
<span class="c">!!</span>
<span class="c">!!  - realm</span>
<span class="c">!!   - cfd_realm (1) or md_realm (2) (integer) </span>
<span class="c">!!</span>
<span class="c">!!  - rank</span>
<span class="c">!!   - rank of a process within group of comm (integer) </span>
<span class="c">!!      NOTE fortran convention rank=1 to nproc</span>
<span class="c">!!</span>
<span class="c">!!  - maxdims</span>
<span class="c">!!   - length of vector coords in the calling program (integer) </span>
<span class="c">!!</span>
<span class="c">!! - Output Parameter</span>
<span class="c">!!</span>
<span class="c">!!  - coords</span>
<span class="c">!!   - integer array (of size ndims) containing the Cartesian coordinates </span>
<span class="c">!!     of specified process (integer) </span>
<span class="c">!!</span>
<span class="c">!!  - ierr</span>
<span class="c">!!   - error flag</span>
<span class="c">!! @author Edward Smith</span>

<span class="k">subroutine </span><span class="nv">CPL_Cart_coords</span><span class="p">(</span><span class="nv">COMM</span><span class="p">,</span> <span class="nv">rank</span><span class="p">,</span> <span class="nv">realm</span><span class="p">,</span> <span class="nv">maxdims</span><span class="p">,</span> <span class="nv">coords</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span>  <span class="nv">CPL_WORLD_COMM</span><span class="p">,</span> <span class="nv">CPL_REALM_COMM</span><span class="p">,</span> <span class="nv">CPL_INTER_COMM</span><span class="p">,</span> <span class="p">&amp;</span> 
								<span class="nv">CPL_CART_COMM</span><span class="p">,</span> <span class="nv">CPL_OLAP_COMM</span><span class="p">,</span> <span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span>   <span class="p">&amp;</span>
								<span class="nv">CPL_REALM_INTERSECTION_COMM</span><span class="p">,</span> <span class="nv">md_realm</span><span class="p">,</span><span class="nv">cfd_realm</span><span class="p">,</span> <span class="p">&amp;</span>
                                <span class="nv">rank_world2rank_mdcart</span><span class="p">,</span>     <span class="p">&amp;</span>
                                <span class="nv">rank_world2rank_cfdcart</span><span class="p">,</span>    <span class="p">&amp;</span>
                                <span class="nv">rank_mdrealm2rank_world</span><span class="p">,</span>    <span class="p">&amp;</span>
                                <span class="nv">rank_cfdrealm2rank_world</span><span class="p">,</span>    <span class="p">&amp;</span>
                                <span class="nv">rank_olap2rank_world</span><span class="p">,</span>    <span class="p">&amp;</span>
                                <span class="nv">rank_graph2rank_world</span><span class="p">,</span> <span class="p">&amp;</span>
								<span class="nv">rank2coord_cfd</span><span class="p">,</span>	<span class="nv">rank2coord_md</span><span class="p">,</span> <span class="p">&amp;</span>
								<span class="nv">COUPLER_ERROR_CART_COMM</span><span class="p">,</span> <span class="nv">VOID</span><span class="p">,</span> <span class="nv">nproc_cfd</span><span class="p">,</span><span class="nv">nproc_md</span><span class="p">,</span> <span class="p">&amp;</span> 
								<span class="nv">error_abort</span>
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>		<span class="kd">::</span> <span class="nv">COMM</span><span class="p">,</span> <span class="nv">realm</span><span class="p">,</span> <span class="nv">rank</span><span class="p">,</span> <span class="nv">maxdims</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>	<span class="kd">::</span> <span class="nv">coords</span><span class="p">(</span><span class="nv">maxdims</span><span class="p">),</span> <span class="nv">ierr</span>

	<span class="kt">integer</span>					<span class="kd">::</span> <span class="nv">worldrank</span><span class="p">,</span> <span class="nv">cartrank</span>

	<span class="c">!Get rank in world COMM from current COMM</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">COMM</span> <span class="ow">.eq.</span> <span class="nv">CPL_WORLD_COMM</span><span class="p">)</span> <span class="k">then</span>
		<span class="c">! -  -  -  -  -  -  -  -  -  -  -  -  -</span>
		<span class="nv">worldrank</span> <span class="o">=</span> <span class="nv">rank</span>
		<span class="c">! -  -  -  -  -  -  -  -  -  -  -  -  -</span>
	<span class="nv">elseif</span><span class="p">(</span><span class="nv">COMM</span> <span class="ow">.eq.</span> <span class="nv">CPL_REALM_COMM</span><span class="p">)</span> <span class="k">then</span>
		<span class="c">! -  -  -  -  -  -  -  -  -  -  -  -  -</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">cfd_realm</span><span class="p">)</span> <span class="k">then</span>
<span class="k">			if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">rank_cfdrealm2rank_world</span><span class="p">)</span> <span class="ow">.eqv.</span> <span class="nb">.false.</span><span class="p">)</span> <span class="k">then</span>
<span class="k">				call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
								 <span class="s2">&quot;Setup not complete for CFD CPL_REALM_COMM&quot;</span><span class="p">)</span>
			<span class="nv">elseif</span> <span class="p">(</span><span class="nv">rank</span> <span class="ow">.gt.</span> <span class="nv">size</span><span class="p">(</span><span class="nv">rank_cfdrealm2rank_world</span><span class="p">))</span> <span class="k">then</span>
<span class="k">				print</span><span class="o">*</span><span class="p">,</span> <span class="s1">&#39;rank = &#39;</span><span class="p">,</span> <span class="nv">rank</span><span class="p">,</span> <span class="s1">&#39;comm size = &#39;</span><span class="p">,</span> <span class="nv">size</span><span class="p">(</span><span class="nv">rank_cfdrealm2rank_world</span><span class="p">)</span>
				<span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error -Specified rank is not in CFD realm&quot;</span><span class="p">)</span>
			<span class="k">endif</span>
<span class="k">			</span><span class="nv">worldrank</span> <span class="o">=</span> <span class="nv">rank_cfdrealm2rank_world</span><span class="p">(</span><span class="nv">rank</span><span class="p">)</span>
		<span class="nv">elseif</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">md_realm</span><span class="p">)</span> <span class="k">then</span>
<span class="k">			if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">rank_mdrealm2rank_world</span><span class="p">)</span> <span class="ow">.eqv.</span> <span class="nb">.false.</span><span class="p">)</span> <span class="k">then</span>
<span class="k">				call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - Setup not &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
								 <span class="s2">&quot;complete for MD CPL_REALM_COMM&quot;</span><span class="p">)</span>
			<span class="nv">elseif</span> <span class="p">(</span><span class="nv">rank</span> <span class="ow">.gt.</span> <span class="nv">size</span><span class="p">(</span><span class="nv">rank_mdrealm2rank_world</span><span class="p">))</span> <span class="k">then</span>
<span class="k">				print</span><span class="o">*</span><span class="p">,</span> <span class="s1">&#39;rank = &#39;</span><span class="p">,</span> <span class="nv">rank</span><span class="p">,</span> <span class="s1">&#39;comm size = &#39;</span><span class="p">,</span> <span class="nv">size</span><span class="p">(</span><span class="nv">rank_cfdrealm2rank_world</span><span class="p">)</span>
				<span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error -Specified rank &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
								 <span class="s2">&quot;is not in MD realm&quot;</span><span class="p">)</span>
			<span class="k">endif</span>
<span class="k">			</span><span class="nv">worldrank</span> <span class="o">=</span> <span class="nv">rank_mdrealm2rank_world</span><span class="p">(</span><span class="nv">rank</span><span class="p">)</span>
		<span class="k">endif</span>
		<span class="c">! -  -  -  -  -  -  -  -  -  -  -  -  -</span>
	<span class="nv">elseif</span><span class="p">(</span><span class="nv">COMM</span> <span class="ow">.eq.</span> <span class="nv">CPL_CART_COMM</span><span class="p">)</span> <span class="k">then</span>
		<span class="c">! -  -  -  -  -  -  -  -  -  -  -  -  -</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">cfd_realm</span><span class="p">)</span> <span class="k">then</span>
<span class="k">			if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">rank2coord_cfd</span><span class="p">)</span> <span class="ow">.eqv.</span> <span class="nb">.false.</span><span class="p">)</span> <span class="p">&amp;</span>
				<span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - Setup not complete&quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
								 <span class="s2">&quot; for CFD CPL_CART_COMM&quot;</span><span class="p">)</span>
			<span class="nv">coords</span> <span class="o">=</span> <span class="nv">rank2coord_cfd</span><span class="p">(:,</span><span class="nv">rank</span><span class="p">)</span>
		<span class="nv">elseif</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">md_realm</span><span class="p">)</span> <span class="k">then</span>
<span class="k">			if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">rank2coord_md</span><span class="p">)</span> <span class="ow">.eqv.</span> <span class="nb">.false.</span><span class="p">)</span> <span class="p">&amp;</span>
				<span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - Setup not complete &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
								 <span class="s2">&quot;for MD CPL_CART_COMM&quot;</span><span class="p">)</span>
			<span class="nv">coords</span> <span class="o">=</span> <span class="nv">rank2coord_md</span><span class="p">(:,</span><span class="nv">rank</span><span class="p">)</span>
		<span class="k">endif</span>
<span class="k">		return</span>
		<span class="c">! -  -  -  -  -  -  -  -  -  -  -  -  -</span>
	<span class="nv">elseif</span><span class="p">(</span><span class="nv">COMM</span> <span class="ow">.eq.</span> <span class="nv">CPL_OLAP_COMM</span><span class="p">)</span> <span class="k">then</span>
		<span class="c">! -  -  -  -  -  -  -  -  -  -  -  -  -</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">rank_olap2rank_world</span><span class="p">)</span> <span class="ow">.eqv.</span> <span class="nb">.false.</span><span class="p">)</span> <span class="k">then</span>
<span class="k">			call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - Setup not complete for CPL_OLAP_COMM&quot;</span><span class="p">)</span>
		<span class="nv">elseif</span> <span class="p">(</span><span class="nv">rank</span> <span class="ow">.gt.</span> <span class="nv">size</span><span class="p">(</span><span class="nv">rank_olap2rank_world</span><span class="p">))</span> <span class="k">then</span>
<span class="k">			print</span><span class="o">*</span><span class="p">,</span> <span class="s1">&#39;rank = &#39;</span><span class="p">,</span> <span class="nv">rank</span><span class="p">,</span> <span class="s1">&#39;comm size = &#39;</span><span class="p">,</span> <span class="nv">size</span><span class="p">(</span><span class="nv">rank_olap2rank_world</span><span class="p">)</span>
			<span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - Specified rank is not in overlap&quot;</span><span class="p">)</span>
		<span class="k">endif</span>
<span class="k">		</span><span class="nv">worldrank</span> <span class="o">=</span> <span class="nv">rank_olap2rank_world</span><span class="p">(</span><span class="nv">rank</span><span class="p">)</span>
		<span class="c">! -  -  -  -  -  -  -  -  -  -  -  -  -</span>
	<span class="nv">elseif</span><span class="p">(</span><span class="nv">COMM</span> <span class="ow">.eq.</span> <span class="nv">CPL_GRAPH_COMM</span><span class="p">)</span> <span class="k">then</span>
		<span class="c">! -  -  -  -  -  -  -  -  -  -  -  -  -</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">rank_graph2rank_world</span><span class="p">)</span> <span class="ow">.eqv.</span> <span class="nb">.false.</span><span class="p">)</span> <span class="k">then</span>
<span class="k">			call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - Setup not complete for CPL_GRAPH_COMM&quot;</span><span class="p">)</span>
		<span class="nv">elseif</span> <span class="p">(</span><span class="nv">rank</span> <span class="ow">.gt.</span> <span class="nv">size</span><span class="p">(</span><span class="nv">rank_graph2rank_world</span><span class="p">))</span> <span class="k">then</span>
<span class="k">			call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - Specified rank is not in graph&quot;</span><span class="p">)</span>
		<span class="k">endif</span>
<span class="k">		</span><span class="nv">worldrank</span> <span class="o">=</span> <span class="nv">rank_graph2rank_world</span><span class="p">(</span><span class="nv">rank</span><span class="p">)</span>
		<span class="c">! -  -  -  -  -  -  -  -  -  -  -  -  -</span>
	<span class="nv">elseif</span><span class="p">(</span><span class="nv">COMM</span> <span class="ow">.eq.</span> <span class="nv">CPL_REALM_INTERSECTION_COMM</span><span class="p">)</span> <span class="k">then</span>
		<span class="c">! -  -  -  -  -  -  -  -  -  -  -  -  -</span>
		<span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - Intersection COMM not programmed&quot;</span><span class="p">)</span>
		<span class="c">! -  -  -  -  -  -  -  -  -  -  -  -  -</span>

	<span class="nv">elseif</span><span class="p">(</span><span class="nv">COMM</span> <span class="ow">.eq.</span> <span class="nv">CPL_INTER_COMM</span><span class="p">)</span> <span class="k">then</span>
		<span class="c">! -  -  -  -  -  -  -  -  -  -  -  -  -</span>
		<span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - Intercomm between realms id&quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
								 <span class="s2">&quot; - use realm comms instead&quot;</span><span class="p">)</span>
		<span class="nv">ierr</span> <span class="o">=</span> <span class="nv">COUPLER_ERROR_CART_COMM</span> 
		<span class="k">return</span>
		<span class="c">! -  -  -  -  -  -  -  -  -  -  -  -  -</span>
	<span class="k">else</span> 
		<span class="c">! -  -  -  -  -  -  -  -  -  -  -  -  -</span>
		<span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - Unknown COMM&quot;</span><span class="p">)</span>
		<span class="nv">ierr</span> <span class="o">=</span> <span class="nv">COUPLER_ERROR_CART_COMM</span> 
		<span class="k">return</span>
		<span class="c">! -  -  -  -  -  -  -  -  -  -  -  -  -</span>
	<span class="k">endif</span>
	
	<span class="c">!Get rank in realm cartesian communicator</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">cfd_realm</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">rank_world2rank_cfdcart</span><span class="p">)</span> <span class="ow">.eqv.</span> <span class="nb">.false.</span><span class="p">)</span> <span class="k">then</span>
<span class="k">			call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - world to cart mapping &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
								 <span class="s2">&quot;not initialised correctly&quot;</span><span class="p">)</span>
		<span class="k">endif</span>
<span class="k">		</span><span class="nv">cartrank</span> <span class="o">=</span> <span class="nv">rank_world2rank_cfdcart</span><span class="p">(</span><span class="nv">worldrank</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">cartrank</span> <span class="ow">.eq.</span> <span class="nv">VOID</span><span class="p">)</span> <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - void element in mapping&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">cartrank</span> <span class="ow">.gt.</span> <span class="nv">nproc_cfd</span><span class="p">)</span> <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - rank not in cfd realm&quot;</span><span class="p">)</span>
	<span class="nv">elseif</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">md_realm</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="nv">rank_world2rank_mdcart</span><span class="p">)</span> <span class="ow">.eqv.</span> <span class="nb">.false.</span><span class="p">)</span> <span class="k">then</span>
<span class="k">			call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - world to cart &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
								 <span class="s2">&quot;mapping not initialised correctly&quot;</span><span class="p">)</span>
		<span class="k">endif</span>
<span class="k">		</span><span class="nv">cartrank</span> <span class="o">=</span> <span class="nv">rank_world2rank_mdcart</span><span class="p">(</span><span class="nv">worldrank</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">cartrank</span> <span class="ow">.eq.</span> <span class="nv">VOID</span><span class="p">)</span> <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - void element in mapping&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">cartrank</span> <span class="ow">.gt.</span> <span class="nv">nproc_md</span><span class="p">)</span> <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - rank not in md realm&quot;</span><span class="p">)</span>
	<span class="k">endif</span>

	<span class="c">!Get cartesian coordinate in appropriate realm</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">cfd_realm</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		</span><span class="nv">coords</span> <span class="o">=</span> <span class="nv">rank2coord_cfd</span><span class="p">(:,</span><span class="nv">cartrank</span><span class="p">)</span>
	<span class="nv">elseif</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">md_realm</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		</span><span class="nv">coords</span> <span class="o">=</span> <span class="nv">rank2coord_md</span><span class="p">(:,</span><span class="nv">cartrank</span><span class="p">)</span>
	<span class="k">endif</span>

	<span class="c">!Success</span>
	<span class="nv">ierr</span> <span class="o">=</span> <span class="mi">0</span>
 
<span class="k">end subroutine </span><span class="nv">CPL_Cart_coords</span>

<span class="c">!-------------------------------------------------------------------</span>
<span class="c">! 					CPL_get_rank					   -</span>
<span class="c">!-------------------------------------------------------------------</span>
<span class="c">!&gt;</span>
<span class="c">!! Return rank of current processor in specified COMM </span>
<span class="c">!!</span>
<span class="c">!! - Synopsis</span>
<span class="c">!!</span>
<span class="c">!!  - CPL_get_rank(COMM, rank)</span>
<span class="c">!!</span>
<span class="c">!! - Input Parameters</span>
<span class="c">!!</span>
<span class="c">!!  - comm</span>
<span class="c">!!   - communicator with cartesian structure (handle) </span>
<span class="c">!!</span>
<span class="c">!! - Output Parameter</span>
<span class="c">!!</span>
<span class="c">!!  - rank</span>
<span class="c">!!   - rank of a process within group of comm (integer) </span>
<span class="c">!!      NOTE fortran convention rank=1 to nproc</span>
<span class="c">!!</span>
<span class="c">!! @author Edward Smith</span>

<span class="k">subroutine </span><span class="nv">CPL_get_rank</span><span class="p">(</span><span class="nv">COMM</span><span class="p">,</span><span class="nv">rank</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span>  <span class="nv">CPL_WORLD_COMM</span><span class="p">,</span> <span class="nv">CPL_REALM_COMM</span><span class="p">,</span> <span class="nv">CPL_INTER_COMM</span><span class="p">,</span> <span class="p">&amp;</span> 
								<span class="nv">CPL_CART_COMM</span><span class="p">,</span>  <span class="nv">CPL_OLAP_COMM</span><span class="p">,</span>  <span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span> <span class="p">&amp;</span>
								<span class="nv">CPL_REALM_INTERSECTION_COMM</span><span class="p">,</span><span class="nv">rank_world</span><span class="p">,</span>			<span class="p">&amp;</span>
								<span class="nv">rank_realm</span><span class="p">,</span><span class="nv">rank_cart</span><span class="p">,</span><span class="nv">rank_olap</span><span class="p">,</span><span class="nv">rank_graph</span><span class="p">,</span><span class="nv">error_abort</span>

	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>		<span class="kd">::</span> <span class="nv">COMM</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span> 	<span class="kd">::</span> <span class="nv">rank</span>

	<span class="c">!Get rank in world COMM from current COMM</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">COMM</span> <span class="ow">.eq.</span> <span class="nv">CPL_WORLD_COMM</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		</span><span class="nv">rank</span> <span class="o">=</span> <span class="nv">rank_world</span>
		<span class="k">return</span>
<span class="k">	</span><span class="nv">elseif</span><span class="p">(</span><span class="nv">COMM</span> <span class="ow">.eq.</span> <span class="nv">CPL_REALM_COMM</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		</span><span class="nv">rank</span> <span class="o">=</span> <span class="nv">rank_realm</span>
		<span class="k">return</span>
<span class="k">	</span><span class="nv">elseif</span><span class="p">(</span><span class="nv">COMM</span> <span class="ow">.eq.</span> <span class="nv">CPL_CART_COMM</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		</span><span class="nv">rank</span> <span class="o">=</span> <span class="nv">rank_cart</span>
		<span class="k">return</span>
<span class="k">	</span><span class="nv">elseif</span><span class="p">(</span><span class="nv">COMM</span> <span class="ow">.eq.</span> <span class="nv">CPL_OLAP_COMM</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		</span><span class="nv">rank</span> <span class="o">=</span> <span class="nv">rank_olap</span>
		<span class="k">return</span>
<span class="k">	</span><span class="nv">elseif</span><span class="p">(</span><span class="nv">COMM</span> <span class="ow">.eq.</span> <span class="nv">CPL_GRAPH_COMM</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		</span><span class="nv">rank</span> <span class="o">=</span> <span class="nv">rank_graph</span>
		<span class="k">return</span>
<span class="k">	</span><span class="nv">elseif</span><span class="p">(</span><span class="nv">COMM</span> <span class="ow">.eq.</span> <span class="nv">CPL_REALM_INTERSECTION_COMM</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - Intersection COMM not programmed&quot;</span><span class="p">)</span>
	<span class="nv">elseif</span><span class="p">(</span><span class="nv">COMM</span> <span class="ow">.eq.</span> <span class="nv">CPL_INTER_COMM</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - No rank in Intercomm&quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
								 <span class="s2">&quot; - use realm comms instead&quot;</span><span class="p">)</span>
	<span class="k">else </span>
<span class="k">		call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CPL_Cart_coords Error - Unknown COMM&quot;</span><span class="p">)</span>
	<span class="k">endif</span>
<span class="k">	</span>

<span class="k">end subroutine </span><span class="nv">CPL_get_rank</span>


<span class="c">!-------------------------------------------------------------------</span>
<span class="c">! 					CPL_olap_check										   -</span>
<span class="c">!-------------------------------------------------------------------</span>
<span class="c">!&gt;</span>
<span class="c">!! Check if current processor is in the overlap region</span>
<span class="c">!!</span>
<span class="c">!! - Synopsis</span>
<span class="c">!!</span>
<span class="c">!!  - CPL_olap_check()</span>
<span class="c">!!</span>
<span class="c">!! - Input Parameters</span>
<span class="c">!!</span>
<span class="c">!!  - NONE</span>
<span class="c">!!</span>
<span class="c">!! - Returns</span>
<span class="c">!!</span>
<span class="c">!!  - CPL_olap_check</span>
<span class="c">!!	 - True if calling processor is in the overlap region</span>
<span class="c">!!     and false otherwise</span>
<span class="c">!!</span>
<span class="c">!! @author Edward Smith</span>


<span class="k">function </span><span class="nv">CPL_overlap</span><span class="p">()</span> <span class="nv">result</span><span class="p">(</span><span class="nv">p</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> <span class="nv">olap_mask</span><span class="p">,</span> <span class="nv">rank_world</span>
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">logical</span>	<span class="kd">::</span> <span class="nv">p</span>

	<span class="nv">p</span> <span class="o">=</span> <span class="nv">olap_mask</span><span class="p">(</span><span class="nv">rank_world</span><span class="p">)</span>

<span class="k">end function </span><span class="nv">CPL_overlap</span>


<span class="c">!============================================================================</span>
<span class="c">!</span>
<span class="c">! Utility functions and subroutines that extract parameters from internal modules </span>
<span class="c">!</span>
<span class="c">!-----------------------------------------------------------------------------    </span>

<span class="c">!-------------------------------------------------------------------</span>
<span class="c">! 					CPL_get										   -</span>
<span class="c">!-------------------------------------------------------------------</span>
<span class="c">!&gt;</span>
<span class="c">!! Wrapper to retrieve (read only) parameters from the coupler_module </span>
<span class="c">!! Note - this ensures all variable in the coupler are protected</span>
<span class="c">!! from corruption by either CFD or MD codes</span>
<span class="c">!!</span>
<span class="c">!! - Synopsis</span>
<span class="c">!!</span>
<span class="c">!!  - CPL_get([see coupler_module])</span>
<span class="c">!!</span>
<span class="c">!! - Input Parameters</span>
<span class="c">!!</span>
<span class="c">!!  - NONE</span>
<span class="c">!!</span>
<span class="c">!! - Output Parameter</span>
<span class="c">!!</span>
<span class="c">!!  - @see coupler_module</span>
<span class="c">!!</span>
<span class="c">!! @author Edward Smith</span>

<span class="k">subroutine </span><span class="nv">CPL_get</span><span class="p">(</span><span class="nv">icmax_olap</span><span class="p">,</span><span class="nv">icmin_olap</span><span class="p">,</span><span class="nv">jcmax_olap</span><span class="p">,</span><span class="nv">jcmin_olap</span><span class="p">,</span>  <span class="p">&amp;</span> 
                   <span class="nv">kcmax_olap</span><span class="p">,</span><span class="nv">kcmin_olap</span><span class="p">,</span><span class="nv">density_cfd</span><span class="p">,</span><span class="nv">density_md</span><span class="p">,</span> <span class="p">&amp;</span>
                   <span class="nv">dt_cfd</span><span class="p">,</span><span class="nv">dt_MD</span><span class="p">,</span><span class="nv">dx</span><span class="p">,</span><span class="nv">dy</span><span class="p">,</span><span class="nv">dz</span><span class="p">,</span><span class="nv">ncx</span><span class="p">,</span><span class="nv">ncy</span><span class="p">,</span><span class="nv">ncz</span><span class="p">,</span><span class="nv">xg</span><span class="p">,</span><span class="nv">yg</span><span class="p">,</span><span class="nv">zg</span><span class="p">,</span>	 <span class="p">&amp;</span>
                   <span class="nv">xL_md</span><span class="p">,</span><span class="nv">xL_cfd</span><span class="p">,</span><span class="nv">yL_md</span><span class="p">,</span><span class="nv">yL_cfd</span><span class="p">,</span><span class="nv">zL_md</span><span class="p">,</span><span class="nv">zL_cfd</span><span class="p">,</span>       <span class="p">&amp;</span>
                   <span class="nv">constraint_algo</span><span class="p">,</span> <span class="nv">constraint_CVflag</span><span class="p">,</span>           <span class="p">&amp;</span>
                   <span class="nv">constraint_OT</span><span class="p">,</span> <span class="nv">constraint_NCER</span><span class="p">,</span>               <span class="p">&amp;</span>
                   <span class="nv">constraint_Flekkoy</span><span class="p">,</span> <span class="nv">constraint_off</span><span class="p">,</span>           <span class="p">&amp;</span>
                   <span class="nv">constraint_CV</span><span class="p">,</span>                                <span class="p">&amp;</span>
                   <span class="nv">icmin_cnst</span><span class="p">,</span> <span class="nv">icmax_cnst</span><span class="p">,</span>                       <span class="p">&amp;</span>
                   <span class="nv">jcmin_cnst</span><span class="p">,</span> <span class="nv">jcmax_cnst</span><span class="p">,</span>                       <span class="p">&amp;</span>
                   <span class="nv">kcmin_cnst</span><span class="p">,</span> <span class="nv">kcmax_cnst</span><span class="p">,</span>                       <span class="p">&amp;</span>
                   <span class="nv">md_cfd_match_cellsize</span><span class="p">,</span> <span class="nv">staggered_averages</span><span class="p">,</span>    <span class="p">&amp;</span>
                   <span class="nv">cpl_cfd_bc_slice</span><span class="p">,</span> <span class="nv">cpl_md_bc_slice</span><span class="p">,</span>            <span class="p">&amp;</span>
                   <span class="nv">cpl_cfd_bc_x</span><span class="p">,</span> <span class="nv">cpl_cfd_bc_y</span><span class="p">,</span> <span class="nv">cpl_cfd_bc_z</span><span class="p">,</span>     <span class="p">&amp;</span>
                   <span class="nv">timestep_ratio</span><span class="p">,</span> <span class="nv">comm_style</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> 	<span class="nv">icmax_olap_</span><span class="o">=&gt;</span><span class="nv">icmax_olap</span><span class="p">,</span>         <span class="p">&amp;</span>
	                            <span class="nv">icmin_olap_</span><span class="o">=&gt;</span><span class="nv">icmin_olap</span><span class="p">,</span>         <span class="p">&amp;</span>
	                            <span class="nv">jcmax_olap_</span><span class="o">=&gt;</span><span class="nv">jcmax_olap</span><span class="p">,</span>         <span class="p">&amp;</span>
	                            <span class="nv">jcmin_olap_</span><span class="o">=&gt;</span><span class="nv">jcmin_olap</span><span class="p">,</span>         <span class="p">&amp;</span>
	                            <span class="nv">kcmax_olap_</span><span class="o">=&gt;</span><span class="nv">kcmax_olap</span><span class="p">,</span>         <span class="p">&amp;</span>
	                            <span class="nv">kcmin_olap_</span><span class="o">=&gt;</span><span class="nv">kcmin_olap</span><span class="p">,</span>         <span class="p">&amp;</span>
	                            <span class="nv">density_cfd_</span><span class="o">=&gt;</span><span class="nv">density_cfd</span><span class="p">,</span>       <span class="p">&amp;</span>             
	                            <span class="nv">density_md_</span><span class="o">=&gt;</span><span class="nv">density_md</span><span class="p">,</span>         <span class="p">&amp;</span>
	                            <span class="nv">dt_cfd_</span><span class="o">=&gt;</span><span class="nv">dt_cfd</span><span class="p">,</span><span class="nv">dt_MD_</span><span class="o">=&gt;</span><span class="nv">dt_MD</span><span class="p">,</span>   <span class="p">&amp;</span>
	                            <span class="nv">dx_</span><span class="o">=&gt;</span><span class="nv">dx</span><span class="p">,</span><span class="nv">dy_</span><span class="o">=&gt;</span><span class="nv">dy</span><span class="p">,</span><span class="nv">dz_</span><span class="o">=&gt;</span><span class="nv">dz</span><span class="p">,</span>         <span class="p">&amp;</span>
	                            <span class="nv">ncx_</span><span class="o">=&gt;</span><span class="nv">ncx</span><span class="p">,</span><span class="nv">ncy_</span><span class="o">=&gt;</span> <span class="nv">ncy</span><span class="p">,</span><span class="nv">ncz_</span><span class="o">=&gt;</span> <span class="nv">ncz</span><span class="p">,</span> <span class="p">&amp;</span>
	                            <span class="nv">xL_md_</span> <span class="o">=&gt;</span><span class="nv">xL_md</span><span class="p">,</span>                  <span class="p">&amp;</span>
	                            <span class="nv">yL_md_</span> <span class="o">=&gt;</span><span class="nv">yL_md</span><span class="p">,</span>                  <span class="p">&amp;</span>
	                            <span class="nv">zL_md_</span> <span class="o">=&gt;</span><span class="nv">zL_md</span><span class="p">,</span>                  <span class="p">&amp;</span>
	                            <span class="nv">xL_cfd_</span><span class="o">=&gt;</span> <span class="nv">xL_cfd</span><span class="p">,</span>                <span class="p">&amp;</span>
	                            <span class="nv">yL_cfd_</span><span class="o">=&gt;</span> <span class="nv">yL_cfd</span><span class="p">,</span>                <span class="p">&amp;</span>
	                            <span class="nv">zL_cfd_</span><span class="o">=&gt;</span> <span class="nv">zL_cfd</span><span class="p">,</span>                <span class="p">&amp;</span>
	                            <span class="nv">xg_</span><span class="o">=&gt;</span><span class="nv">xg</span><span class="p">,</span> <span class="nv">yg_</span><span class="o">=&gt;</span> <span class="nv">yg</span><span class="p">,</span> <span class="nv">zg_</span><span class="o">=&gt;</span> <span class="nv">zg</span><span class="p">,</span>     <span class="p">&amp;</span>
								<span class="nv">timestep_ratio_</span> <span class="o">=&gt;</span> <span class="nv">timestep_ratio</span><span class="p">,</span> <span class="p">&amp;</span>
	                            <span class="nv">md_cfd_match_cellsize_</span> <span class="o">=&gt;</span> <span class="nv">md_cfd_match_cellsize</span><span class="p">,</span> <span class="p">&amp;</span>
								<span class="nv">staggered_averages_</span> <span class="o">=&gt;</span> <span class="nv">staggered_averages</span><span class="p">,</span> <span class="p">&amp;</span>
                                <span class="nv">constraint_algo_</span> <span class="o">=&gt;</span> <span class="nv">constraint_algo</span><span class="p">,</span>       <span class="p">&amp;</span>
	                            <span class="nv">constraint_CVflag_</span> <span class="o">=&gt;</span> <span class="nv">constraint_CVflag</span><span class="p">,</span>   <span class="p">&amp;</span>
	                            <span class="nv">constraint_OT_</span> <span class="o">=&gt;</span> <span class="nv">constraint_OT</span><span class="p">,</span>           <span class="p">&amp;</span>
	                            <span class="nv">constraint_NCER_</span> <span class="o">=&gt;</span> <span class="nv">constraint_NCER</span><span class="p">,</span>       <span class="p">&amp;</span> 
	                            <span class="nv">constraint_Flekkoy_</span> <span class="o">=&gt;</span> <span class="nv">constraint_Flekkoy</span><span class="p">,</span> <span class="p">&amp;</span>
	                            <span class="nv">constraint_CV_</span> <span class="o">=&gt;</span> <span class="nv">constraint_CV</span><span class="p">,</span>           <span class="p">&amp;</span>
	                            <span class="nv">constraint_off_</span> <span class="o">=&gt;</span> <span class="nv">constraint_off</span><span class="p">,</span>         <span class="p">&amp;</span>
	                            <span class="nv">icmin_cnst_</span> <span class="o">=&gt;</span> <span class="nv">icmin_cnst</span><span class="p">,</span> <span class="p">&amp;</span>
	                            <span class="nv">icmax_cnst_</span> <span class="o">=&gt;</span> <span class="nv">icmax_cnst</span><span class="p">,</span> <span class="p">&amp;</span>
	                            <span class="nv">jcmin_cnst_</span> <span class="o">=&gt;</span> <span class="nv">jcmin_cnst</span><span class="p">,</span> <span class="p">&amp;</span>
	                            <span class="nv">jcmax_cnst_</span> <span class="o">=&gt;</span> <span class="nv">jcmax_cnst</span><span class="p">,</span> <span class="p">&amp;</span>
	                            <span class="nv">kcmin_cnst_</span> <span class="o">=&gt;</span> <span class="nv">kcmin_cnst</span><span class="p">,</span> <span class="p">&amp;</span>
                                <span class="nv">kcmax_cnst_</span> <span class="o">=&gt;</span> <span class="nv">kcmax_cnst</span><span class="p">,</span> <span class="p">&amp;</span>
                                <span class="nv">cpl_cfd_bc_slice_</span> <span class="o">=&gt;</span> <span class="nv">cpl_cfd_bc_slice</span><span class="p">,</span> <span class="p">&amp;</span>
                                <span class="nv">cpl_md_bc_slice_</span> <span class="o">=&gt;</span> <span class="nv">cpl_md_bc_slice</span><span class="p">,</span> <span class="p">&amp;</span>
                                <span class="nv">cpl_cfd_bc_x_</span> <span class="o">=&gt;</span> <span class="nv">cpl_cfd_bc_x</span><span class="p">,</span> <span class="p">&amp;</span>
                                <span class="nv">cpl_cfd_bc_y_</span> <span class="o">=&gt;</span> <span class="nv">cpl_cfd_bc_y</span><span class="p">,</span> <span class="p">&amp;</span>
                                <span class="nv">cpl_cfd_bc_z_</span> <span class="o">=&gt;</span> <span class="nv">cpl_cfd_bc_z</span><span class="p">,</span> <span class="p">&amp;</span>
                                <span class="nv">comm_style_</span> <span class="o">=&gt;</span> <span class="nv">comm_style</span><span class="p">,</span> <span class="p">&amp;</span>
                                <span class="nv">comm_style_send_recv_</span> <span class="o">=&gt;</span> <span class="nv">comm_style_send_recv</span><span class="p">,</span> <span class="p">&amp;</span>
                                <span class="nv">comm_style_gath_scat_</span> <span class="o">=&gt;</span> <span class="nv">comm_style_gath_scat</span>
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">logical</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="k">optional</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">staggered_averages</span>

	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>			<span class="kd">::</span> <span class="nv">icmax_olap</span> <span class="p">,</span><span class="nv">icmin_olap</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>			<span class="kd">::</span> <span class="nv">jcmax_olap</span> <span class="p">,</span><span class="nv">jcmin_olap</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>			<span class="kd">::</span> <span class="nv">kcmax_olap</span> <span class="p">,</span><span class="nv">kcmin_olap</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>			<span class="kd">::</span> <span class="nv">ncx</span><span class="p">,</span><span class="nv">ncy</span><span class="p">,</span><span class="nv">ncz</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>			<span class="kd">::</span> <span class="nv">md_cfd_match_cellsize</span><span class="p">,</span><span class="nv">timestep_ratio</span>

	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>          <span class="kd">::</span> <span class="nv">constraint_algo</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>          <span class="kd">::</span> <span class="nv">constraint_CVflag</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>          <span class="kd">::</span> <span class="nv">constraint_OT</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>          <span class="kd">::</span> <span class="nv">constraint_NCER</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>          <span class="kd">::</span> <span class="nv">constraint_Flekkoy</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>          <span class="kd">::</span> <span class="nv">constraint_CV</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>          <span class="kd">::</span> <span class="nv">constraint_off</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>          <span class="kd">::</span> <span class="nv">comm_style</span> 
	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>			<span class="kd">::</span> <span class="nv">icmax_cnst</span><span class="p">,</span> <span class="nv">icmin_cnst</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>			<span class="kd">::</span> <span class="nv">jcmax_cnst</span><span class="p">,</span> <span class="nv">jcmin_cnst</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>			<span class="kd">::</span> <span class="nv">kcmax_cnst</span><span class="p">,</span> <span class="nv">kcmin_cnst</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>          <span class="kd">::</span> <span class="nv">cpl_cfd_bc_slice</span> 
    <span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>          <span class="kd">::</span> <span class="nv">cpl_cfd_bc_x</span> 
    <span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>          <span class="kd">::</span> <span class="nv">cpl_cfd_bc_y</span> 
    <span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>          <span class="kd">::</span> <span class="nv">cpl_cfd_bc_z</span> 
    <span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>          <span class="kd">::</span> <span class="nv">cpl_md_bc_slice</span> 

	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>	<span class="kd">::</span> <span class="nv">density_cfd</span><span class="p">,</span><span class="nv">density_md</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">dt_cfd</span><span class="p">,</span><span class="nv">dt_MD</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">dx</span><span class="p">,</span><span class="nv">dy</span><span class="p">,</span><span class="nv">dz</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">xL_md</span><span class="p">,</span><span class="nv">xL_cfd</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">yL_md</span><span class="p">,</span><span class="nv">yL_cfd</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">zL_md</span><span class="p">,</span><span class="nv">zL_cfd</span>

	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">dimension</span><span class="p">(:,:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">optional</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">xg</span><span class="p">,</span><span class="nv">yg</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">dimension</span><span class="p">(:)</span>  <span class="p">,</span><span class="k">allocatable</span><span class="p">,</span><span class="k">optional</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">zg</span>

	<span class="c">!Overlap extents</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">icmax_olap</span><span class="p">))</span> <span class="nv">icmax_olap</span> <span class="o">=</span> <span class="nv">icmax_olap_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">icmin_olap</span><span class="p">))</span> <span class="nv">icmin_olap</span> <span class="o">=</span> <span class="nv">icmin_olap_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">jcmax_olap</span><span class="p">))</span> <span class="nv">jcmax_olap</span> <span class="o">=</span> <span class="nv">jcmax_olap_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">jcmin_olap</span><span class="p">))</span> <span class="nv">jcmin_olap</span> <span class="o">=</span> <span class="nv">jcmin_olap_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">kcmax_olap</span><span class="p">))</span> <span class="nv">kcmax_olap</span> <span class="o">=</span> <span class="nv">kcmax_olap_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">kcmin_olap</span><span class="p">))</span> <span class="nv">kcmin_olap</span> <span class="o">=</span> <span class="nv">kcmin_olap_</span>

	<span class="c">!Density</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">density_cfd</span><span class="p">))</span> <span class="nv">density_cfd</span> <span class="o">=</span> <span class="nv">density_cfd_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">density_md</span> <span class="p">))</span> <span class="nv">density_md</span>  <span class="o">=</span> <span class="nv">density_md_</span>

	<span class="c">!Cells</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">ncx</span><span class="p">))</span> <span class="nv">ncx</span> <span class="o">=</span> <span class="nv">ncx_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">ncy</span><span class="p">))</span> <span class="nv">ncy</span> <span class="o">=</span> <span class="nv">ncy_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">ncz</span><span class="p">))</span> <span class="nv">ncz</span> <span class="o">=</span> <span class="nv">ncz_</span>
			
	<span class="c">!Temporal and spatial steps</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">dt_cfd</span><span class="p">))</span> <span class="nv">dt_cfd</span><span class="o">=</span> <span class="nv">dt_cfd_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">dt_MD</span> <span class="p">))</span> <span class="nv">dt_MD</span> <span class="o">=</span> <span class="nv">dt_MD_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">dx</span><span class="p">))</span> <span class="nv">dx</span> <span class="o">=</span> <span class="nv">dx_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">dy</span><span class="p">))</span> <span class="nv">dy</span> <span class="o">=</span> <span class="nv">dy_</span>	
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">dz</span><span class="p">))</span> <span class="nv">dz</span> <span class="o">=</span> <span class="nv">dz_</span>

	<span class="c">!Domain sizes</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">xL_md</span> <span class="p">))</span> <span class="nv">xL_md</span> <span class="o">=</span> <span class="nv">xL_md_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">xL_cfd</span><span class="p">))</span> <span class="nv">xL_cfd</span><span class="o">=</span> <span class="nv">xL_cfd_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">yL_md</span> <span class="p">))</span> <span class="nv">yL_md</span> <span class="o">=</span> <span class="nv">yL_md_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">yL_cfd</span><span class="p">))</span> <span class="nv">yL_cfd</span><span class="o">=</span> <span class="nv">yL_cfd_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">zL_md</span> <span class="p">))</span> <span class="nv">zL_md</span> <span class="o">=</span> <span class="nv">zL_md_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">zL_cfd</span><span class="p">))</span> <span class="nv">zL_cfd</span><span class="o">=</span> <span class="nv">zL_cfd_</span>
			
	<span class="c">!The mesh</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">xg</span><span class="p">))</span> <span class="k">then</span>
<span class="k">		allocate</span><span class="p">(</span><span class="nv">xg</span><span class="p">(</span><span class="nv">size</span><span class="p">(</span><span class="nv">xg_</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="nv">size</span><span class="p">(</span><span class="nv">xg_</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
		<span class="nv">xg</span> <span class="o">=</span> <span class="nv">xg_</span>
	<span class="k">endif</span>
<span class="k">	if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">yg</span><span class="p">))</span> <span class="k">then</span>
<span class="k">		allocate</span><span class="p">(</span><span class="nv">yg</span><span class="p">(</span><span class="nv">size</span><span class="p">(</span><span class="nv">yg_</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="nv">size</span><span class="p">(</span><span class="nv">yg_</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
		<span class="nv">yg</span> <span class="o">=</span> <span class="nv">yg_</span>
	<span class="k">endif</span>
<span class="k">	if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">zg</span><span class="p">))</span> <span class="k">then</span>
<span class="k">		allocate</span><span class="p">(</span><span class="nv">zg</span><span class="p">(</span><span class="nv">size</span><span class="p">(</span><span class="nv">zg_</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
		<span class="nv">zg</span> <span class="o">=</span> <span class="nv">zg_</span>
	<span class="k">endif</span>

	<span class="c">!Coupler input parameters</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">staggered_averages</span><span class="p">))</span> <span class="nv">staggered_averages</span> <span class="o">=</span> <span class="nv">staggered_averages_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">timestep_ratio</span><span class="p">))</span> <span class="nv">timestep_ratio</span> <span class="o">=</span> <span class="nv">timestep_ratio_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">md_cfd_match_cellsize</span><span class="p">))</span> <span class="k">then</span>
<span class="k">		</span><span class="nv">md_cfd_match_cellsize</span> <span class="o">=</span> <span class="nv">md_cfd_match_cellsize_</span>
	<span class="k">end if</span>

	<span class="c">! Constraint information</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">constraint_algo</span><span class="p">))</span> <span class="nv">constraint_algo</span> <span class="o">=</span> <span class="nv">constraint_algo_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">constraint_CVflag</span><span class="p">))</span> <span class="nv">constraint_CVflag</span> <span class="o">=</span> <span class="nv">constraint_CVflag_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">constraint_OT</span><span class="p">))</span> <span class="nv">constraint_OT</span> <span class="o">=</span> <span class="nv">constraint_OT_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">constraint_NCER</span><span class="p">))</span> <span class="nv">constraint_NCER</span> <span class="o">=</span> <span class="nv">constraint_NCER_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">constraint_Flekkoy</span><span class="p">))</span> <span class="nv">constraint_Flekkoy</span> <span class="o">=</span> <span class="nv">constraint_Flekkoy_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">constraint_CV</span><span class="p">))</span> <span class="nv">constraint_CV</span> <span class="o">=</span> <span class="nv">constraint_CV_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">constraint_off</span><span class="p">))</span> <span class="nv">constraint_off</span> <span class="o">=</span> <span class="nv">constraint_off_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">icmin_cnst</span><span class="p">))</span> <span class="nv">icmin_cnst</span> <span class="o">=</span> <span class="nv">icmin_cnst_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">icmax_cnst</span><span class="p">))</span> <span class="nv">icmax_cnst</span> <span class="o">=</span> <span class="nv">icmax_cnst_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">jcmin_cnst</span><span class="p">))</span> <span class="nv">jcmin_cnst</span> <span class="o">=</span> <span class="nv">jcmin_cnst_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">jcmax_cnst</span><span class="p">))</span> <span class="nv">jcmax_cnst</span> <span class="o">=</span> <span class="nv">jcmax_cnst_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">kcmin_cnst</span><span class="p">))</span> <span class="nv">kcmin_cnst</span> <span class="o">=</span> <span class="nv">kcmin_cnst_</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">kcmax_cnst</span><span class="p">))</span> <span class="nv">kcmax_cnst</span> <span class="o">=</span> <span class="nv">kcmax_cnst_</span>

    <span class="c">! Communication style</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">comm_style</span><span class="p">))</span> <span class="nv">comm_style</span> <span class="o">=</span> <span class="nv">comm_style_</span>

    <span class="c">! Coupling styles</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">cpl_cfd_bc_slice</span><span class="p">))</span> <span class="nv">cpl_cfd_bc_slice</span> <span class="o">=</span> <span class="nv">cpl_cfd_bc_slice_</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">cpl_md_bc_slice</span><span class="p">))</span> <span class="nv">cpl_md_bc_slice</span> <span class="o">=</span> <span class="nv">cpl_md_bc_slice_</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">cpl_cfd_bc_x</span><span class="p">))</span> <span class="nv">cpl_cfd_bc_x</span> <span class="o">=</span> <span class="nv">cpl_cfd_bc_x_</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">cpl_cfd_bc_y</span><span class="p">))</span> <span class="nv">cpl_cfd_bc_y</span> <span class="o">=</span> <span class="nv">cpl_cfd_bc_y_</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">cpl_cfd_bc_z</span><span class="p">))</span> <span class="nv">cpl_cfd_bc_z</span> <span class="o">=</span> <span class="nv">cpl_cfd_bc_z_</span>
<span class="k">end subroutine </span><span class="nv">CPL_get</span>


<span class="k">function </span><span class="nv">CPL_comm_style</span><span class="p">()</span>
    <span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span><span class="p">:</span> <span class="nv">comm_style</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">CPL_comm_style</span>
    
    <span class="nv">CPL_comm_style</span> <span class="o">=</span> <span class="nv">comm_style</span>

<span class="k">end function</span>

<span class="c">! Function to get cuurent realm</span>
<span class="k">function </span><span class="nv">CPL_realm</span><span class="p">()</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> <span class="nv">realm</span>
	<span class="k">implicit none</span>
<span class="k">	</span>
<span class="k">	</span><span class="kt">integer</span>	<span class="kd">::</span> <span class="nv">CPL_realm</span>

	<span class="nv">CPL_realm</span> <span class="o">=</span> <span class="nv">realm</span>

<span class="k">end function</span>


<span class="c">!=============================================================================</span>
<span class="c">!&gt; Get molecule&#39;s global position from position local to processor.</span>
<span class="c">!-----------------------------------------------------------------------------</span>
<span class="k">function </span><span class="nv">globalise</span><span class="p">(</span><span class="nv">r</span><span class="p">)</span> <span class="nv">result</span><span class="p">(</span><span class="nv">rg</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> 	<span class="nv">xLl</span><span class="p">,</span><span class="nv">iblock_realm</span><span class="p">,</span><span class="nv">npx_md</span><span class="p">,</span> <span class="p">&amp;</span> 
								<span class="nv">yLl</span><span class="p">,</span><span class="nv">jblock_realm</span><span class="p">,</span><span class="nv">npy_md</span><span class="p">,</span> <span class="p">&amp;</span> 
								<span class="nv">zLl</span><span class="p">,</span><span class="nv">kblock_realm</span><span class="p">,</span><span class="nv">npz_md</span>
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">r</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">))</span>			<span class="kd">::</span> <span class="nv">rg</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

	<span class="nv">rg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nv">r</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="nv">d0</span><span class="o">*</span><span class="nv">xLl</span><span class="o">*</span><span class="p">(</span><span class="nv">npx_md</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nv">xLl</span><span class="o">*</span><span class="p">(</span><span class="nv">iblock_realm</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="nv">rg</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="nv">r</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="nv">d0</span><span class="o">*</span><span class="nv">yLl</span><span class="o">*</span><span class="p">(</span><span class="nv">npy_md</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nv">yLl</span><span class="o">*</span><span class="p">(</span><span class="nv">jblock_realm</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="nv">rg</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="nv">r</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="nv">d0</span><span class="o">*</span><span class="nv">zLl</span><span class="o">*</span><span class="p">(</span><span class="nv">npz_md</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nv">zLl</span><span class="o">*</span><span class="p">(</span><span class="nv">kblock_realm</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">end function </span><span class="nv">globalise</span>

<span class="c">!=============================================================================</span>
<span class="c">!&gt; Get local position on processor from molecule&#39;s global position.</span>
<span class="c">!-----------------------------------------------------------------------------</span>
<span class="k">function </span><span class="nv">localise</span><span class="p">(</span><span class="nv">r</span><span class="p">)</span> <span class="nv">result</span><span class="p">(</span><span class="nv">rg</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> 	<span class="nv">xLl</span><span class="p">,</span><span class="nv">iblock_realm</span><span class="p">,</span><span class="nv">npx_md</span><span class="p">,</span> <span class="p">&amp;</span> 
								<span class="nv">yLl</span><span class="p">,</span><span class="nv">jblock_realm</span><span class="p">,</span><span class="nv">npy_md</span><span class="p">,</span> <span class="p">&amp;</span> 
								<span class="nv">zLl</span><span class="p">,</span><span class="nv">kblock_realm</span><span class="p">,</span><span class="nv">npz_md</span>
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">r</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">))</span> <span class="nv">rg</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

	<span class="c">!Global domain has origin at centre</span>
	<span class="nv">rg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nv">r</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nv">xLl</span><span class="o">*</span><span class="p">(</span><span class="nv">iblock_realm</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="nv">d0</span><span class="o">*</span><span class="nv">xLl</span><span class="o">*</span><span class="p">(</span><span class="nv">npx_md</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="nv">rg</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="nv">r</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nv">yLl</span><span class="o">*</span><span class="p">(</span><span class="nv">jblock_realm</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="nv">d0</span><span class="o">*</span><span class="nv">yLl</span><span class="o">*</span><span class="p">(</span><span class="nv">npy_md</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="nv">rg</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="nv">r</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="nv">zLl</span><span class="o">*</span><span class="p">(</span><span class="nv">kblock_realm</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="nv">d0</span><span class="o">*</span><span class="nv">zLl</span><span class="o">*</span><span class="p">(</span><span class="nv">npz_md</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">end function </span><span class="nv">localise</span>

<span class="c">!=============================================================================</span>
<span class="c">!&gt; Map global MD position to global CFD coordinate frame</span>
<span class="c">!-----------------------------------------------------------------------------</span>
<span class="k">function </span><span class="nv">map_md2cfd_global</span><span class="p">(</span><span class="nv">r</span><span class="p">)</span> <span class="nv">result</span><span class="p">(</span><span class="nv">rg</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> 	<span class="nv">xL_md</span><span class="p">,</span><span class="nv">xg</span><span class="p">,</span><span class="nv">icmin_olap</span><span class="p">,</span><span class="nv">icmax_olap</span><span class="p">,</span> <span class="p">&amp;</span> 
								<span class="nv">yL_md</span><span class="p">,</span><span class="nv">yg</span><span class="p">,</span><span class="nv">jcmin_olap</span><span class="p">,</span><span class="nv">jcmax_olap</span><span class="p">,</span> <span class="p">&amp;</span> 
								<span class="nv">zL_md</span><span class="p">,</span><span class="nv">zg</span><span class="p">,</span><span class="nv">kcmin_olap</span><span class="p">,</span><span class="nv">kcmax_olap</span>
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">r</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">))</span><span class="kd">::</span> <span class="nv">md_only</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="nv">rg</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

	<span class="c">!Get size of MD domain which has no CFD cells overlapping</span>
	<span class="c">!This should be general enough to include grid stretching</span>
	<span class="c">!and total overlap in any directions </span>
	<span class="nv">md_only</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nv">xL_md</span><span class="o">-</span><span class="p">(</span><span class="nv">xg</span><span class="p">(</span><span class="nv">icmax_olap</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nv">xg</span><span class="p">(</span><span class="nv">icmin_olap</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
	<span class="nv">md_only</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="nv">yL_md</span><span class="o">-</span><span class="p">(</span><span class="nv">yg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">jcmax_olap</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nv">yg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">jcmin_olap</span><span class="p">))</span>
	<span class="nv">md_only</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="nv">zL_md</span><span class="o">-</span><span class="p">(</span><span class="nv">zg</span><span class="p">(</span> <span class="nv">kcmax_olap</span><span class="o">+</span><span class="mi">1</span> <span class="p">)</span> <span class="o">-</span> <span class="nv">zg</span><span class="p">(</span> <span class="nv">kcmin_olap</span> <span class="p">))</span>

	<span class="c">! CFD has origin at bottom left while MD origin at centre</span>
	<span class="nv">rg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nv">r</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="nv">d0</span><span class="o">*</span><span class="nv">xL_md</span> <span class="o">-</span> <span class="nv">md_only</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="nv">rg</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="nv">r</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="nv">d0</span><span class="o">*</span><span class="nv">yL_md</span> <span class="o">-</span> <span class="nv">md_only</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
	<span class="nv">rg</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="nv">r</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="nv">d0</span><span class="o">*</span><span class="nv">zL_md</span> <span class="o">-</span> <span class="nv">md_only</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="k">end function </span><span class="nv">map_md2cfd_global</span>


<span class="c">!=============================================================================</span>
<span class="c">!&gt; Map global CFD position in global MD coordinate frame</span>
<span class="c">!-----------------------------------------------------------------------------</span>
<span class="k">function </span><span class="nv">map_cfd2md_global</span><span class="p">(</span><span class="nv">r</span><span class="p">)</span> <span class="nv">result</span><span class="p">(</span><span class="nv">rg</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> 	<span class="nv">xL_md</span><span class="p">,</span><span class="nv">xg</span><span class="p">,</span><span class="nv">icmin_olap</span><span class="p">,</span><span class="nv">icmax_olap</span><span class="p">,</span> <span class="p">&amp;</span> 
								<span class="nv">yL_md</span><span class="p">,</span><span class="nv">yg</span><span class="p">,</span><span class="nv">jcmin_olap</span><span class="p">,</span><span class="nv">jcmax_olap</span><span class="p">,</span> <span class="p">&amp;</span> 
								<span class="nv">zL_md</span><span class="p">,</span><span class="nv">zg</span><span class="p">,</span><span class="nv">kcmin_olap</span><span class="p">,</span><span class="nv">kcmax_olap</span>
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">r</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">))</span> 			<span class="kd">::</span> <span class="nv">md_only</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="nv">rg</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

	<span class="c">!Get size of MD domain which has no CFD cells overlapping</span>
	<span class="c">!This should be general enough to include grid stretching</span>
	<span class="c">!and total overlap in any directions </span>
	<span class="nv">md_only</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nv">xL_md</span><span class="o">-</span><span class="p">(</span><span class="nv">xg</span><span class="p">(</span><span class="nv">icmax_olap</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nv">xg</span><span class="p">(</span><span class="nv">icmin_olap</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
	<span class="nv">md_only</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="nv">yL_md</span><span class="o">-</span><span class="p">(</span><span class="nv">yg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">jcmax_olap</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nv">yg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">jcmin_olap</span><span class="p">))</span>
	<span class="nv">md_only</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="nv">zL_md</span><span class="o">-</span><span class="p">(</span><span class="nv">zg</span><span class="p">(</span> <span class="nv">kcmax_olap</span><span class="o">+</span><span class="mi">1</span> <span class="p">)</span> <span class="o">-</span> <span class="nv">zg</span><span class="p">(</span> <span class="nv">kcmin_olap</span> <span class="p">))</span>

	<span class="c">! CFD has origin at bottom left while MD origin at centre</span>
	<span class="nv">rg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nv">r</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="nv">d0</span><span class="o">*</span><span class="nv">xL_md</span> <span class="o">+</span> <span class="nv">md_only</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="nv">rg</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="nv">r</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="nv">d0</span><span class="o">*</span><span class="nv">yL_md</span> <span class="o">+</span> <span class="nv">md_only</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
	<span class="nv">rg</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="nv">r</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="nv">d0</span><span class="o">*</span><span class="nv">zL_md</span> <span class="o">+</span> <span class="nv">md_only</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="k">end function </span><span class="nv">map_cfd2md_global</span>

<span class="c">!-----------------------------------------------------------------------------</span>
 
<span class="k">function </span><span class="nv">coupler_md_get_save_period</span><span class="p">()</span> <span class="nv">result</span><span class="p">(</span><span class="nv">p</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> <span class="nv">save_period</span>
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">integer </span><span class="nv">p</span>
	<span class="nv">p</span> <span class="o">=</span> <span class="nv">save_period</span>

<span class="k">end function </span><span class="nv">coupler_md_get_save_period</span>

<span class="c">!----------------------------------------------------------------------------- </span>

<span class="k">function </span><span class="nv">coupler_md_get_average_period</span><span class="p">()</span> <span class="nv">result</span><span class="p">(</span><span class="nv">p</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> <span class="nv">average_period</span>
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">integer </span><span class="nv">p</span>
	<span class="nv">p</span> <span class="o">=</span> <span class="nv">average_period</span>

<span class="k">end function </span><span class="nv">coupler_md_get_average_period</span>

<span class="c">!----------------------------------------------------------------------------- </span>

<span class="k">function </span><span class="nv">coupler_md_get_md_steps_per_cfd_dt</span><span class="p">()</span> <span class="nv">result</span><span class="p">(</span><span class="nv">p</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> <span class="nv">timestep_ratio</span> 
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">integer </span><span class="nv">p</span>
	<span class="nv">p</span> <span class="o">=</span> <span class="nv">timestep_ratio</span> 

<span class="k">end function </span><span class="nv">coupler_md_get_md_steps_per_cfd_dt</span>

<span class="c">!-----------------------------------------------------------------------------</span>

<span class="k">function </span><span class="nv">coupler_md_get_nsteps</span><span class="p">()</span> <span class="nv">result</span><span class="p">(</span><span class="nv">p</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span>  <span class="nv">nsteps_md</span>
	<span class="k">implicit none </span>

<span class="k">	 </span><span class="kt">integer </span><span class="nv">p</span>
	 <span class="nv">p</span> <span class="o">=</span> <span class="nv">nsteps_md</span>

<span class="k">end function </span><span class="nv">coupler_md_get_nsteps</span>

<span class="c">!-----------------------------------------------------------------------------</span>

<span class="k">function </span><span class="nv">coupler_md_get_dt_cfd</span><span class="p">()</span> <span class="nv">result</span><span class="p">(</span><span class="nv">p</span><span class="p">)</span>
	<span class="k">use </span><span class="nv">coupler_module</span><span class="p">,</span> <span class="nv">only</span> <span class="p">:</span> <span class="nv">dt_CFD</span>  
	<span class="k">implicit none</span>

<span class="k">	</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">))</span> <span class="nv">p</span>
	<span class="nv">p</span> <span class="o">=</span> <span class="nv">dt_CFD</span>

<span class="k">end function </span><span class="nv">coupler_md_get_dt_cfd</span>

<span class="c">!------------------------------------------------------------------------------</span>

<span class="k">end module </span><span class="nv">coupler</span>
</pre></div>

    </section>
    </div>
  </div>

    <hr>
    <footer>
        <div class="row">
        <div class="col-md-6">&copy; 2015 Fortran Program was written by Edward Smith
David Trevelyan. </div>
        <div class="col-md-6"><span class="pull-right">Documentation generated by <a href="https://github.com/cmacmackin/ford">FORD</a>.</span></div>
        </div>
        <br>
    </footer>
    </div> <!-- /container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],
        'HTML-CSS': { 
           styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: '#000000 ! important'} }
        }
      });
    </script>
    <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </body>
</html>