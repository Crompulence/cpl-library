<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	 
	 <meta name="description" content="<p>Details of interfaces and subroutine of the cpl-library including source code</p>">
    
    <meta name="author" content="Chris MacMackin" >
    <link rel="icon" href="../favicon.png">

    <title>coupler_module.f90 &ndash; Fortran Program</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">Fortran Program </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
				
                
            <li><a href="../lists/files.html">Source Files</a></li>
				
				
            <li><a href="../lists/modules.html">Modules</a></li>
				
				
            <li><a href="../lists/procedures.html">Procedures</a></li>
				
								
				
          </ul>
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>coupler_module.f90
    <small>Source File</small>
    
    </h1>
	 
<div class="row">
<div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
    <li><i class="fa fa-code"></i><a href="../src/coupler_module.f90"> Source File</a></li>
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
     <li class="active">coupler_module.f90</li>
  </ol>
  </div>
</div>
    
  </div>
  <div class="row">
    <div class="col-lg-3">
    
  
  
  
  
  
  
  <div class="panel panel-primary">
    <div class="panel-heading text-left"><h3 class="panel-title">Modules</h3></div>
    <div class="list-group">
      
      <a class="list-group-item" href="../module/coupler_module.html">coupler_module</a>
      
    </div>
  </div>
  
  
  
  
  
  
  
  
  
  
  
  <div class="panel panel-primary">
    <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
    <div class="list-group">
      <a class="list-group-item" href="../sourcefile/coupler_module.f90.html#src">coupler_module.f90</a>
    </div>
  </div>
  
  <hr>
  
  <div class="panel panel-default">
    <div class="panel-heading text-left"><h3 class="panel-title">All Source Files</h3></div>
    <div class="list-group">
      
      <a class="list-group-item" href="../sourcefile/coupler.f90.html">coupler.f90</a>
      
      <a class="list-group-item" href="../sourcefile/coupler_module.f90.html">coupler_module.f90</a>
      
    </div>
  </div>
  
  
    </div>
    <div class="col-lg-9" id='text'>
    <p>COUPLER MODULE: 
 A single coupler module for both codes - this contains the same information 
 on both md and cfd side </p>
<ul>
<li>Error handling</li>
<li>MPI communicators</li>
<li>Simulation realms</li>
<li>MPI processor IDs</li>
<li>Processor topologies</li>
<li>Processor cartesian coords</li>
<li>Global cell grid parameters</li>
<li>Processor cell ranges</li>
<li>Domain and cell dimensions</li>
<li>Positions of CFD grid lines</li>
<li>CFD to MD processor mapping</li>
<li>Simulation parameters</li>
</ul>
<p>The data is protected so only setup routines in this module can change it</p>
<p>Setup routines which have access to coupler parameters</p>
<ul>
<li>
<p>CPL_create_comm          (cfd+md)   splits MPI_COMM_WORLD, create inter - 
                                       communicator between CFD and MD</p>
</li>
<li>
<p>CPL_create_map           (cfd+md)   creates correspondence maps between 
                                       the CFD grid and MD domains</p>
</li>
<li>
<p>CPL_cfd_adjust_domain     (cfd)     adjust CFD tomain to an integer number 
                                       FCC or similar MD initial layout</p>
</li>
</ul>
<p>@author David Trevelyan, Edward Smith
 @see coupler</p>
    <br>
    <section>
    <h2><a class="anchor" name="src"></a>Source Code</h2>
    <div class="highlight"><pre><span class="c">!</span>
<span class="c">!    ________/\\\\\\\\\__/\\\\\\\\\\\\\____/\\\_____________</span>
<span class="c">!     _____/\\\////////__\/\\\/////////\\\_\/\\\_____________</span>
<span class="c">!      ___/\\\/___________\/\\\_______\/\\\_\/\\\_____________</span>
<span class="c">!       __/\\\_____________\/\\\\\\\\\\\\\/__\/\\\_____________</span>
<span class="c">!        _\/\\\_____________\/\\\/////////____\/\\\_____________</span>
<span class="c">!         _\//\\\____________\/\\\_____________\/\\\_____________</span>
<span class="c">!          __\///\\\__________\/\\\_____________\/\\\_____________</span>
<span class="c">!           ____\////\\\\\\\\\_\/\\\_____________\/\\\\\\\\\\\\\\\_</span>
<span class="c">!            _______\/////////__\///______________\///////////////__</span>
<span class="c">!</span>
<span class="c">!</span>
<span class="c">!                         C P L  -  L I B R A R Y</span>
<span class="c">!</span>
<span class="c">!           Copyright (C) 2012-2015 Edward Smith &amp; David Trevelyan</span>
<span class="c">!</span>
<span class="c">!License</span>
<span class="c">!</span>
<span class="c">!    This file is part of CPL-Library.</span>
<span class="c">!</span>
<span class="c">!    CPL-Library is free software: you can redistribute it and/or modify</span>
<span class="c">!    it under the terms of the GNU General Public License as published by</span>
<span class="c">!    the Free Software Foundation, either version 3 of the License, or</span>
<span class="c">!    (at your option) any later version.</span>
<span class="c">!</span>
<span class="c">!    CPL-Library is distributed in the hope that it will be useful,</span>
<span class="c">!    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c">!    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c">!    GNU General Public License for more details.</span>
<span class="c">!</span>
<span class="c">!    You should have received a copy of the GNU General Public License</span>
<span class="c">!    along with CPL-Library.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c">!</span>
<span class="c">!</span>
<span class="c">!Description</span>
<span class="c">!</span>
<span class="c">!</span>
<span class="c">!! COUPLER MODULE: </span>
<span class="c">!! A single coupler module for both codes - this contains the same information </span>
<span class="c">!! on both md and cfd side </span>
<span class="c">!!</span>
<span class="c">!!  - Error handling</span>
<span class="c">!!  - MPI communicators</span>
<span class="c">!!  - Simulation realms</span>
<span class="c">!!  - MPI processor IDs</span>
<span class="c">!!  - Processor topologies</span>
<span class="c">!!  - Processor cartesian coords</span>
<span class="c">!!  - Global cell grid parameters</span>
<span class="c">!!  - Processor cell ranges</span>
<span class="c">!!  - Domain and cell dimensions</span>
<span class="c">!!  - Positions of CFD grid lines</span>
<span class="c">!!  - CFD to MD processor mapping</span>
<span class="c">!!  - Simulation parameters</span>
<span class="c">!!</span>
<span class="c">!! The data is protected so only setup routines in this module can change it</span>
<span class="c">!</span>
<span class="c">!</span>
<span class="c">!</span>
<span class="c">!  SETUP SETUP SETUP SETUP SETUP SETUP SETUP SETUP SETUP SETUP SETUP SETUP </span>
<span class="c">!  -----------------------------------------------------------------------</span>
<span class="c">!</span>
<span class="c">!! Setup routines which have access to coupler parameters</span>
<span class="c">!!</span>
<span class="c">!! - CPL_create_comm          (cfd+md)   splits MPI_COMM_WORLD, create inter - </span>
<span class="c">!!                                       communicator between CFD and MD</span>
<span class="c">!!</span>
<span class="c">!! - CPL_create_map           (cfd+md)   creates correspondence maps between </span>
<span class="c">!!                                       the CFD grid and MD domains</span>
<span class="c">!!</span>
<span class="c">!! - CPL_cfd_adjust_domain     (cfd)     adjust CFD tomain to an integer number </span>
<span class="c">!!                                       FCC or similar MD initial layout</span>
<span class="c">!</span>
<span class="c">!! @author David Trevelyan, Edward Smith</span>
<span class="c">!! @see coupler</span>
<span class="c">!=============================================================================</span>

<span class="k">module </span><span class="nv">coupler_module</span>
    <span class="k">USE </span><span class="nv">ISO_C_BINDING</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="nv">VOID</span><span class="o">=-</span><span class="mi">666</span>         <span class="c">!!VOID value for data initialisation</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="nv">cfd_realm</span> <span class="o">=</span> <span class="mi">1</span>     <span class="c">!! CFD realm identifier</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="nv">md_realm</span>  <span class="o">=</span> <span class="mi">2</span>     <span class="c">!! MD realm identifier</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">parameter</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">realm_name</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="s2">&quot;CFD&quot;</span><span class="p">,</span> <span class="s2">&quot;MD &quot;</span> <span class="o">/</span><span class="p">)</span>  <span class="c">!! Used with realm identifier to get name</span>

    <span class="c">!! error codes</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="p">&amp;</span> 
        <span class="nv">COUPLER_ERROR_REALM</span>  <span class="o">=</span> <span class="mi">1</span>        <span class="c">!! wrong realm value</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="p">&amp;</span> 
        <span class="nv">COUPLER_ERROR_ONE_REALM</span>  <span class="o">=</span> <span class="mi">2</span>    <span class="c">!! one realm missing</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="p">&amp;</span> 
        <span class="nv">COUPLER_ERROR_INIT</span>       <span class="o">=</span> <span class="mi">3</span>    <span class="c">!! initialisation error</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="p">&amp;</span> 
        <span class="nv">COUPLER_ERROR_INPUT_FILE</span> <span class="o">=</span> <span class="mi">4</span>    <span class="c">!! wrong value in input file</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="p">&amp;</span> 
        <span class="nv">COUPLER_ERROR_READ_INPUT</span> <span class="o">=</span> <span class="mi">5</span>    <span class="c">!! error in processing input file or data transfers</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="p">&amp;</span> 
        <span class="nv">COUPLER_ERROR_CONTINUUM_FORCE</span> <span class="o">=</span> <span class="mi">6</span>   <span class="c">!!the region in which the continuum constrain force is apply spans over two MD domains</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="p">&amp;</span> 
        <span class="nv">COUPLER_ABORT_ON_REQUEST</span> <span class="o">=</span> <span class="mi">7</span>    <span class="c">!! used in request_abort </span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="p">&amp;</span> 
        <span class="nv">COUPLER_ABORT_SEND_CFD</span>   <span class="o">=</span> <span class="mi">8</span>    <span class="c">!! error in coupler_cfd_send</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="p">&amp;</span> 
        <span class="nv">COUPLER_ERROR_CART_COMM</span>   <span class="o">=</span> <span class="mi">9</span>   <span class="c">!! Wrong comm value in CPL_Cart_coords</span>

    <span class="c">!! MPI error flag</span>
    <span class="kt">integer</span>     <span class="kd">::</span> <span class="nv">ierr</span> 

    <span class="c">! MPI Communicators</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">CPL_WORLD_COMM</span> <span class="c">!! Copy of MPI_COMM_WORLD, both CFD and MD realms;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">CPL_REALM_COMM</span> <span class="c">!! INTRA communicators within MD/CFD realms;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">CPL_INTER_COMM</span> <span class="c">!!  CFD/MD INTER communicator between realm comms;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">CPL_CART_COMM</span> <span class="c">!!  Comm w/cartesian topology for each realm;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">CPL_OLAP_COMM</span> <span class="c">!!  Local comm between only overlapping MD/CFD procs;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">CPL_GRAPH_COMM</span> <span class="c">!!  Comm w/ graph topolgy between locally olapg procs;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">CPL_REALM_INTERSECTION_COMM</span> <span class="c">!!  Intersecting MD/CFD procs in world;</span>

    <span class="c">!! Simulation realms</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">realm</span>

    <span class="c">! MPI processor IDs</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">myid_world</span>   <span class="c">!! Processor ID from 0 to nproc_world-1;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">rank_world</span>   <span class="c">!! Processor rank from 1 to nproc_world;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">rootid_world</span> <span class="c">!! Root processor in world;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">myid_realm</span>   <span class="c">!! Processor ID from 0 to nproc_realm-1;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">rank_realm</span>   <span class="c">!! Processor rank from 1 to nproc_realm;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">rootid_realm</span> <span class="c">!! Root processor in each realm;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">myid_cart</span>   <span class="c">!! Processor ID from 0 to nproc_cart-1;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">rank_cart</span>   <span class="c">!! Processor rank from 1 to nproc_cart;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">rootid_cart</span> <span class="c">!! Root processor in each cart topology;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">myid_olap</span>   <span class="c">!! Processor ID from 0 to nproc_olap-1;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">rank_olap</span>   <span class="c">!! Processor rank from 1 to nproc_olap;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">CFDid_olap</span>  <span class="c">!! Root processor in overlap is the CFD processor;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">myid_graph</span>  <span class="c">!! Processor ID from 0 to nproc_graph-1;</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">rank_graph</span>  <span class="c">!! Processor rank from 1 to nproc_graph;</span>

    <span class="c">!! Get rank in CPL_world_COMM from rank in local COMM</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span>    <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">rank_world2rank_mdrealm</span><span class="p">,</span>    <span class="p">&amp;</span>
        <span class="nv">rank_world2rank_mdcart</span><span class="p">,</span>     <span class="p">&amp;</span>
        <span class="nv">rank_world2rank_cfdrealm</span><span class="p">,</span>   <span class="p">&amp;</span>
        <span class="nv">rank_world2rank_cfdcart</span><span class="p">,</span>    <span class="p">&amp;</span>
        <span class="nv">rank_world2rank_olap</span><span class="p">,</span>       <span class="p">&amp;</span>
        <span class="nv">rank_world2rank_graph</span><span class="p">,</span>      <span class="p">&amp;</span>
        <span class="nv">rank_world2rank_inter</span>

    <span class="c">!! Get rank in local COMM from rank in CPL_world_COMM</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span>    <span class="kd">::</span> <span class="p">&amp;</span>
         <span class="nv">rank_mdrealm2rank_world</span><span class="p">,</span>    <span class="p">&amp;</span>
          <span class="nv">rank_mdcart2rank_world</span><span class="p">,</span>    <span class="p">&amp;</span>
        <span class="nv">rank_cfdrealm2rank_world</span><span class="p">,</span>    <span class="p">&amp;</span>
         <span class="nv">rank_cfdcart2rank_world</span><span class="p">,</span>    <span class="p">&amp;</span>
            <span class="nv">rank_olap2rank_world</span><span class="p">,</span>    <span class="p">&amp;</span>
           <span class="nv">rank_graph2rank_world</span><span class="p">,</span>    <span class="p">&amp;</span>
           <span class="nv">rank_inter2rank_world</span><span class="p">,</span>    <span class="p">&amp;</span>
            <span class="nv">rank_olap2rank_realm</span>


    <span class="c">! Processor topologies</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">nproc_md</span>     <span class="c">!! Total number of processor in md</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">nproc_cfd</span>    <span class="c">!! Total number of processor in cfd</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">nproc_olap</span>   <span class="c">!! Total number of processor in overlap region</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">nproc_world</span>  <span class="c">!! Total number of processor in world</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">npx_md</span>       <span class="c">!! Number of processor in x in the md</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">npy_md</span>       <span class="c">!! Number of processor in y in the md</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">npz_md</span>       <span class="c">!! Number of processor in z in the md</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">npx_cfd</span>      <span class="c">!! Number of processor in x in the cfd</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">npy_cfd</span>      <span class="c">!! Number of processor in y in the cfd</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">npz_cfd</span>      <span class="c">!! Number of processor in z in the cfd</span>

    <span class="kt">logical</span><span class="p">,</span><span class="nv">protected</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">olap_mask</span>           <span class="c">!! Overlap mask specifying which processors overlap using world ranks</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">rank2coord_cfd</span><span class="p">,</span>   <span class="p">&amp;</span>   <span class="c">!! Array containing coordinates for each cartesian rank </span>
        <span class="nv">rank2coord_md</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,:,:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">coord2rank_cfd</span><span class="p">,</span>   <span class="p">&amp;</span>
        <span class="nv">coord2rank_md</span>

    <span class="c">!! Processor cartesian coords   </span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">iblock_realm</span><span class="p">,</span>     <span class="p">&amp;</span>
        <span class="nv">jblock_realm</span><span class="p">,</span>     <span class="p">&amp;</span>
        <span class="nv">kblock_realm</span>

    <span class="c">! Global cell grid parameters</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">ncx</span><span class="p">,</span>              <span class="p">&amp;</span>    <span class="c">! Number of cells in domain</span>
        <span class="nv">ncy</span><span class="p">,</span>              <span class="p">&amp;</span>
        <span class="nv">ncz</span><span class="p">,</span>              <span class="p">&amp;</span>
        <span class="nv">icmin</span><span class="p">,</span>            <span class="p">&amp;</span>    <span class="c">! Domain cell extents</span>
        <span class="nv">icmax</span><span class="p">,</span>            <span class="p">&amp;</span>
        <span class="nv">jcmin</span><span class="p">,</span>            <span class="p">&amp;</span>
        <span class="nv">jcmax</span><span class="p">,</span>            <span class="p">&amp;</span>
        <span class="nv">kcmin</span><span class="p">,</span>            <span class="p">&amp;</span>
        <span class="nv">kcmax</span><span class="p">,</span>            <span class="p">&amp;</span>
        <span class="nv">icmin_olap</span><span class="p">,</span>       <span class="p">&amp;</span>    <span class="c">! Overlap region cell extents</span>
        <span class="nv">icmax_olap</span><span class="p">,</span>       <span class="p">&amp;</span>
        <span class="nv">jcmin_olap</span><span class="p">,</span>       <span class="p">&amp;</span>
        <span class="nv">jcmax_olap</span><span class="p">,</span>       <span class="p">&amp;</span>
        <span class="nv">kcmin_olap</span><span class="p">,</span>       <span class="p">&amp;</span>
        <span class="nv">kcmax_olap</span><span class="p">,</span>       <span class="p">&amp;</span>
        <span class="nv">ncx_olap</span><span class="p">,</span>         <span class="p">&amp;</span>    <span class="c">! Number of cells in overlap region</span>
        <span class="nv">ncy_olap</span><span class="p">,</span>         <span class="p">&amp;</span>
        <span class="nv">ncz_olap</span>

    <span class="c">! Constrained dynamics region flags and params</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">constraint_algo</span><span class="p">,</span>  <span class="p">&amp;</span>
        <span class="nv">constraint_CVflag</span><span class="p">,&amp;</span>
        <span class="nv">icmin_cnst</span><span class="p">,</span>       <span class="p">&amp;</span>    <span class="c">! Constrained dynamics region cell extents</span>
        <span class="nv">icmax_cnst</span><span class="p">,</span>       <span class="p">&amp;</span>
        <span class="nv">jcmin_cnst</span><span class="p">,</span>       <span class="p">&amp;</span>
        <span class="nv">jcmax_cnst</span><span class="p">,</span>       <span class="p">&amp;</span>
        <span class="nv">kcmin_cnst</span><span class="p">,</span>       <span class="p">&amp;</span>
        <span class="nv">kcmax_cnst</span>

    <span class="c">! Coupling CFD boundary condition direction flags</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">cpl_cfd_bc_x</span><span class="p">,</span> <span class="p">&amp;</span>
        <span class="nv">cpl_cfd_bc_y</span><span class="p">,</span> <span class="p">&amp;</span>
        <span class="nv">cpl_cfd_bc_z</span>
    
    <span class="c">! Coupling constrained regions, average MD quantities </span>
    <span class="c">! in spanwise direction (flags)</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">cpl_md_bc_slice</span><span class="p">,</span> <span class="p">&amp;</span>
        <span class="nv">cpl_cfd_bc_slice</span> <span class="c">! (average MD values, not CFD)</span>

    <span class="c">! Constraint parameters </span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">constraint_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>          <span class="p">&amp;</span>
        <span class="nv">constraint_OT</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>           <span class="p">&amp;</span>
        <span class="nv">constraint_NCER</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>         <span class="p">&amp;</span>
        <span class="nv">constraint_Flekkoy</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>      <span class="p">&amp;</span>
        <span class="nv">constraint_CV</span> <span class="o">=</span> <span class="mi">4</span>   
    <span class="c">! Processor cell ranges </span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">icPmin_md</span><span class="p">,</span>        <span class="p">&amp;</span>
        <span class="nv">icPmax_md</span><span class="p">,</span>        <span class="p">&amp;</span>
        <span class="nv">jcPmin_md</span><span class="p">,</span>        <span class="p">&amp;</span>
        <span class="nv">jcPmax_md</span><span class="p">,</span>        <span class="p">&amp;</span>
        <span class="nv">kcPmin_md</span><span class="p">,</span>        <span class="p">&amp;</span>
        <span class="nv">kcPmax_md</span><span class="p">,</span>        <span class="p">&amp;</span>
        <span class="nv">icPmin_cfd</span><span class="p">,</span>       <span class="p">&amp;</span>
        <span class="nv">icPmax_cfd</span><span class="p">,</span>       <span class="p">&amp;</span>
        <span class="nv">jcPmin_cfd</span><span class="p">,</span>       <span class="p">&amp;</span>
        <span class="nv">jcPmax_cfd</span><span class="p">,</span>       <span class="p">&amp;</span>
        <span class="nv">kcPmin_cfd</span><span class="p">,</span>       <span class="p">&amp;</span>
        <span class="nv">kcPmax_cfd</span>
    
    <span class="c">! Domain and cell dimensions</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">xL_md</span><span class="p">,</span>            <span class="p">&amp;</span>
        <span class="nv">yL_md</span><span class="p">,</span>            <span class="p">&amp;</span>
        <span class="nv">zL_md</span><span class="p">,</span>            <span class="p">&amp;</span>
        <span class="nv">xL_cfd</span><span class="p">,</span>           <span class="p">&amp;</span>
        <span class="nv">yL_cfd</span><span class="p">,</span>           <span class="p">&amp;</span>
        <span class="nv">zL_cfd</span><span class="p">,</span>           <span class="p">&amp;</span>
        <span class="nv">xL_olap</span><span class="p">,</span>          <span class="p">&amp;</span>
        <span class="nv">yL_olap</span><span class="p">,</span>          <span class="p">&amp;</span>
        <span class="nv">zL_olap</span><span class="p">,</span>          <span class="p">&amp;</span>
        <span class="nv">xLl</span><span class="p">,</span>              <span class="p">&amp;</span>
        <span class="nv">yLl</span><span class="p">,</span>              <span class="p">&amp;</span>
        <span class="nv">zLl</span><span class="p">,</span>              <span class="p">&amp;</span>
        <span class="nv">dx</span><span class="p">,</span>               <span class="p">&amp;</span>
        <span class="nv">dy</span><span class="p">,</span>               <span class="p">&amp;</span>
        <span class="nv">dz</span><span class="p">,</span>               <span class="p">&amp;</span>
        <span class="nv">dymin</span><span class="p">,</span>            <span class="p">&amp;</span>
        <span class="nv">dymax</span>

    <span class="c">! Positions of CFD grid lines</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="nv">protected</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,:),</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">target</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">xg</span><span class="p">,</span>               <span class="p">&amp;</span>
        <span class="nv">yg</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="nv">protected</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:)</span>  <span class="p">,</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">target</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">zg</span>

    <span class="c">! CFD to MD processor mapping</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">cfd_icoord2olap_md_icoords</span><span class="p">,</span> <span class="p">&amp;</span>
        <span class="nv">cfd_jcoord2olap_md_jcoords</span><span class="p">,</span> <span class="p">&amp;</span>
        <span class="nv">cfd_kcoord2olap_md_kcoords</span>

    <span class="c">! Simulation parameters</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">nsteps_md</span><span class="p">,</span>        <span class="p">&amp;</span> <span class="c">!MD input steps</span>
        <span class="nv">nsteps_cfd</span><span class="p">,</span>       <span class="p">&amp;</span> <span class="c">!CFD input steps</span>
        <span class="nv">nsteps_coupled</span><span class="p">,</span>   <span class="p">&amp;</span> <span class="c">!Total number of steps for coupled simulation</span>
        <span class="nv">average_period</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! average period for averages ( it must come from CFD !!!)</span>
        <span class="nv">save_period</span><span class="o">=</span><span class="mi">10</span>      <span class="c">! save period (corresponts to tplot in CFD, revise please !!!)</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">dt_md</span><span class="p">,</span>            <span class="p">&amp;</span>
        <span class="nv">dt_cfd</span><span class="p">,</span>           <span class="p">&amp;</span>
        <span class="nv">density_md</span><span class="p">,</span>       <span class="p">&amp;</span>
        <span class="nv">density_cfd</span>
    <span class="kt">integer</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">timestep_ratio</span><span class="p">,</span>        <span class="p">&amp;</span>
        <span class="nv">md_cfd_match_cellsize</span><span class="p">,</span> <span class="p">&amp;</span>
        <span class="nv">testval</span>
    <span class="kt">logical</span><span class="p">,</span><span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">staggered_averages</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="nb">.false.</span><span class="p">,</span><span class="nb">.false.</span><span class="p">,</span><span class="nb">.false.</span><span class="o">/</span><span class="p">)</span>
    <span class="c">! Communications style</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="nv">protected</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">comm_style</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="p">&amp;</span>
        <span class="nv">comm_style_send_recv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">&amp;</span>
        <span class="nv">comm_style_gath_scat</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c">!Interface for error handling functions</span>
    <span class="k">interface </span><span class="nv">error_abort</span>
        <span class="k">module </span><span class="nv">procedure</span> <span class="nv">error_abort_s</span><span class="p">,</span> <span class="nv">error_abort_si</span>
    <span class="k">end interface </span><span class="nv">error_abort</span>

    <span class="k">private </span><span class="nv">error_abort_si</span><span class="p">,</span> <span class="nv">error_abort_s</span>

<span class="k">contains</span>

<span class="c">!=============================================================================</span>
<span class="c">!                    _____      _               </span>
<span class="c">!                   /  ___|    | |              </span>
<span class="c">!                   \ `--.  ___| |_ _   _ _ __  </span>
<span class="c">!                    `--. \/ _ \ __| | | | &#39;_ \</span>
<span class="c">!                   /\__/ /  __/ |_| |_| | |_) |</span>
<span class="c">!                   \____/ \___|\__|\__,_| .__/ </span>
<span class="c">!                                        | |    </span>
<span class="c">!                                        |_|    </span>
<span class="c">!=============================================================================</span>

<span class="c">!=============================================================================</span>
<span class="c">!                           coupler_create_comm         </span>
<span class="c">!! (cfd+md) Splits MPI_COMM_WORLD in both the CFD and MD code respectively</span>
<span class="c">!!         and create intercommunicator between CFD and MD</span>
<span class="c">!-----------------------------------------------------------------------------</span>

<span class="k">subroutine </span><span class="nv">CPL_create_comm</span><span class="p">(</span><span class="nv">callingrealm</span><span class="p">,</span> <span class="nv">RETURNED_REALM_COMM</span><span class="p">,</span> <span class="nv">ierror</span><span class="p">)</span>
    <span class="k">use </span><span class="nv">mpi</span>
    <span class="c">!use coupler_module, only : rank_world,myid_world,rootid_world,nproc_world,&amp;</span>
    <span class="c">!                           realm, rank_realm,myid_realm,rootid_realm,ierr,&amp; </span>
    <span class="c">!                           CPL_WORLD_COMM, CPL_REALM_COMM, CPL_INTER_COMM</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">callingrealm</span> <span class="c">! CFD or MD</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span><span class="kd">::</span> <span class="nv">RETURNED_REALM_COMM</span><span class="p">,</span> <span class="nv">ierror</span>

    <span class="c">!Get processor id in world across both realms</span>
    <span class="k">call </span><span class="nv">MPI_comm_rank</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span><span class="nv">myid_world</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="nv">rank_world</span> <span class="o">=</span> <span class="nv">myid_world</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">rootid_world</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">call </span><span class="nv">MPI_comm_size</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span><span class="nv">nproc_world</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">myid_world</span> <span class="ow">.eq.</span> <span class="nv">rootid_world</span><span class="p">)</span> <span class="k">call </span><span class="nv">print_cplheader</span>

    <span class="c">! test if we have a CFD and a MD realm</span>
    <span class="nv">ierror</span><span class="o">=</span><span class="mi">0</span>
    <span class="c">! Test realms are assigned correctly</span>
    <span class="k">call </span><span class="nv">test_realms</span>    

    <span class="c">! Create intercommunicator between realms       </span>
    <span class="nv">realm</span> <span class="o">=</span> <span class="nv">callingrealm</span>
    <span class="k">call </span><span class="nv">create_comm</span>        

<span class="k">contains</span>

<span class="c">!-----------------------------------------------------------------------------</span>
<span class="c">!   Test if CFD and MD realms are assigned correctly</span>
<span class="c">!-----------------------------------------------------------------------------</span>
<span class="k">subroutine </span><span class="nv">print_cplheader</span>
    <span class="k">implicit none</span>

<span class="k">    print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;                                                                 &quot;</span>
    <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;  ________/\\\\\\\\\__/\\\\\\\\\\\\\____/\\\_____________        &quot;</span>
    <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;   _____/\\\////////__\/\\\/////////\\\_\/\\\_____________       &quot;</span>
    <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;    ___/\\\/___________\/\\\_______\/\\\_\/\\\_____________      &quot;</span>
    <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;     __/\\\_____________\/\\\\\\\\\\\\\/__\/\\\_____________     &quot;</span>
    <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;      _\/\\\_____________\/\\\/////////____\/\\\_____________    &quot;</span>
    <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;       _\//\\\____________\/\\\_____________\/\\\_____________   &quot;</span>
    <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;        __\///\\\__________\/\\\_____________\/\\\_____________  &quot;</span>
    <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;         ____\////\\\\\\\\\_\/\\\_____________\/\\\\\\\\\\\\\\\_ &quot;</span>
    <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;          _______\/////////__\///______________\///////////////__&quot;</span>
    <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;                                                                 &quot;</span>
    <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;                     C P L  -  L I B R A R Y                     &quot;</span>
    <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;                                                                 &quot;</span>

<span class="k">end subroutine </span><span class="nv">print_cplheader</span>

<span class="k">subroutine </span><span class="nv">test_realms</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span>              <span class="kd">::</span> <span class="nv">i</span><span class="p">,</span> <span class="nv">root</span><span class="p">,</span> <span class="nv">nproc</span><span class="p">,</span> <span class="nv">ncfd</span><span class="p">,</span> <span class="nv">nmd</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="nv">realm_list</span><span class="p">(:)</span>

    <span class="c">! Allocate and gather array with realm (MD or CFD) of each </span>
    <span class="c">! processor in the coupled domain on the root processor</span>
    <span class="nv">root</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">rank_world</span> <span class="ow">.eq.</span> <span class="nv">root</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        call </span><span class="nv">MPI_comm_size</span><span class="p">(</span><span class="nv">MPI_comm_world</span><span class="p">,</span> <span class="nv">nproc</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
        <span class="k">allocate</span><span class="p">(</span><span class="nv">realm_list</span><span class="p">(</span><span class="nv">nproc</span><span class="p">))</span>
    <span class="k">else</span>
<span class="k">        allocate</span><span class="p">(</span><span class="nv">realm_list</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">endif</span>
<span class="k">    call </span><span class="nv">MPI_gather</span><span class="p">(</span><span class="nv">callingrealm</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">realm_list</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>

    <span class="c">!Check through array of processors on both realms</span>
    <span class="c">!and return error if wrong values or either is missing</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">rank_world</span> <span class="ow">.eq.</span> <span class="nv">root</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="nv">ncfd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">nmd</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">do </span><span class="nv">i</span> <span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nv">nproc</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nv">realm_list</span><span class="p">(</span><span class="nv">i</span><span class="p">)</span> <span class="ow">.eq.</span> <span class="nv">cfd_realm</span> <span class="p">)</span> <span class="k">then </span>
<span class="k">                </span><span class="nv">ncfd</span> <span class="o">=</span> <span class="nv">ncfd</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else if</span> <span class="p">(</span> <span class="nv">realm_list</span><span class="p">(</span><span class="nv">i</span><span class="p">)</span> <span class="ow">.eq.</span> <span class="nv">md_realm</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">                </span><span class="nv">nmd</span> <span class="o">=</span> <span class="nv">nmd</span> <span class="o">+</span><span class="mi">1</span>
            <span class="k">else</span>
<span class="k">                </span><span class="nv">ierror</span> <span class="o">=</span> <span class="nv">COUPLER_ERROR_REALM</span>
                <span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;wrong realm value in coupler_create_comm&quot;</span>
                <span class="k">call </span><span class="nv">MPI_abort</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span><span class="nv">ierror</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
            <span class="k">endif</span>
<span class="k">        </span><span class="nv">enddo</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nv">ncfd</span> <span class="ow">.eq.</span> <span class="mi">0</span> <span class="ow">.or.</span> <span class="nv">nmd</span> <span class="ow">.eq.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then </span>
<span class="k">            </span><span class="nv">ierror</span> <span class="o">=</span> <span class="nv">COUPLER_ERROR_ONE_REALM</span>
            <span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;CFD or MD realm is missing in MPI_COMM_WORLD&quot;</span>
            <span class="k">call </span><span class="nv">MPI_abort</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span><span class="nv">ierror</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
        <span class="k">endif</span>

<span class="k">    endif</span>

<span class="k">end subroutine </span><span class="nv">test_realms</span>

<span class="c">!-----------------------------------------------------------------------------</span>
<span class="c">! Create communicators for each realm and inter-communicator</span>
<span class="c">!-----------------------------------------------------------------------------</span>

<span class="k">subroutine </span><span class="nv">create_comm</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span>  <span class="nv">callingrealm</span><span class="p">,</span> <span class="nv">ibuf</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nv">jbuf</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nv">remote_leader</span><span class="p">,</span> <span class="nv">comm_size</span>

    <span class="nv">callingrealm</span> <span class="o">=</span> <span class="nv">realm</span>
    <span class="c">! Split MPI COMM WORLD ready to establish two communicators</span>
    <span class="c">! 1) A global intra-communicator in each realm for communication</span>
    <span class="c">! internally between CFD processes or between MD processes</span>
    <span class="c">! 2) An inter-communicator which allows communication between  </span>
    <span class="c">! the &#39;groups&#39; of processors in MD and the group in the CFD </span>
    <span class="k">call </span><span class="nv">MPI_comm_dup</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span><span class="nv">CPL_WORLD_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="nv">RETURNED_REALM_COMM</span> <span class="o">=</span> <span class="nv">MPI_COMM_NULL</span>
    <span class="nv">CPL_REALM_COMM</span>      <span class="o">=</span> <span class="nv">MPI_COMM_NULL</span>

    <span class="c">!------------ create realm intra-communicators -----------------------</span>
    <span class="c">! Split MPI_COMM_WORLD into an intra-communicator for each realm </span>
    <span class="c">! (used for any communication within each realm - e.g. broadcast from </span>
    <span class="c">!  an md process to all other md processes) </span>
    <span class="k">call </span><span class="nv">MPI_comm_split</span><span class="p">(</span><span class="nv">CPL_WORLD_COMM</span><span class="p">,</span><span class="nv">callingrealm</span><span class="p">,</span><span class="nv">myid_world</span><span class="p">,</span><span class="nv">RETURNED_REALM_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>

    <span class="c">!------------ create realm inter-communicators -----------------------</span>
    <span class="c">! Create intercommunicator between the group of processor on each realm</span>
    <span class="c">! (used for any communication between realms - e.g. md group rank 2 sends</span>
    <span class="c">! to cfd group rank 5). inter-communication is by a single processor on each group</span>
    <span class="c">! Split duplicate of MPI_COMM_WORLD</span>
    <span class="k">call </span><span class="nv">MPI_comm_split</span><span class="p">(</span><span class="nv">CPL_WORLD_COMM</span><span class="p">,</span><span class="nv">callingrealm</span><span class="p">,</span><span class="nv">myid_world</span><span class="p">,</span><span class="nv">CPL_REALM_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">MPI_comm_rank</span><span class="p">(</span><span class="nv">CPL_REALM_COMM</span><span class="p">,</span><span class="nv">myid_realm</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="nv">rank_realm</span> <span class="o">=</span> <span class="nv">myid_realm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">rootid_realm</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c">! Get the MPI_comm_world ranks that hold the largest ranks in cfd_comm and md_comm</span>
    <span class="k">call </span><span class="nv">MPI_comm_size</span><span class="p">(</span><span class="nv">CPL_REALM_COMM</span><span class="p">,</span><span class="nv">comm_size</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="nv">ibuf</span><span class="p">(:)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="nv">jbuf</span><span class="p">(:)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">myid_realm</span> <span class="ow">.eq.</span> <span class="nv">comm_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="nv">ibuf</span><span class="p">(</span><span class="nv">realm</span><span class="p">)</span> <span class="o">=</span> <span class="nv">myid_world</span>
    <span class="k">endif</span>

<span class="k">    call </span><span class="nv">MPI_allreduce</span><span class="p">(</span> <span class="nv">ibuf</span> <span class="p">,</span><span class="nv">jbuf</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nv">MPI_INTEGER</span><span class="p">,</span> <span class="nv">MPI_MAX</span><span class="p">,</span> <span class="p">&amp;</span>
                        <span class="nv">CPL_WORLD_COMM</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

    <span class="c">!Set this largest rank on each process to be the inter-communicators (WHY NOT 0??)</span>
    <span class="k">select case</span> <span class="p">(</span><span class="nv">realm</span><span class="p">)</span>
    <span class="k">case</span> <span class="p">(</span><span class="nv">cfd_realm</span><span class="p">)</span>
        <span class="nv">remote_leader</span> <span class="o">=</span> <span class="nv">jbuf</span><span class="p">(</span><span class="nv">md_realm</span><span class="p">)</span>
    <span class="k">case</span> <span class="p">(</span><span class="nv">md_realm</span><span class="p">)</span>
        <span class="nv">remote_leader</span> <span class="o">=</span> <span class="nv">jbuf</span><span class="p">(</span><span class="nv">cfd_realm</span><span class="p">)</span>
    <span class="k">end select</span>

    <span class="c">!print*,color, jbuf, remote_leader</span>

    <span class="k">call </span><span class="nv">MPI_intercomm_create</span><span class="p">(</span><span class="nv">CPL_REALM_COMM</span><span class="p">,</span> <span class="nv">comm_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">CPL_WORLD_COMM</span><span class="p">,&amp;</span>
                                    <span class="nv">remote_leader</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">CPL_INTER_COMM</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>
    <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s1">&#39;Completed CPL communicator setup for &#39;</span><span class="p">,</span> <span class="nv">realm_name</span><span class="p">(</span><span class="nv">realm</span><span class="p">),</span> <span class="p">&amp;</span>
            <span class="s1">&#39; , CPL_WORLD_COMM ID:&#39;</span><span class="p">,</span> <span class="nv">myid_world</span>

<span class="k">end subroutine </span><span class="nv">create_comm</span>

<span class="k">end subroutine </span><span class="nv">CPL_create_comm</span>

<span class="c">!=============================================================================</span>
<span class="c">!! Read Coupler input file</span>
<span class="c">!-----------------------------------------------------------------------------</span>

<span class="k">subroutine </span><span class="nv">read_coupler_input</span>
    <span class="c">!use coupler_module</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">infileid</span>
    <span class="kt">logical</span> <span class="kd">::</span> <span class="nv">found</span>

    <span class="c">!Check all file ids until an unused one is found</span>
    <span class="nv">infileid</span> <span class="o">=</span> <span class="mi">100000</span>
    <span class="k">do </span>
<span class="k">        inquire</span><span class="p">(</span><span class="nv">unit</span><span class="o">=</span><span class="nv">infileid</span><span class="p">,</span><span class="nv">opened</span><span class="o">=</span><span class="nv">found</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">.not.</span><span class="p">(</span><span class="nv">found</span><span class="p">))</span> <span class="k">exit</span>
<span class="k">        </span><span class="nv">infileid</span> <span class="o">=</span> <span class="nv">infileid</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nv">enddo</span>

    <span class="c">!Open and read input file on all processes</span>
    <span class="k">open</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="nv">file</span><span class="o">=</span><span class="s1">&#39;cpl/COUPLER.in&#39;</span><span class="p">,</span><span class="nv">status</span><span class="o">=</span><span class="s2">&quot;old&quot;</span><span class="p">,</span><span class="nv">action</span><span class="o">=</span><span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="p">&amp;</span>
                  <span class="nv">form</span><span class="o">=</span><span class="s2">&quot;formatted&quot;</span><span class="p">)</span>

    <span class="k">call </span><span class="nv">locate</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="s1">&#39;DENSITY_CFD&#39;</span><span class="p">,</span><span class="nv">found</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">found</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">density_cfd</span>
    <span class="k">else</span>
<span class="k">        call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;Density not specified in coupler input file.&quot;</span><span class="p">)</span>
    <span class="k">end if</span>
<span class="k">    </span>
<span class="k">    call </span><span class="nv">locate</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="s1">&#39;CONSTRAINT_INFO&#39;</span><span class="p">,</span><span class="nv">found</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">found</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">constraint_algo</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">constraint_algo</span> <span class="ow">.ne.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">constraint_CVflag</span>
            <span class="k">read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">icmin_cnst</span>
            <span class="k">read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">icmax_cnst</span>
            <span class="k">read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">jcmin_cnst</span>
            <span class="k">read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">jcmax_cnst</span>
            <span class="k">read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">kcmin_cnst</span>
            <span class="k">read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">kcmax_cnst</span>
        <span class="k">endif</span>
<span class="k">    else</span>
<span class="k">        call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;CONSTRAINT_INFO not specified in coupler input file&quot;</span><span class="p">)</span>
    <span class="k">end if</span>

<span class="k">    call </span><span class="nv">locate</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="s1">&#39;OVERLAP_EXTENTS&#39;</span><span class="p">,</span><span class="nv">found</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">found</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">icmin_olap</span>
        <span class="k">read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">icmax_olap</span>
        <span class="k">read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">jcmin_olap</span>
        <span class="k">read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">jcmax_olap</span>
        <span class="k">read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">kcmin_olap</span>
        <span class="k">read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">kcmax_olap</span>
    <span class="k">else</span>
<span class="k">        call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;Ovelap extents unspecified in coupler input file.&quot;</span><span class="p">)</span>
    <span class="k">end if</span>

<span class="k">    call </span><span class="nv">locate</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="s1">&#39;TIMESTEP_RATIO&#39;</span><span class="p">,</span><span class="nv">found</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">found</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">timestep_ratio</span> <span class="c">!TODO name change</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">timestep_ratio</span> <span class="o">=</span> <span class="nv">VOID</span>
    <span class="k">end if</span>
<span class="k">    </span>
<span class="k">    call </span><span class="nv">locate</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="s1">&#39;MATCH_CELLSIZE&#39;</span><span class="p">,</span><span class="nv">found</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">found</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">md_cfd_match_cellsize</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">md_cfd_match_cellsize</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">end if</span>

<span class="k">    call </span><span class="nv">locate</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="s1">&#39;CPL_CFD_BC_XYZ&#39;</span><span class="p">,</span><span class="nv">found</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">found</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">cpl_cfd_bc_x</span> 
        <span class="k">read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">cpl_cfd_bc_y</span> 
        <span class="k">read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">cpl_cfd_bc_z</span> 
    <span class="k">else</span>
<span class="k">        </span><span class="nv">cpl_cfd_bc_x</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="nv">cpl_cfd_bc_y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nv">cpl_cfd_bc_z</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">end if</span>

<span class="k">    call </span><span class="nv">locate</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="s1">&#39;CPL_CFD_BC_SLICE&#39;</span><span class="p">,</span><span class="nv">found</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">found</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">cpl_cfd_bc_slice</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">cpl_cfd_bc_slice</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="k">end if</span>

<span class="k">    call </span><span class="nv">locate</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="s1">&#39;CPL_MD_BC_SLICE&#39;</span><span class="p">,</span><span class="nv">found</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">found</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">cpl_md_bc_slice</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">cpl_md_bc_slice</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="k">end if</span>

<span class="k">    call </span><span class="nv">locate</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span> <span class="s1">&#39;COMM_STYLE&#39;</span><span class="p">,</span> <span class="nv">found</span><span class="p">)</span> 
    <span class="k">if</span> <span class="p">(</span><span class="nv">found</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        read</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="nv">comm_style</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">comm_style</span> <span class="o">=</span> <span class="nv">comm_style_send_recv</span>
    <span class="k">end if</span>

<span class="k">    close</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="nv">status</span><span class="o">=</span><span class="s2">&quot;keep&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">myid_world</span> <span class="ow">.eq.</span> <span class="nv">rootid_world</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        call </span><span class="nv">CPL_write_header</span><span class="p">(</span><span class="s2">&quot;./cpl/coupler_header&quot;</span><span class="p">)</span><span class="c">!todo better name/place</span>
    <span class="k">end if</span>

<span class="k">end subroutine </span><span class="nv">read_coupler_input</span>

<span class="c">!------------------------------------------------------------------------------</span>
<span class="c">!                              CPL_write_header                               -</span>
<span class="c">!------------------------------------------------------------------------------</span>
<span class="c">!&gt;</span>
<span class="c">!! Writes header information to specified filename in the format</span>
<span class="c">!! Variable description ; variable name ; variable</span>
<span class="c">!!</span>
<span class="c">!! - Synopsis</span>
<span class="c">!!</span>
<span class="c">!!  - CPL_write_header (header_filename)</span>
<span class="c">!!</span>
<span class="c">!! - Input</span>
<span class="c">!!</span>
<span class="c">!!  - header_filename</span>
<span class="c">!!   - File name to write header to</span>
<span class="c">!!</span>
<span class="c">!! - Input/Output</span>
<span class="c">!!  - NONE</span>
<span class="c">!!</span>
<span class="c">!! - Output</span>
<span class="c">!!  - NONE</span>
<span class="c">!! </span>
<span class="c">!! @author Edward Smith</span>
<span class="c">!</span>
<span class="c">! ----------------------------------------------------------------------------</span>

<span class="k">subroutine </span><span class="nv">CPL_write_header</span><span class="p">(</span><span class="nv">header_filename</span><span class="p">)</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">header_filename</span>

    <span class="kt">logical</span>             <span class="kd">::</span> <span class="nv">found</span>
    <span class="kt">integer</span>             <span class="kd">::</span> <span class="nv">infileid</span>
    <span class="kt">Character</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>        <span class="kd">::</span> <span class="nv">the_date</span>
    <span class="kt">Character</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>       <span class="kd">::</span> <span class="nv">the_time</span>

    <span class="c">!Check all file ids until an unused one is found</span>
    <span class="nv">infileid</span> <span class="o">=</span> <span class="mi">100000</span>
    <span class="k">do </span>
<span class="k">        inquire</span><span class="p">(</span><span class="nv">unit</span><span class="o">=</span><span class="nv">infileid</span><span class="p">,</span><span class="nv">opened</span><span class="o">=</span><span class="nv">found</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">.not.</span><span class="p">(</span><span class="nv">found</span><span class="p">))</span> <span class="k">exit</span>
<span class="k">        </span><span class="nv">infileid</span> <span class="o">=</span> <span class="nv">infileid</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nv">enddo</span>

    <span class="c">! Write Simulation Parameter File contain all data required to completely recreate</span>
    <span class="c">! simulation and to be used for post processing</span>
    <span class="k">call </span><span class="nb">date_and_time</span><span class="p">(</span><span class="nv">the_date</span><span class="p">,</span> <span class="nv">the_time</span><span class="p">)</span>

    <span class="c">!Open and write input file on all processes</span>
    <span class="c">!if (rank_world .eq. rootid_world+1) then</span>

        <span class="k">open</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="nv">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="nv">header_filename</span><span class="p">),</span><span class="nv">action</span><span class="o">=</span><span class="s2">&quot;write&quot;</span><span class="p">,</span><span class="nv">form</span><span class="o">=</span><span class="s2">&quot;formatted&quot;</span><span class="p">)</span>

        <span class="k">write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Simulation run on Date;  sim_date ;&#39;</span><span class="p">,</span> <span class="nv">the_date</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Simulation start time ;  sim_start_time ;&#39;</span><span class="p">,</span> <span class="nv">the_time</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;CFD density;  density_cfd ;&#39;</span><span class="p">,</span> <span class="nv">density_cfd</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;choice of constraint algorithm;  constraint_algo ;&#39;</span><span class="p">,</span> <span class="nv">constraint_algo</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">constraint_algo</span> <span class="ow">.ne.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;CV form of constraint;  constraint_CVflag ;&#39;</span><span class="p">,</span> <span class="nv">constraint_CVflag</span>
            <span class="k">write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;minimum x cell of constrained region;  icmin_cnst ;&#39;</span><span class="p">,</span> <span class="nv">icmin_cnst</span>
            <span class="k">write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;maximum x cell of constrained region;  icmax_cnst ;&#39;</span><span class="p">,</span> <span class="nv">icmax_cnst</span>
            <span class="k">write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;minimum y cell of constrained region;  jcmin_cnst ;&#39;</span><span class="p">,</span> <span class="nv">jcmin_cnst</span>
            <span class="k">write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;maximum y cell of constrained region;  jcmax_cnst ;&#39;</span><span class="p">,</span> <span class="nv">jcmax_cnst</span>
            <span class="k">write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;minimum z cell of constrained region;  kcmin_cnst ;&#39;</span><span class="p">,</span> <span class="nv">kcmin_cnst</span>
            <span class="k">write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;maximum z cell of constrained region;  kcmax_cnst ;&#39;</span><span class="p">,</span> <span class="nv">kcmax_cnst</span>
        <span class="k">endif</span>

<span class="k">        write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;minimum x cell of overlap region;  icmin_olap ;&#39;</span><span class="p">,</span> <span class="nv">icmin_olap</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;maximum x cell of overlap region;  icmax_olap ;&#39;</span><span class="p">,</span> <span class="nv">icmax_olap</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;minimum y cell of overlap region;  jcmin_olap ;&#39;</span><span class="p">,</span> <span class="nv">jcmin_olap</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;maximum y cell of overlap region;  jcmax_olap ;&#39;</span><span class="p">,</span> <span class="nv">jcmax_olap</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;minimum z cell of overlap region;  kcmin_olap ;&#39;</span><span class="p">,</span> <span class="nv">kcmin_olap</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;maximum z cell of overlap region;  kcmax_olap ;&#39;</span><span class="p">,</span> <span class="nv">kcmax_olap</span>

        <span class="k">write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;MD timesteps per CFD timestep;  timestep_ratio ;&#39;</span><span class="p">,</span> <span class="nv">timestep_ratio</span> <span class="c">!TODO name change</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Enforce cellsize matching;  md_cfd_match_cellsize ;&#39;</span><span class="p">,</span> <span class="nv">md_cfd_match_cellsize</span>

        <span class="k">close</span><span class="p">(</span><span class="nv">infileid</span><span class="p">,</span><span class="nv">status</span><span class="o">=</span><span class="s1">&#39;keep&#39;</span><span class="p">)</span>

    <span class="c">!endif</span>

<span class="k">end subroutine  </span><span class="nv">CPL_write_header</span>



<span class="c">!------------------------------------------------------------------------------</span>
<span class="c">!                              coupler_cfd_init                               -</span>
<span class="c">!------------------------------------------------------------------------------</span>
<span class="c">!&gt;</span>
<span class="c">!! Initialisation routine for coupler module - Every variable is sent and stored</span>
<span class="c">!! to ensure both md and cfd region have an identical list of parameters</span>
<span class="c">!!</span>
<span class="c">!! - Synopsis</span>
<span class="c">!!</span>
<span class="c">!!  - coupler_cfd_init(nsteps,dt_cfd,icomm_grid,icoord,npxyz_cfd,xyzL,ncxyz,</span>
<span class="c">!!                             density,ijkcmax,ijkcmin,iTmin,iTmax,jTmin,</span>
<span class="c">!!                             jTmax,kTmin,kTmax,xg,yg,zg)</span>
<span class="c">!!</span>
<span class="c">!! - Input</span>
<span class="c">!!</span>
<span class="c">!!  - nsteps</span>
<span class="c">!!   - Number of time steps the CFD code is expected to run for (integer)</span>
<span class="c">!!  - dt_cfd</span>
<span class="c">!!   - CFD timestep (dp real)</span>
<span class="c">!!  - icomm_grid</span>
<span class="c">!!   - The MPI communicator setup by the MPI_CART_CREATE command in the </span>
<span class="c">!!     CFD region (integer)</span>
<span class="c">!!  - icoord</span>
<span class="c">!!   - The three coordinate for each rank in the domain (integer array nproc by 3)</span>
<span class="c">!!  - npxyz_cfd</span>
<span class="c">!!   - Number of processors in each cartesian dimension (integer array 3)</span>
<span class="c">!!  - xyzL</span>
<span class="c">!!   - Size of domain in each cartesian dimension (dp real array 3)</span>
<span class="c">!!  - ncxyz</span>
<span class="c">!!   - Global number of cells in each cartesian dimension (integer array 3)</span>
<span class="c">!!  - density</span>
<span class="c">!!   - Density of the CFD simulation (dp_real)</span>
<span class="c">!!  - ijkcmax</span>
<span class="c">!!   - Global maximum cell in each cartesian dimension (integer array 3)</span>
<span class="c">!!  - ijkcmin</span>
<span class="c">!!   - Global minimum cell in each cartesian dimension (integer array 3)</span>
<span class="c">!!  - iTmin</span>
<span class="c">!!   - Local minimum cell for each rank (integer array no. procs in x)</span>
<span class="c">!!  - iTmax</span>
<span class="c">!!   - Local maximum cell for each rank (integer array no. procs in x)</span>
<span class="c">!!  - jTmin</span>
<span class="c">!!   - Local minimum cell for each rank (integer array no. procs in y)</span>
<span class="c">!!  - jTmax</span>
<span class="c">!!   - Local maximum cell for each rank (integer array no. procs in y)</span>
<span class="c">!!  - kTmin</span>
<span class="c">!!   - Local minimum cell for each rank (integer array no. procs in z)</span>
<span class="c">!!  - kTmax</span>
<span class="c">!!   - Local maximum cell for each rank (integer array no. procs in z)</span>
<span class="c">!!  - xg</span>
<span class="c">!!   - Array of cell vertices in the x direction (no. cells in x + 1 by </span>
<span class="c">!!     no. cells in y + 1)</span>
<span class="c">!!  - yg</span>
<span class="c">!!   - Array of cell vertices in the y direction (no. cells in x + 1 by </span>
<span class="c">!!     no. cells in y + 1)</span>
<span class="c">!!  - zg</span>
<span class="c">!!   - Array of cell vertices in the z direction (no. cells in z + 1)</span>
<span class="c">!!</span>
<span class="c">!! - Input/Output</span>
<span class="c">!!  - NONE</span>
<span class="c">!!</span>
<span class="c">!! - Output</span>
<span class="c">!!  - NONE</span>
<span class="c">!! </span>
<span class="c">!! @author Edward Smith</span>
<span class="c">!</span>
<span class="c">! ----------------------------------------------------------------------------</span>


<span class="k">subroutine </span><span class="nv">coupler_cfd_init</span><span class="p">(</span><span class="nv">nsteps</span><span class="p">,</span><span class="nv">dt</span><span class="p">,</span><span class="nv">icomm_grid</span><span class="p">,</span><span class="nv">icoord</span><span class="p">,</span><span class="nv">npxyz_cfd</span><span class="p">,</span><span class="nv">xyzL</span><span class="p">,</span><span class="nv">ncxyz</span><span class="p">,</span> <span class="p">&amp;</span> 
                            <span class="nv">density</span><span class="p">,</span><span class="nv">ijkcmax</span><span class="p">,</span><span class="nv">ijkcmin</span><span class="p">,</span><span class="nv">iTmin</span><span class="p">,</span><span class="nv">iTmax</span><span class="p">,</span><span class="nv">jTmin</span><span class="p">,</span> <span class="p">&amp;</span> 
                            <span class="nv">jTmax</span><span class="p">,</span><span class="nv">kTmin</span><span class="p">,</span><span class="nv">kTmax</span><span class="p">,</span><span class="nv">xgrid</span><span class="p">,</span><span class="nv">ygrid</span><span class="p">,</span><span class="nv">zgrid</span><span class="p">)</span>
    <span class="k">use </span><span class="nv">mpi</span>
    <span class="k">implicit none           </span>

<span class="k">    </span><span class="kt">integer</span><span class="p">,</span>                        <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="nv">nsteps</span><span class="p">,</span><span class="nv">icomm_grid</span> 
    <span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>           <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="nv">ijkcmin</span><span class="p">,</span><span class="nv">ijkcmax</span><span class="p">,</span><span class="nv">npxyz_cfd</span><span class="p">,</span><span class="nv">ncxyz</span>
    <span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(:),</span>           <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="nv">iTmin</span><span class="p">,</span><span class="nv">iTmax</span><span class="p">,</span><span class="nv">jTmin</span><span class="p">,</span><span class="nv">jTmax</span><span class="p">,</span><span class="nv">kTmin</span><span class="p">,</span><span class="nv">kTmax</span>
    <span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(:,:),</span>         <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="nv">icoord</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span>               <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="nv">dt</span><span class="p">,</span><span class="nv">density</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>  <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="nv">xyzL</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:</span>  <span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="nv">zgrid</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:,:),</span><span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="nv">xgrid</span><span class="p">,</span><span class="nv">ygrid</span>


    <span class="kt">integer</span>                                         <span class="kd">::</span> <span class="nv">i</span><span class="p">,</span><span class="nv">ib</span><span class="p">,</span><span class="nv">jb</span><span class="p">,</span><span class="nv">kb</span><span class="p">,</span><span class="nv">pcoords</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="nv">source</span><span class="p">,</span><span class="nv">nproc</span>
    <span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span>                <span class="kd">::</span> <span class="nv">buf</span><span class="p">,</span><span class="nv">rank_world2rank_realm</span><span class="p">,</span><span class="nv">rank_world2rank_cart</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">))</span>                           <span class="kd">::</span> <span class="nv">dxmin</span><span class="p">,</span><span class="nv">dxmax</span><span class="p">,</span><span class="nv">dzmin</span><span class="p">,</span><span class="nv">dzmax</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span>  <span class="kd">::</span> <span class="nv">rbuf</span>

    <span class="c">! Read COUPLER.in input file</span>
    <span class="k">call </span><span class="nv">read_coupler_input</span>     

    <span class="c">! Duplicate grid communicator for coupler use</span>
    <span class="k">call </span><span class="nv">MPI_comm_dup</span><span class="p">(</span><span class="nv">icomm_grid</span><span class="p">,</span><span class="nv">CPL_CART_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">MPI_comm_rank</span><span class="p">(</span><span class="nv">CPL_CART_COMM</span><span class="p">,</span><span class="nv">myid_cart</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> 
    <span class="nv">rank_cart</span> <span class="o">=</span> <span class="nv">myid_cart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">rootid_cart</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c">!Send only from root processor</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">myid_realm</span> <span class="ow">.eq.</span> <span class="nv">rootid_realm</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="nv">source</span><span class="o">=</span><span class="nv">MPI_ROOT</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">source</span><span class="o">=</span><span class="nv">MPI_PROC_NULL</span>
    <span class="k">endif</span>

    <span class="c">! ================ Exchange and store Data ==============================</span>
    <span class="c">! Data is stored to the coupler module with the same name in both realms</span>
    <span class="c">! Note - MPI Broadcast between intercommunicators is only supported by MPI-2</span>

    <span class="c">! ------------------------ Processor Topology ---------------------------</span>
    <span class="c">! Store &amp; Send CFD number of processors</span>
    <span class="nv">npx_cfd</span> <span class="o">=</span> <span class="nv">npxyz_cfd</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nv">npy_cfd</span> <span class="o">=</span> <span class="nv">npxyz_cfd</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nv">npz_cfd</span> <span class="o">=</span> <span class="nv">npxyz_cfd</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="nv">nproc_cfd</span> <span class="o">=</span> <span class="nv">npx_cfd</span> <span class="o">*</span> <span class="nv">npy_cfd</span> <span class="o">*</span> <span class="nv">npz_cfd</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">npxyz_cfd</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>  <span class="c">!Send</span>

    <span class="c">! Receive &amp; Store MD number of processors</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span>   <span class="nv">buf</span>   <span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span>  <span class="mi">0</span>   <span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>  <span class="c">!Receive</span>
    <span class="nv">npx_md</span> <span class="o">=</span> <span class="nv">buf</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nv">npy_md</span> <span class="o">=</span> <span class="nv">buf</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nv">npz_md</span> <span class="o">=</span> <span class="nv">buf</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="nv">nproc_md</span> <span class="o">=</span> <span class="nv">npx_md</span> <span class="o">*</span> <span class="nv">npy_md</span> <span class="o">*</span> <span class="nv">npz_md</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">)</span>

    <span class="c">! Store &amp; Send CFD processor rank to coord</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank2coord_cfd</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nv">nproc_cfd</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="nv">ierr</span><span class="p">);</span> <span class="nv">rank2coord_cfd</span> <span class="o">=</span> <span class="nv">icoord</span>

    <span class="c">!do ib=1,size(icoord,1)</span>
    <span class="c">!do jb=1,size(icoord,2)</span>
    <span class="c">!    print(&#39;(i1, a, i1, a, i1, a, i1)&#39;), myid_world, &#39;: icoord(&#39;, ib, &#39;, &#39;, jb, &#39;) = &#39;, icoord(ib,jb)</span>
    <span class="c">!end do </span>
    <span class="c">!end do </span>
    
    <span class="nv">iblock_realm</span><span class="o">=</span><span class="nv">icoord</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">rank_realm</span><span class="p">)</span> 
    <span class="nv">jblock_realm</span><span class="o">=</span><span class="nv">icoord</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nv">rank_realm</span><span class="p">)</span>
    <span class="nv">kblock_realm</span><span class="o">=</span><span class="nv">icoord</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nv">rank_realm</span><span class="p">)</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nv">nproc_cfd</span><span class="p">));</span> <span class="nv">buf</span> <span class="o">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="nv">icoord</span><span class="p">,</span> <span class="p">(</span><span class="o">/</span> <span class="mi">3</span><span class="o">*</span><span class="nv">nproc_cfd</span> <span class="o">/</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">buf</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="nv">nproc_cfd</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>  <span class="c">!Send</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">)</span>

    <span class="c">! Receive &amp; Store MD processor rank to coord</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nv">nproc_md</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">buf</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="nv">nproc_md</span> <span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span>  <span class="mi">0</span>   <span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>  <span class="c">!Receive</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank2coord_md</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nv">nproc_md</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="nv">ierr</span><span class="p">);</span> <span class="nv">rank2coord_md</span> <span class="o">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="nv">buf</span><span class="p">,(</span><span class="o">/</span> <span class="mi">3</span><span class="p">,</span><span class="nv">nproc_md</span> <span class="o">/</span><span class="p">))</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">)</span>


    <span class="c">! Setup CFD mapping from coordinate to rank</span>
    <span class="c">! Store &amp; Send CFD mapping from coordinate to rank to MD</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">coord2rank_cfd</span><span class="p">(</span><span class="nv">npx_cfd</span><span class="p">,</span><span class="nv">npy_cfd</span><span class="p">,</span><span class="nv">npz_cfd</span><span class="p">))</span>
    <span class="k">do </span><span class="nv">ib</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">npx_cfd</span>
    <span class="k">do </span><span class="nv">jb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">npy_cfd</span>
    <span class="k">do </span><span class="nv">kb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">npz_cfd</span>
        <span class="nv">pcoords</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="nv">ib</span><span class="p">,</span> <span class="nv">jb</span><span class="p">,</span> <span class="nv">kb</span> <span class="o">/</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">call </span><span class="nv">MPI_Cart_rank</span><span class="p">(</span><span class="nv">CPL_CART_COMM</span><span class="p">,</span><span class="nv">pcoords</span><span class="p">,</span><span class="nv">i</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
        <span class="nv">coord2rank_cfd</span><span class="p">(</span><span class="nv">ib</span><span class="p">,</span><span class="nv">jb</span><span class="p">,</span><span class="nv">kb</span><span class="p">)</span> <span class="o">=</span> <span class="nv">i</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nv">enddo</span>
    <span class="nv">enddo</span>
    <span class="nv">enddo</span>

    <span class="k">allocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">(</span><span class="nv">nproc_cfd</span><span class="p">));</span> <span class="nv">buf</span> <span class="o">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="nv">coord2rank_cfd</span><span class="p">,</span> <span class="p">(</span><span class="o">/</span> <span class="nv">nproc_cfd</span> <span class="o">/</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">coord2rank_cfd</span><span class="p">,</span><span class="nv">nproc_cfd</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Send</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">)</span>

    <span class="c">! Receive &amp; Store MD coordinate to rank mapping</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">(</span><span class="nv">nproc_md</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">buf</span><span class="p">,</span><span class="nv">nproc_md</span> <span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span>  <span class="mi">0</span>   <span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>    <span class="c">!Receive</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">coord2rank_md</span> <span class="p">(</span><span class="nv">npx_md</span><span class="p">,</span><span class="nv">npy_md</span><span class="p">,</span><span class="nv">npz_md</span><span class="p">))</span> 
    <span class="nv">coord2rank_md</span> <span class="o">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="nv">buf</span><span class="p">,(</span><span class="o">/</span> <span class="nv">npx_md</span><span class="p">,</span><span class="nv">npy_md</span><span class="p">,</span><span class="nv">npz_md</span> <span class="o">/</span><span class="p">))</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">)</span>

    <span class="c">! Setup CFD mapping between realm &amp; world rank </span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_cfdrealm2rank_world</span><span class="p">(</span><span class="nv">nproc_cfd</span><span class="p">))</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_world2rank_realm</span><span class="p">(</span><span class="nv">nproc_world</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">CPL_rank_map</span><span class="p">(</span><span class="nv">CPL_REALM_COMM</span><span class="p">,</span><span class="nv">rank_realm</span><span class="p">,</span><span class="nv">nproc</span><span class="p">,</span> <span class="p">&amp;</span> 
                        <span class="nv">rank_cfdrealm2rank_world</span><span class="p">,</span><span class="nv">rank_world2rank_realm</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>

    <span class="c">!World to rank is the same on both realms</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_world2rank_cfdrealm</span><span class="p">(</span><span class="nv">nproc_world</span><span class="p">))</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_world2rank_mdrealm</span><span class="p">(</span><span class="nv">nproc_world</span><span class="p">))</span>
    <span class="nv">rank_world2rank_cfdrealm</span> <span class="o">=</span> <span class="nv">rank_world2rank_realm</span>
    <span class="nv">rank_world2rank_mdrealm</span>  <span class="o">=</span> <span class="nv">rank_world2rank_realm</span>

    <span class="c">! Send CFD mapping to MD</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">rank_cfdrealm2rank_world</span><span class="p">,</span><span class="nv">nproc_cfd</span><span class="p">,</span><span class="nv">MPI_integer</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>    <span class="c">!send</span>

    <span class="c">! Receive &amp; Store MD mapping from realm to local rank from MD</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_mdrealm2rank_world</span><span class="p">(</span><span class="nv">nproc_md</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">rank_mdrealm2rank_world</span><span class="p">,</span><span class="nv">nproc_md</span><span class="p">,</span><span class="nv">MPI_integer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>  <span class="c">!Receive</span>

    <span class="c">! Setup CFD mapping between cartesian topology &amp; world rank </span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_cfdcart2rank_world</span><span class="p">(</span><span class="nv">nproc_cfd</span><span class="p">))</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_world2rank_cart</span><span class="p">(</span><span class="nv">nproc_world</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">CPL_rank_map</span><span class="p">(</span><span class="nv">CPL_CART_COMM</span><span class="p">,</span><span class="nv">rank_cart</span><span class="p">,</span><span class="nv">nproc</span><span class="p">,</span> <span class="p">&amp;</span> 
                        <span class="nv">rank_cfdcart2rank_world</span><span class="p">,</span><span class="nv">rank_world2rank_cart</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>

    <span class="c">!World to rank is the same on both realms cart</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_world2rank_cfdcart</span><span class="p">(</span><span class="nv">nproc_world</span><span class="p">))</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_world2rank_mdcart</span><span class="p">(</span><span class="nv">nproc_world</span><span class="p">))</span>
    <span class="nv">rank_world2rank_cfdcart</span> <span class="o">=</span> <span class="nv">rank_world2rank_cart</span>
    <span class="nv">rank_world2rank_mdcart</span>  <span class="o">=</span> <span class="nv">rank_world2rank_cart</span>

    <span class="c">! Send CFD mapping to MD</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">rank_cfdcart2rank_world</span><span class="p">,</span><span class="nv">nproc_cfd</span><span class="p">,</span><span class="nv">MPI_integer</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>     <span class="c">!send</span>

    <span class="c">! Receive &amp; Store MD mapping from cart to local rank from MD</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_mdcart2rank_world</span><span class="p">(</span><span class="nv">nproc_md</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">rank_mdcart2rank_world</span><span class="p">,</span><span class="nv">nproc_md</span><span class="p">,</span><span class="nv">MPI_integer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>   <span class="c">!Receive</span>

    <span class="c">! ------------------ Timesteps and iterations ------------------------------</span>
    <span class="c">! Store &amp; send CFD nsteps and dt_cfd</span>
    <span class="nv">nsteps_cfd</span> <span class="o">=</span> <span class="nv">nsteps</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">nsteps</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_integer</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>         <span class="c">!Send</span>
    <span class="nv">dt_cfd</span> <span class="o">=</span> <span class="nv">dt</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">dt</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_double_precision</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>    <span class="c">!Send</span>

    <span class="c">! Receive &amp; store MD timestep dt_md</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">dt_md</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_double_precision</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>      <span class="c">!Receive</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">nsteps_md</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_integer</span><span class="p">,</span>     <span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>      <span class="c">!Receive</span>

    <span class="c">! ------------------ Send CFD grid extents ------------------------------</span>

    <span class="c">! Store &amp; send CFD density</span>
    <span class="c">!density_cfd = density</span>
    <span class="c">!call MPI_bcast(density_cfd,1,MPI_double_precision,source,CPL_INTER_COMM,ierr)  !Send</span>

    <span class="c">! Receive &amp; store MD density</span>
    <span class="c">!call MPI_bcast(density_md,1,MPI_double_precision,0,CPL_INTER_COMM,ierr)        !Receive</span>

    <span class="c">! Store &amp; send CFD domain size</span>
    <span class="nv">xL_cfd</span> <span class="o">=</span> <span class="nv">xyzL</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="nv">yL_cfd</span> <span class="o">=</span> <span class="nv">xyzL</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="nv">zL_cfd</span> <span class="o">=</span> <span class="nv">xyzL</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">xyzL</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">MPI_double_precision</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>  <span class="c">!Send</span>

    <span class="c">! Receive &amp; store MD domain size</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rbuf</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">rbuf</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">MPI_double_precision</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>       <span class="c">!Receive</span>
    <span class="nv">xL_md</span> <span class="o">=</span> <span class="nv">rbuf</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="nv">yL_md</span> <span class="o">=</span> <span class="nv">rbuf</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="nv">zL_md</span> <span class="o">=</span> <span class="nv">rbuf</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="nv">rbuf</span><span class="p">)</span>

    <span class="c">! Store &amp; send CFD grid extents</span>
    <span class="nv">icmin</span> <span class="o">=</span> <span class="nv">ijkcmin</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="nv">jcmin</span> <span class="o">=</span> <span class="nv">ijkcmin</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="nv">kcmin</span> <span class="o">=</span> <span class="nv">ijkcmin</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="nv">icmax</span> <span class="o">=</span> <span class="nv">ijkcmax</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="nv">jcmax</span> <span class="o">=</span> <span class="nv">ijkcmax</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="nv">kcmax</span> <span class="o">=</span> <span class="nv">ijkcmax</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
    <span class="nv">buf</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="nv">icmin</span><span class="p">,</span><span class="nv">icmax</span><span class="p">,</span><span class="nv">jcmin</span><span class="p">,</span><span class="nv">jcmax</span><span class="p">,</span><span class="nv">kcmin</span><span class="p">,</span><span class="nv">kcmax</span> <span class="o">/</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">buf</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Send</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">)</span>

    <span class="c">! Store &amp; send global number of cells in CFD</span>
    <span class="nv">ncx</span> <span class="o">=</span> <span class="nv">ncxyz</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="nv">ncy</span> <span class="o">=</span> <span class="nv">ncxyz</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="nv">ncz</span> <span class="o">=</span> <span class="nv">ncxyz</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">ncxyz</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>              <span class="c">!Send</span>

    <span class="c">! Store &amp; send array of global grid points</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">xg</span><span class="p">(</span><span class="nv">size</span><span class="p">(</span><span class="nv">xgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nv">size</span><span class="p">(</span><span class="nv">xgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="nv">ierr</span><span class="p">);</span> <span class="nv">xg</span> <span class="o">=</span> <span class="nv">xgrid</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">yg</span><span class="p">(</span><span class="nv">size</span><span class="p">(</span><span class="nv">ygrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nv">size</span><span class="p">(</span><span class="nv">ygrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="nv">ierr</span><span class="p">);</span> <span class="nv">yg</span> <span class="o">=</span> <span class="nv">ygrid</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">zg</span><span class="p">(</span><span class="nv">size</span><span class="p">(</span><span class="nv">zgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>                <span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="nv">ierr</span><span class="p">);</span> <span class="nv">zg</span> <span class="o">=</span> <span class="nv">zgrid</span>

              
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">xgrid</span><span class="p">,</span><span class="nv">size</span><span class="p">(</span><span class="nv">xgrid</span><span class="p">),</span><span class="nv">MPI_double_precision</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Send</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">ygrid</span><span class="p">,</span><span class="nv">size</span><span class="p">(</span><span class="nv">ygrid</span><span class="p">),</span><span class="nv">MPI_double_precision</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Send</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">zgrid</span><span class="p">,</span><span class="nv">size</span><span class="p">(</span><span class="nv">zgrid</span><span class="p">),</span><span class="nv">MPI_double_precision</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Send</span>

    <span class="c">!call write_matrix(xg,&#39;cfd side, xg=&#39;,50+rank_realm)</span>
    <span class="c">!call write_matrix(yg,&#39;cfd side, yg=&#39;,50+rank_realm)</span>
    <span class="c">!write(50+rank_realm,*), &#39;CFD side&#39;,rank_realm,&#39;zg&#39;,zg</span>

    <span class="c">! Store &amp; Send local (processor) CFD grid extents</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">icPmin_cfd</span><span class="p">(</span><span class="nv">npx_cfd</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="nv">ierr</span><span class="p">);</span> <span class="nv">icPmin_cfd</span><span class="p">(:)</span> <span class="o">=</span> <span class="nv">iTmin</span><span class="p">(:)</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">icPmax_cfd</span><span class="p">(</span><span class="nv">npx_cfd</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="nv">ierr</span><span class="p">);</span> <span class="nv">icPmax_cfd</span><span class="p">(:)</span> <span class="o">=</span> <span class="nv">iTmax</span><span class="p">(:)</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">jcPmin_cfd</span><span class="p">(</span><span class="nv">npy_cfd</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="nv">ierr</span><span class="p">);</span> <span class="nv">jcPmin_cfd</span><span class="p">(:)</span> <span class="o">=</span> <span class="nv">jTmin</span><span class="p">(:)</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">jcPmax_cfd</span><span class="p">(</span><span class="nv">npy_cfd</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="nv">ierr</span><span class="p">);</span> <span class="nv">jcPmax_cfd</span><span class="p">(:)</span> <span class="o">=</span> <span class="nv">jTmax</span><span class="p">(:)</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">kcPmin_cfd</span><span class="p">(</span><span class="nv">npz_cfd</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="nv">ierr</span><span class="p">);</span> <span class="nv">kcPmin_cfd</span><span class="p">(:)</span> <span class="o">=</span> <span class="nv">kTmin</span><span class="p">(:)</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">kcPmax_cfd</span><span class="p">(</span><span class="nv">npz_cfd</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="nv">ierr</span><span class="p">);</span> <span class="nv">kcPmax_cfd</span><span class="p">(:)</span> <span class="o">=</span> <span class="nv">kTmax</span><span class="p">(:)</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">icPmin_cfd</span><span class="p">,</span><span class="nv">npx_cfd</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Send</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">icPmax_cfd</span><span class="p">,</span><span class="nv">npx_cfd</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Send</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">jcPmin_cfd</span><span class="p">,</span><span class="nv">npy_cfd</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Send</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">jcPmax_cfd</span><span class="p">,</span><span class="nv">npy_cfd</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Send</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">kcPmin_cfd</span><span class="p">,</span><span class="nv">npz_cfd</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Send</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">kcPmax_cfd</span><span class="p">,</span><span class="nv">npz_cfd</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Send</span>

    <span class="c">!Calculate the cell sizes dx,dy &amp; dz</span>
    <span class="nv">dx</span> <span class="o">=</span> <span class="nv">xL_cfd</span><span class="o">/</span><span class="nv">ncx</span>   <span class="c">!xg(2,1)-xg(1,1)</span>
    <span class="nv">dy</span> <span class="o">=</span> <span class="nv">yg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="nv">yg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c">! yL_cfd/ncy</span>
    <span class="nv">dz</span> <span class="o">=</span> <span class="nv">zL_cfd</span><span class="o">/</span><span class="nv">ncz</span>   <span class="c">!zg(2  )-zg(1  )</span>

    <span class="c">!Calculate number of cells in overlap region</span>
    <span class="nv">ncx_olap</span> <span class="o">=</span> <span class="nv">icmax_olap</span> <span class="o">-</span> <span class="nv">icmin_olap</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nv">ncy_olap</span> <span class="o">=</span> <span class="nv">jcmax_olap</span> <span class="o">-</span> <span class="nv">jcmin_olap</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nv">ncz_olap</span> <span class="o">=</span> <span class="nv">kcmax_olap</span> <span class="o">-</span> <span class="nv">kcmin_olap</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c">!Broadcast the overlap to CFD on intracommunicator</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">ncy_olap</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">rootid_realm</span><span class="p">,</span><span class="nv">CPL_REALM_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="c">!Broadcast the overlap to MD over intercommunicator</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">ncy_olap</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>

    <span class="c">! Establish mapping between MD and CFD</span>
    <span class="k">call </span><span class="nv">CPL_create_map</span>

    <span class="c">!Check for grid strectching and terminate process if found</span>
    <span class="k">call </span><span class="nv">check_mesh</span>

<span class="k">contains</span>

<span class="k">    subroutine </span><span class="nv">check_mesh</span>
        <span class="k">implicit none</span>

<span class="k">        </span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">i</span><span class="p">,</span><span class="nv">j</span>
   
        <span class="c">! Check grids are the right size </span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">size</span><span class="p">(</span><span class="nv">xg</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="ow">.ne.</span> <span class="p">(</span><span class="nv">ncx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">.or.</span> <span class="nv">size</span><span class="p">(</span><span class="nv">xg</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="ow">.ne.</span> <span class="p">(</span><span class="nv">ncy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s1">&#39;xg is the wrong size in cpl_cfd_init&#39;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="k">        if</span> <span class="p">(</span><span class="nv">size</span><span class="p">(</span><span class="nv">yg</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="ow">.ne.</span> <span class="p">(</span><span class="nv">ncx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">.or.</span> <span class="nv">size</span><span class="p">(</span><span class="nv">yg</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="ow">.ne.</span> <span class="p">(</span><span class="nv">ncy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s1">&#39;yg is the wrong size in cpl_cfd_init&#39;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="k">        if</span> <span class="p">(</span><span class="nv">size</span><span class="p">(</span><span class="nv">zg</span><span class="p">)</span> <span class="ow">.ne.</span> <span class="p">(</span><span class="nv">ncz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s1">&#39;zg is the wrong size in cpl_cfd_init&#39;</span><span class="p">)</span>
        <span class="k">end if</span>

        <span class="c">!Define cell sizes dx,dy &amp; dz and check for grid stretching</span>
        <span class="c">! - - x - -</span>
        <span class="nv">dx</span> <span class="o">=</span> <span class="nv">xg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="nv">xg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="nv">dxmax</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="nv">xg</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="nv">ncx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="nv">ncy</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="nv">xg</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="nv">ncx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="nv">ncy</span><span class="p">))</span>
        <span class="nv">dxmin</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="nv">xg</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="nv">ncx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="nv">ncy</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="nv">xg</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="nv">ncx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="nv">ncy</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">dxmax</span><span class="o">-</span><span class="nv">dx</span><span class="ow">.gt.</span><span class="mf">0.00001</span><span class="nv">d0</span> <span class="ow">.or.</span><span class="nv">dx</span><span class="o">-</span><span class="nv">dxmin</span><span class="ow">.gt.</span><span class="mf">0.00001</span><span class="nv">d0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            print</span><span class="s1">&#39;(3(a,f15.7))&#39;</span><span class="p">,</span> <span class="s1">&#39;Max dx = &#39;</span><span class="p">,</span> <span class="nv">dxmax</span><span class="p">,</span> <span class="s1">&#39; dx = &#39;</span><span class="p">,</span> <span class="nv">dx</span><span class="p">,</span> <span class="s1">&#39; Min dx = &#39;</span><span class="p">,</span><span class="nv">dxmin</span>
            <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;ERROR - Grid stretching in x not supported&quot;</span><span class="p">)</span>
        <span class="k">endif</span>
        <span class="c">! - - y - -</span>
        <span class="nv">dy</span> <span class="o">=</span> <span class="nv">yg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="nv">yg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="nv">dymax</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="nv">yg</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="nv">ncx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="nv">ncy</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="nv">yg</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="nv">ncx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="nv">ncy</span><span class="p">))</span>
        <span class="nv">dymin</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="nv">yg</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="nv">ncx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="nv">ncy</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="nv">yg</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="nv">ncx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="nv">ncy</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">dymax</span><span class="o">-</span><span class="nv">dy</span><span class="ow">.gt.</span><span class="mf">0.00001</span><span class="nv">d0</span> <span class="ow">.or.</span> <span class="nv">dy</span><span class="o">-</span><span class="nv">dymin</span><span class="ow">.gt.</span><span class="mf">0.00001</span><span class="nv">d0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            print</span><span class="s1">&#39;(3(a,f15.7))&#39;</span><span class="p">,</span> <span class="s1">&#39;Max dy = &#39;</span><span class="p">,</span> <span class="nv">dymax</span><span class="p">,</span> <span class="s1">&#39; dy = &#39;</span><span class="p">,</span> <span class="nv">dy</span><span class="p">,</span> <span class="s1">&#39; Min dy = &#39;</span><span class="p">,</span><span class="nv">dymin</span>
            <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;ERROR - Grid stretching in y not supported&quot;</span><span class="p">)</span>
        <span class="k">endif</span>
        <span class="c">!if (dymax-dy.gt.0.0001 .or. dy-dymin.gt.0.0001) then</span>
        <span class="c">!    write(*,*) &quot;********************************************************************&quot;</span>
        <span class="c">!    write(*,*) &quot; Grid stretching employed in CFD domain - range of dy sizes:        &quot;</span>
        <span class="c">!   write(*,*) &quot;dymin = &quot;, dymin, &quot; dy = &quot;,dy, &quot; dymax = &quot;, dymax</span>
        <span class="c">!    write(*,*) &quot;********************************************************************&quot;</span>
        <span class="c">!    write(*,*)</span>
        <span class="c">!endif</span>
        <span class="c">! - - z - -</span>

        <span class="nv">dzmax</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="nv">zg</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="nv">ncz</span><span class="p">)</span><span class="o">-</span><span class="nv">zg</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="nv">ncz</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="nv">dzmin</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="nv">zg</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="nv">ncz</span><span class="p">)</span><span class="o">-</span><span class="nv">zg</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="nv">ncz</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">dzmax</span><span class="o">-</span><span class="nv">dz</span><span class="ow">.gt.</span><span class="mf">0.00001</span><span class="nv">d0</span> <span class="ow">.or.</span> <span class="nv">dz</span><span class="o">-</span><span class="nv">dzmin</span><span class="ow">.gt.</span><span class="mf">0.00001</span><span class="nv">d0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            print</span><span class="s1">&#39;(3(a,f15.7))&#39;</span><span class="p">,</span> <span class="s1">&#39;Max dz = &#39;</span><span class="p">,</span> <span class="nv">dzmax</span><span class="p">,</span> <span class="s1">&#39; dz = &#39;</span><span class="p">,</span> <span class="nv">dz</span><span class="p">,</span> <span class="s1">&#39; Min dz = &#39;</span><span class="p">,</span><span class="nv">dzmin</span>
            <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;ERROR - Grid stretching in z not supported&quot;</span><span class="p">)</span>
        <span class="k">endif</span>


<span class="k">    end subroutine </span><span class="nv">check_mesh</span>

<span class="k">end subroutine </span><span class="nv">coupler_cfd_init</span>


<span class="c">!------------------------------------------------------------------------------</span>
<span class="c">!                              coupler_md_init                               -</span>
<span class="c">!------------------------------------------------------------------------------</span>
<span class="c">!&gt;</span>
<span class="c">!! Initialisation routine for coupler module - Every variable is sent and stored</span>
<span class="c">!! to ensure both md and cfd region have an identical list of parameters</span>
<span class="c">!!</span>
<span class="c">!! - Synopsis</span>
<span class="c">!!</span>
<span class="c">!!  - coupler_mf_init(nsteps,dt_md,icomm_grid,icoord,npxyz_md,globaldomain,density)</span>
<span class="c">!!</span>
<span class="c">!! - Input</span>
<span class="c">!!</span>
<span class="c">!!  - nsteps</span>
<span class="c">!!   - Number of time steps the MD code is expected to run for (integer)</span>
<span class="c">!!  - dt_md</span>
<span class="c">!!   - MD timestep (dp real)</span>
<span class="c">!!  - icomm_grid</span>
<span class="c">!!   - The MPI communicator setup by the MPI_CART_CREATE command in the </span>
<span class="c">!!     CFD region (integer)</span>
<span class="c">!!  - icoord</span>
<span class="c">!!   - The three coordinate for each rank in the domain (integer array nproc by 3)</span>
<span class="c">!!  - npxyz_md</span>
<span class="c">!!   - Number of processors in each cartesian dimension (integer array 3)</span>
<span class="c">!!  - globaldomain</span>
<span class="c">!!   - Size of domain in each cartesian dimension (dp real array 3)</span>
<span class="c">!!  - density</span>
<span class="c">!!   - Density of the CFD simulation (dp_real)</span>
<span class="c">!!</span>
<span class="c">!! - Input/Output</span>
<span class="c">!!  - NONE</span>
<span class="c">!!</span>
<span class="c">!! - Output</span>
<span class="c">!!  - NONE</span>
<span class="c">!! </span>
<span class="c">!! @author Edward Smith</span>
<span class="c">!</span>
<span class="c">! ----------------------------------------------------------------------------</span>

<span class="c">! ----------------------------------------------------------------------------</span>
<span class="c">! Initialisation routine for coupler - Every variable is sent and stored</span>
<span class="c">! to ensure both md and cfd region have an identical list of parameters</span>

<span class="k">subroutine </span><span class="nv">coupler_md_init</span><span class="p">(</span><span class="nv">Nsteps</span><span class="p">,</span><span class="nv">initialstep</span><span class="p">,</span><span class="nv">dt</span><span class="p">,</span><span class="nv">icomm_grid</span><span class="p">,</span><span class="nv">icoord</span><span class="p">,</span><span class="nv">npxyz_md</span><span class="p">,</span><span class="nv">globaldomain</span><span class="p">,</span><span class="nv">density</span><span class="p">)</span>
    <span class="k">use </span><span class="nv">mpi</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">inout</span><span class="p">)</span>                          <span class="kd">::</span> <span class="nv">nsteps</span><span class="p">,</span><span class="nv">initialstep</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>                             <span class="kd">::</span> <span class="nv">icomm_grid</span>
    <span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>                <span class="kd">::</span> <span class="nv">npxyz_md</span> 
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,:),</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">icoord</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>                     <span class="kd">::</span> <span class="nv">dt</span><span class="p">,</span><span class="nv">density</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>   <span class="kd">::</span> <span class="nv">globaldomain</span>

    <span class="kt">integer</span>                                         <span class="kd">::</span> <span class="nv">i</span><span class="p">,</span><span class="nv">ib</span><span class="p">,</span><span class="nv">jb</span><span class="p">,</span><span class="nv">kb</span><span class="p">,</span><span class="nv">pcoords</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="nv">source</span><span class="p">,</span><span class="nv">nproc</span>
    <span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span>                <span class="kd">::</span> <span class="nv">buf</span><span class="p">,</span><span class="nv">rank_world2rank_realm</span><span class="p">,</span><span class="nv">rank_world2rank_cart</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span>  <span class="kd">::</span> <span class="nv">rbuf</span>

    <span class="c">! Read COUPLER.in input file</span>
    <span class="k">call </span><span class="nv">read_coupler_input</span>     

    <span class="c">! Duplicate grid communicator for coupler use</span>
    <span class="k">call </span><span class="nv">MPI_comm_dup</span><span class="p">(</span><span class="nv">icomm_grid</span><span class="p">,</span><span class="nv">CPL_CART_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="nv">MPI_comm_rank</span><span class="p">(</span><span class="nv">CPL_CART_COMM</span><span class="p">,</span><span class="nv">myid_cart</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> 
    <span class="nv">rank_cart</span> <span class="o">=</span> <span class="nv">myid_cart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">rootid_cart</span> <span class="o">=</span> <span class="mi">0</span>  
    <span class="c">!Send only from root processor</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">myid_realm</span> <span class="ow">.eq.</span> <span class="nv">rootid_realm</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="nv">source</span><span class="o">=</span><span class="nv">MPI_ROOT</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">source</span><span class="o">=</span><span class="nv">MPI_PROC_NULL</span>
    <span class="k">endif</span>

    <span class="c">! ================ Exchange and store Data ==============================</span>
    <span class="c">! Data is stored to the coupler module with the same name in both realms</span>
    <span class="c">! Note - MPI Broadcast between intercommunicators is only supported by MPI-2</span>

    <span class="c">! ------------------------ Processor Topology ---------------------------</span>
    <span class="c">! Receive &amp; Store CFD number of processors</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span>  <span class="nv">buf</span>   <span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span>  <span class="mi">0</span>   <span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Receive</span>
    <span class="nv">npx_cfd</span> <span class="o">=</span> <span class="nv">buf</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="nv">npy_cfd</span> <span class="o">=</span> <span class="nv">buf</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="nv">npz_cfd</span> <span class="o">=</span> <span class="nv">buf</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="nv">nproc_cfd</span> <span class="o">=</span> <span class="nv">npx_cfd</span> <span class="o">*</span> <span class="nv">npy_cfd</span> <span class="o">*</span> <span class="nv">npz_cfd</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">)</span>

    <span class="c">! Store &amp; Send MD number of processors</span>
    <span class="nv">npx_md</span> <span class="o">=</span> <span class="nv">npxyz_md</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>   <span class="nv">npy_md</span> <span class="o">=</span> <span class="nv">npxyz_md</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>   <span class="nv">npz_md</span> <span class="o">=</span> <span class="nv">npxyz_md</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>    
    <span class="nv">nproc_md</span> <span class="o">=</span> <span class="nv">npx_md</span> <span class="o">*</span> <span class="nv">npy_md</span> <span class="o">*</span> <span class="nv">npz_md</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">npxyz_md</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Send</span>

    <span class="c">! Receive &amp; Store CFD processor rank to coord</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nv">nproc_cfd</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">buf</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="nv">nproc_cfd</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span>  <span class="mi">0</span>   <span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Receive</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank2coord_cfd</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nv">nproc_cfd</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="nv">ierr</span><span class="p">);</span> <span class="nv">rank2coord_cfd</span> <span class="o">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="nv">buf</span><span class="p">,(</span><span class="o">/</span> <span class="mi">3</span><span class="p">,</span><span class="nv">nproc_cfd</span> <span class="o">/</span><span class="p">))</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">)</span>

    <span class="c">! Store &amp; Send MD processor rank to coord</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank2coord_md</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nv">nproc_md</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="nv">ierr</span><span class="p">);</span> <span class="nv">rank2coord_md</span> <span class="o">=</span> <span class="nv">icoord</span>
    <span class="nv">iblock_realm</span><span class="o">=</span><span class="nv">icoord</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">rank_realm</span><span class="p">);</span> <span class="nv">jblock_realm</span><span class="o">=</span><span class="nv">icoord</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nv">rank_realm</span><span class="p">);</span> <span class="nv">kblock_realm</span><span class="o">=</span><span class="nv">icoord</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nv">rank_realm</span><span class="p">)</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nv">nproc_md</span><span class="p">));</span> <span class="nv">buf</span> <span class="o">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="nv">icoord</span><span class="p">,(</span><span class="o">/</span> <span class="mi">3</span><span class="o">*</span><span class="nv">nproc_md</span> <span class="o">/</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">buf</span> <span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="nv">nproc_md</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Send</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">)</span>

    <span class="c">! Receive &amp; Store CFD coordinate to rank mapping</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">(</span><span class="nv">nproc_cfd</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">buf</span><span class="p">,</span><span class="nv">nproc_cfd</span> <span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span>  <span class="mi">0</span>   <span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>   <span class="c">!Receive</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">coord2rank_cfd</span> <span class="p">(</span><span class="nv">npx_cfd</span><span class="p">,</span><span class="nv">npy_cfd</span><span class="p">,</span><span class="nv">npz_cfd</span><span class="p">))</span>
    <span class="nv">coord2rank_cfd</span> <span class="o">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="nv">buf</span><span class="p">,(</span><span class="o">/</span> <span class="nv">npx_cfd</span><span class="p">,</span><span class="nv">npy_cfd</span><span class="p">,</span><span class="nv">npz_cfd</span> <span class="o">/</span><span class="p">))</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">)</span>

    <span class="c">! Setup MD mapping from coordinate to rank, </span>
    <span class="c">! Store &amp; Send MD mapping from coordinate to rank to CFD</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">coord2rank_md</span><span class="p">(</span><span class="nv">npx_md</span><span class="p">,</span><span class="nv">npy_md</span><span class="p">,</span><span class="nv">npz_md</span><span class="p">))</span>
    <span class="k">do </span><span class="nv">ib</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">npx_md</span>
    <span class="k">do </span><span class="nv">jb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">npy_md</span>
    <span class="k">do </span><span class="nv">kb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">npz_md</span>
        <span class="nv">pcoords</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="nv">ib</span><span class="p">,</span> <span class="nv">jb</span><span class="p">,</span> <span class="nv">kb</span> <span class="o">/</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">call </span><span class="nv">MPI_Cart_rank</span><span class="p">(</span><span class="nv">CPL_CART_COMM</span><span class="p">,</span><span class="nv">pcoords</span><span class="p">,</span><span class="nv">i</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
        <span class="nv">coord2rank_md</span><span class="p">(</span><span class="nv">ib</span><span class="p">,</span><span class="nv">jb</span><span class="p">,</span><span class="nv">kb</span><span class="p">)</span> <span class="o">=</span> <span class="nv">i</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nv">enddo</span>
    <span class="nv">enddo</span>
    <span class="nv">enddo</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">(</span><span class="nv">nproc_md</span><span class="p">));</span> <span class="nv">buf</span> <span class="o">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="nv">coord2rank_md</span><span class="p">,</span> <span class="p">(</span><span class="o">/</span> <span class="nv">nproc_md</span> <span class="o">/</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">coord2rank_md</span><span class="p">,</span><span class="nv">nproc_md</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>   <span class="c">!Send</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">)</span>

    <span class="c">! Setup MD mapping between realm &amp; world rank </span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_mdrealm2rank_world</span><span class="p">(</span><span class="nv">nproc_md</span><span class="p">))</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_world2rank_realm</span><span class="p">(</span><span class="nv">nproc_world</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">CPL_rank_map</span><span class="p">(</span><span class="nv">CPL_REALM_COMM</span><span class="p">,</span><span class="nv">rank_realm</span><span class="p">,</span><span class="nv">nproc</span><span class="p">,</span> <span class="p">&amp;</span> 
                        <span class="nv">rank_mdrealm2rank_world</span><span class="p">,</span><span class="nv">rank_world2rank_realm</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>

    <span class="c">!World to rank is the same on both realms</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_world2rank_cfdrealm</span><span class="p">(</span><span class="nv">nproc_world</span><span class="p">))</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_world2rank_mdrealm</span><span class="p">(</span><span class="nv">nproc_world</span><span class="p">))</span>
    <span class="nv">rank_world2rank_cfdrealm</span> <span class="o">=</span> <span class="nv">rank_world2rank_realm</span>
    <span class="nv">rank_world2rank_mdrealm</span>  <span class="o">=</span> <span class="nv">rank_world2rank_realm</span>

    <span class="c">! Receive &amp; Store CFD_mapping from realm to local rank</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_cfdrealm2rank_world</span><span class="p">(</span><span class="nv">nproc_cfd</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">rank_cfdrealm2rank_world</span><span class="p">,</span><span class="nv">nproc_cfd</span><span class="p">,</span><span class="nv">MPI_integer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>    <span class="c">!Receive</span>

    <span class="c">! Send MD mapping from realm to local rank to CFD</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">rank_mdrealm2rank_world</span><span class="p">,</span><span class="nv">nproc_md</span><span class="p">,</span><span class="nv">MPI_integer</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>  <span class="c">!send</span>

    <span class="c">! Setup MD mapping between cartesian topology &amp; world rank </span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_mdcart2rank_world</span><span class="p">(</span><span class="nv">nproc_md</span><span class="p">))</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_world2rank_cart</span><span class="p">(</span><span class="nv">nproc_world</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">CPL_rank_map</span><span class="p">(</span><span class="nv">CPL_CART_COMM</span><span class="p">,</span><span class="nv">rank_cart</span><span class="p">,</span><span class="nv">nproc</span><span class="p">,</span> <span class="p">&amp;</span> 
                        <span class="nv">rank_mdcart2rank_world</span><span class="p">,</span><span class="nv">rank_world2rank_cart</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>

    <span class="c">!World to rank is the same on both realms cart</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_world2rank_cfdcart</span><span class="p">(</span><span class="nv">nproc_world</span><span class="p">))</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_world2rank_mdcart</span><span class="p">(</span><span class="nv">nproc_world</span><span class="p">))</span>
    <span class="nv">rank_world2rank_cfdcart</span> <span class="o">=</span> <span class="nv">rank_world2rank_cart</span>
    <span class="nv">rank_world2rank_mdcart</span>  <span class="o">=</span> <span class="nv">rank_world2rank_cart</span>

    <span class="c">! Receive &amp; Store CFD_mapping from cart to local rank</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rank_cfdcart2rank_world</span><span class="p">(</span><span class="nv">nproc_cfd</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">rank_cfdcart2rank_world</span><span class="p">,</span><span class="nv">nproc_cfd</span><span class="p">,</span><span class="nv">MPI_integer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Receive</span>

    <span class="c">! Send MD mapping from cart to local rank to CFD</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">rank_mdcart2rank_world</span><span class="p">,</span><span class="nv">nproc_md</span><span class="p">,</span><span class="nv">MPI_integer</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>   <span class="c">!send</span>

    <span class="c">! ------------------ Timesteps and iterations ------------------------------</span>
    <span class="c">! Receive &amp; store CFD nsteps and dt_cfd</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">nsteps_cfd</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_integer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>              <span class="c">!Receive</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">dt_cfd</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_double_precision</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>     <span class="c">!Receive</span>

    <span class="c">! Store &amp; send MD timestep to dt_md</span>
    <span class="nv">dt_MD</span> <span class="o">=</span> <span class="nv">dt</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">dt</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_double_precision</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>    <span class="c">!Send</span>
    <span class="nv">nsteps_MD</span> <span class="o">=</span> <span class="nv">nsteps</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">nsteps</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_integer</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Send</span>

    <span class="c">! ------------------ Receive CFD grid extents ------------------------------</span>
    <span class="c">! Receive &amp; store CFD density</span>
    <span class="c">!call MPI_bcast(density_cfd,1,MPI_double_precision,0,CPL_INTER_COMM,ierr)       !Receive</span>

    <span class="c">! Store &amp; send MD density</span>
    <span class="c">!density_md = density </span>
    <span class="c">!call MPI_bcast(density,1,MPI_double_precision,source,CPL_INTER_COMM,ierr)  !Send</span>

    <span class="c">! Receive &amp; store CFD domain size</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">rbuf</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">rbuf</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">MPI_double_precision</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>               <span class="c">!Receive</span>
    <span class="nv">xL_cfd</span> <span class="o">=</span> <span class="nv">rbuf</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="nv">yL_cfd</span> <span class="o">=</span> <span class="nv">rbuf</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="nv">zL_cfd</span> <span class="o">=</span> <span class="nv">rbuf</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="nv">rbuf</span><span class="p">)</span>

    <span class="c">! Store &amp; send MD domain size</span>
    <span class="nv">xL_md</span> <span class="o">=</span> <span class="nv">globaldomain</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="nv">yL_md</span> <span class="o">=</span> <span class="nv">globaldomain</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="nv">zL_md</span> <span class="o">=</span> <span class="nv">globaldomain</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">globaldomain</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">MPI_double_precision</span><span class="p">,</span><span class="nv">source</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>  <span class="c">!Send</span>

    <span class="c">! Receive &amp; Store global CFD grid extents</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">buf</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="nv">MPI_INTEGER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Send</span>
    <span class="nv">icmin</span> <span class="o">=</span> <span class="nv">buf</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="nv">icmax</span> <span class="o">=</span> <span class="nv">buf</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nv">jcmin</span> <span class="o">=</span> <span class="nv">buf</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="nv">jcmax</span> <span class="o">=</span> <span class="nv">buf</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="nv">kcmin</span> <span class="o">=</span> <span class="nv">buf</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="nv">kcmax</span> <span class="o">=</span> <span class="nv">buf</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">)</span>

    <span class="c">! Receive &amp; Store array of global number of cells in CFD</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nv">MPI_INTEGER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Receive</span>
    <span class="nv">ncx</span> <span class="o">=</span> <span class="nv">buf</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="nv">ncy</span> <span class="o">=</span> <span class="nv">buf</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="nv">ncz</span> <span class="o">=</span> <span class="nv">buf</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="nv">buf</span><span class="p">)</span>

    <span class="c">! Receive &amp; Store array of global grid points</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">xg</span><span class="p">(</span><span class="nv">ncx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nv">ncy</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="nv">yg</span><span class="p">(</span><span class="nv">ncx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nv">ncy</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="nv">zg</span><span class="p">(</span><span class="nv">ncz</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">xg</span><span class="p">,</span><span class="nv">size</span><span class="p">(</span><span class="nv">xg</span><span class="p">),</span><span class="nv">MPI_double_precision</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Receive</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">yg</span><span class="p">,</span><span class="nv">size</span><span class="p">(</span><span class="nv">yg</span><span class="p">),</span><span class="nv">MPI_double_precision</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Receive</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">zg</span><span class="p">,</span><span class="nv">size</span><span class="p">(</span><span class="nv">zg</span><span class="p">),</span><span class="nv">MPI_double_precision</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Receive </span>

    <span class="c">! Receive &amp; Store local (processor) CFD grid extents</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">icPmin_cfd</span><span class="p">(</span><span class="nv">npx_cfd</span><span class="p">));</span> <span class="k">allocate</span><span class="p">(</span><span class="nv">icPmax_cfd</span><span class="p">(</span><span class="nv">npx_cfd</span><span class="p">));</span>  
    <span class="k">allocate</span><span class="p">(</span><span class="nv">jcPmin_cfd</span><span class="p">(</span><span class="nv">npy_cfd</span><span class="p">));</span> <span class="k">allocate</span><span class="p">(</span><span class="nv">jcPmax_cfd</span><span class="p">(</span><span class="nv">npy_cfd</span><span class="p">));</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">kcPmin_cfd</span><span class="p">(</span><span class="nv">npz_cfd</span><span class="p">));</span> <span class="k">allocate</span><span class="p">(</span><span class="nv">kcPmax_cfd</span><span class="p">(</span><span class="nv">npz_cfd</span><span class="p">));</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">icPmin_cfd</span><span class="p">,</span><span class="nv">npx_cfd</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Receive</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">icPmax_cfd</span><span class="p">,</span><span class="nv">npx_cfd</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Receive</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">jcPmin_cfd</span><span class="p">,</span><span class="nv">npy_cfd</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Receive</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">jcPmax_cfd</span><span class="p">,</span><span class="nv">npy_cfd</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Receive</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">kcPmin_cfd</span><span class="p">,</span><span class="nv">npz_cfd</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Receive</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">kcPmax_cfd</span><span class="p">,</span><span class="nv">npz_cfd</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">CPL_INTER_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span> <span class="c">!Receive</span>

    <span class="c">!Calculate the cell sizes dx,dy &amp; dz</span>
    <span class="nv">dx</span> <span class="o">=</span> <span class="nv">xL_cfd</span><span class="o">/</span><span class="nv">ncx</span>   <span class="c">!xg(2,1)-xg(1,1)</span>
    <span class="nv">dy</span> <span class="o">=</span> <span class="nv">yg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="nv">yg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c">! yL_cfd/ncy</span>
    <span class="nv">dz</span> <span class="o">=</span> <span class="nv">zL_cfd</span><span class="o">/</span><span class="nv">ncz</span>   <span class="c">!zg(2  )-zg(1  )</span>

    <span class="c">!Define number of cells in overlap region</span>
    <span class="nv">ncx_olap</span> <span class="o">=</span> <span class="nv">icmax_olap</span> <span class="o">-</span> <span class="nv">icmin_olap</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nv">ncy_olap</span> <span class="o">=</span> <span class="nv">jcmax_olap</span> <span class="o">-</span> <span class="nv">jcmin_olap</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nv">ncz_olap</span> <span class="o">=</span> <span class="nv">kcmax_olap</span> <span class="o">-</span> <span class="nv">kcmin_olap</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c">! Establish mapping between MD an CFD</span>
    <span class="k">call </span><span class="nv">CPL_create_map</span>
   
    <span class="c">!if ( nsteps_md &lt;= 0 ) then</span>
    <span class="c">!    write(0,*) &quot;Number of MD steps per dt interval &lt;= 0&quot;</span>
    <span class="c">!    write(0,*) &quot;Coupler will not work, quitting ...&quot;</span>
    <span class="c">!    call MPI_Abort(MPI_COMM_WORLD,COUPLER_ERROR_INIT,ierr)</span>
    <span class="c">!endif</span>

    <span class="c">! Setup timesteps and simulation timings based on CFD/coupler</span>
    <span class="k">call </span><span class="nv">set_coupled_timing</span><span class="p">(</span><span class="nv">initialstep</span><span class="p">,</span> <span class="nv">Nsteps</span><span class="p">)</span>

<span class="k">end subroutine </span><span class="nv">coupler_md_init</span>

<span class="c">!-----------------------------------------------------------------------------</span>
<span class="c">! Lucian(?):</span>
<span class="c">!   This routine should be part of the initialisation of the coupler.</span>
<span class="c">!   The initial times (stime for cfd &amp; elapsedtime for md) are</span>
<span class="c">!   compared to see if restart is consistent and number of steps on</span>
<span class="c">!   both sides of the coupler are calculated and stored</span>

<span class="c">! DT: This routine seems to me that it&#39;s unique to flowmol. I&#39;ll have a look</span>
<span class="c">!     at making it general when I do the LAMMPS socket. TODO(djt06@ic.ac.uk)</span>
<span class="k">subroutine </span><span class="nv">set_coupled_timing</span><span class="p">(</span><span class="nv">initialstep</span><span class="p">,</span> <span class="nv">Nsteps</span><span class="p">)</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>                  <span class="kd">::</span> <span class="nv">initialstep</span>
    <span class="kt">integer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>                 <span class="kd">::</span> <span class="nv">Nsteps</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">))</span>               <span class="kd">::</span> <span class="nv">elapsedtime</span>

    <span class="kt">integer</span>                             <span class="kd">::</span> <span class="nv">Nsteps_MDperCFD</span>

    <span class="c">!Set number of MD timesteps per CFD using ratio of timestep or coupler value</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">timestep_ratio</span> <span class="ow">.eq.</span> <span class="nv">VOID</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="nv">Nsteps_MDperCFD</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nv">dt_cfd</span><span class="o">/</span><span class="nv">dt_MD</span><span class="p">)</span>
    <span class="k">else </span>
<span class="k">        </span><span class="nv">Nsteps_MDperCFD</span> <span class="o">=</span> <span class="nv">timestep_ratio</span>
    <span class="k">endif</span>
<span class="k">    </span><span class="nv">Nsteps_coupled</span> <span class="o">=</span> <span class="nv">Nsteps_cfd</span>

    <span class="c">!Set number of steps in MD simulation and final time elapsed</span>
    <span class="nv">Nsteps_md</span>   <span class="o">=</span> <span class="nv">initialstep</span> <span class="o">+</span> <span class="nv">Nsteps_cfd</span> <span class="o">*</span> <span class="nv">Nsteps_MDperCFD</span>
    <span class="nv">elapsedtime</span> <span class="o">=</span> <span class="nv">Nsteps_md</span> <span class="o">*</span> <span class="nv">dt_MD</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">rank_realm</span> <span class="ow">.eq.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then </span>
<span class="k">        print</span><span class="o">*</span><span class="p">,</span> <span class="s1">&#39;Nsteps in CFD is &#39;</span><span class="p">,</span> <span class="nv">Nsteps_cfd</span>
        <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s1">&#39;Nsteps in MD reset from &#39;</span><span class="p">,</span> <span class="nv">Nsteps</span><span class="p">,</span> <span class="s1">&#39; to &#39;</span><span class="p">,</span> <span class="nv">Nsteps_md</span>
        <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s1">&#39;Total simulation time will be &#39;</span><span class="p">,</span> <span class="nv">elapsedtime</span><span class="p">,</span> <span class="s1">&#39; in LJ units&#39;</span>
    <span class="k">endif</span> 

    <span class="c">!Set corrected nsteps returned to MD</span>
    <span class="nv">Nsteps</span> <span class="o">=</span> <span class="nv">Nsteps_md</span>

<span class="k">end subroutine </span><span class="nv">set_coupled_timing</span>


<span class="c">!=============================================================================</span>
<span class="c">!! Establish for all MD processors the mapping (if any) </span>
<span class="c">!! to coupled CFD processors</span>
<span class="c">!-----------------------------------------------------------------------------</span>

<span class="k">subroutine </span><span class="nv">CPL_create_map</span>
    <span class="k">use </span><span class="nv">mpi</span>
    <span class="k">implicit none</span>

    <span class="c">! Check (as best as one can) that the inputs will work</span>
    <span class="k">call </span><span class="nv">check_config_feasibility</span>

    <span class="c">! Get ranges of cells on each MD processor</span>
    <span class="k">call </span><span class="nv">get_md_cell_ranges</span>

    <span class="c">! Get overlapping mapping for MD to CFD</span>
    <span class="k">call </span><span class="nv">get_overlap_blocks</span>

    <span class="c">! Setup overlap communicators</span>
    <span class="k">call </span><span class="nv">prepare_overlap_comms</span>

    <span class="c">! Setup graph topology</span>
    <span class="k">call </span><span class="nv">CPL_overlap_topology</span>

<span class="k">contains</span>

<span class="k">subroutine </span><span class="nv">check_config_feasibility</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">ival</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">))</span> <span class="kd">::</span> <span class="nv">rval</span><span class="p">,</span> <span class="nv">rtoler</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">string</span>

    <span class="c">! Check that CFD and MD domains agree in x and z directions</span>
    <span class="nv">rtoler</span> <span class="o">=</span> <span class="mf">1.</span><span class="nv">d</span><span class="o">-</span><span class="mi">4</span>
    <span class="nv">rval</span> <span class="o">=</span> <span class="mf">0.</span><span class="nv">d0</span>
    <span class="nv">rval</span> <span class="o">=</span> <span class="nv">rval</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="nv">xL_md</span> <span class="o">-</span> <span class="nv">xL_cfd</span><span class="p">)</span>
    <span class="nv">rval</span> <span class="o">=</span> <span class="nv">rval</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="nv">zL_md</span> <span class="o">-</span> <span class="nv">zL_cfd</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">rval</span> <span class="ow">.gt.</span> <span class="nv">rtoler</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span>
<span class="k">        </span><span class="nv">string</span> <span class="o">=</span> <span class="s2">&quot;MD/CFD domain sizes do not match in both x and z &quot;</span>   <span class="o">//</span> <span class="p">&amp;</span>
                 <span class="s2">&quot;directions. Aborting simulation. &quot;</span>
        <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;xL_md = &quot;</span><span class="p">,</span> <span class="nv">xL_md</span>
        <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;xL_cfd = &quot;</span><span class="p">,</span> <span class="nv">xL_cfd</span>
        <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;zL_md = &quot;</span><span class="p">,</span> <span class="nv">zL_md</span>
        <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;zL_cfd = &quot;</span><span class="p">,</span> <span class="nv">zL_cfd</span>
        <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="nv">string</span><span class="p">)</span>
    
    <span class="k">end if</span>

    <span class="c">! Check there is only one overlap CFD proc in y</span>
    <span class="nv">ival</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span> <span class="nb">dble</span><span class="p">(</span><span class="nv">ncy</span><span class="p">)</span> <span class="o">/</span> <span class="nb">dble</span><span class="p">(</span><span class="nv">npy_cfd</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">ncy_olap</span> <span class="ow">.gt.</span> <span class="nv">ival</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        </span><span class="nv">string</span> <span class="o">=</span> <span class="s2">&quot;This coupler will not work if there is more than one &quot;</span><span class="o">//</span> <span class="p">&amp;</span>
                 <span class="s2">&quot;CFD (y-coordinate) in the overlapping region. &quot;</span>       <span class="o">//</span> <span class="p">&amp;</span>
                 <span class="s2">&quot;Aborting simulation.&quot;</span>
        <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="nv">string</span><span class="p">)</span>

    <span class="k">end if</span>

    <span class="c">! Check that MD processor size is an integer multiple of CFD cell size</span>
    <span class="c">! This test doesn&#39;t work if xL_xyz is slightly less than a multiple of dxyz</span>
    <span class="c">! We avoid this by adding the required tolerence to the mod and taking away after</span>
    <span class="nv">rtoler</span> <span class="o">=</span> <span class="mf">1.</span><span class="nv">d</span><span class="o">-</span><span class="mi">4</span>
    <span class="nv">rval</span> <span class="o">=</span> <span class="mf">0.</span><span class="nv">d0</span>
    <span class="nv">rval</span> <span class="o">=</span> <span class="nv">rval</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">mod</span><span class="p">(</span> <span class="nv">xL_md</span><span class="o">+</span><span class="nv">rtoler</span><span class="p">,</span> <span class="nv">dx</span> <span class="p">)</span><span class="o">-</span><span class="nv">rtoler</span><span class="p">)</span>
    <span class="nv">rval</span> <span class="o">=</span> <span class="nv">rval</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">mod</span><span class="p">(</span> <span class="nv">yL_md</span><span class="o">+</span><span class="nv">rtoler</span><span class="p">,</span> <span class="nv">dy</span> <span class="p">)</span><span class="o">-</span><span class="nv">rtoler</span><span class="p">)</span>
    <span class="nv">rval</span> <span class="o">=</span> <span class="nv">rval</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">mod</span><span class="p">(</span> <span class="nv">zL_md</span><span class="o">+</span><span class="nv">rtoler</span><span class="p">,</span> <span class="nv">dz</span> <span class="p">)</span><span class="o">-</span><span class="nv">rtoler</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">rval</span> <span class="ow">.gt.</span> <span class="nv">rtoler</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        print</span><span class="s1">&#39;(6(a,f10.5))&#39;</span><span class="p">,</span> <span class="s1">&#39; xL_md/dx = &#39;</span><span class="p">,</span><span class="nv">xL_md</span><span class="o">/</span><span class="nv">dx</span><span class="p">,</span> <span class="s1">&#39;dx =&#39;</span><span class="p">,</span> <span class="nv">dx</span><span class="p">,</span> <span class="p">&amp;</span> 
                     <span class="s1">&#39; yL_md/dy = &#39;</span><span class="p">,</span><span class="nv">yL_md</span><span class="o">/</span><span class="nv">dy</span><span class="p">,</span> <span class="s1">&#39;dy =&#39;</span><span class="p">,</span> <span class="nv">dy</span><span class="p">,</span> <span class="p">&amp;</span>
                     <span class="s1">&#39; zL_md/dz = &#39;</span><span class="p">,</span><span class="nv">zL_md</span><span class="o">/</span><span class="nv">dz</span><span class="p">,</span> <span class="s1">&#39;dz =&#39;</span><span class="p">,</span> <span class="nv">dz</span>
        <span class="nv">string</span> <span class="o">=</span> <span class="s2">&quot;MD region lengths must be an integer number of CFD &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
                 <span class="s2">&quot;cell sizes (i.e. xL_md must be an integer multiple &quot;</span> <span class="o">//</span> <span class="p">&amp;</span>
                 <span class="s2">&quot;of dx, etc. ), aborting simulation.&quot;</span>
        <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="nv">string</span><span class="p">)</span>

    <span class="k">end if</span> 

    <span class="c">! Check whether ncx,ncy,ncz are an integer multiple of npx_md, etc.</span>
    <span class="c">! - N.B. no need to check ncy/npy_md.</span>
    <span class="nv">ival</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nv">ival</span> <span class="o">=</span> <span class="nv">ival</span> <span class="o">+</span> <span class="nb">mod</span><span class="p">(</span><span class="nv">ncx</span><span class="p">,</span><span class="nv">npx_cfd</span><span class="p">)</span>
    <span class="nv">ival</span> <span class="o">=</span> <span class="nv">ival</span> <span class="o">+</span> <span class="nb">mod</span><span class="p">(</span><span class="nv">ncy</span><span class="p">,</span><span class="nv">npy_cfd</span><span class="p">)</span>
    <span class="nv">ival</span> <span class="o">=</span> <span class="nv">ival</span> <span class="o">+</span> <span class="nb">mod</span><span class="p">(</span><span class="nv">ncz</span><span class="p">,</span><span class="nv">npz_cfd</span><span class="p">)</span>
    <span class="nv">ival</span> <span class="o">=</span> <span class="nv">ival</span> <span class="o">+</span> <span class="nb">mod</span><span class="p">(</span><span class="nv">ncx</span><span class="p">,</span><span class="nv">npx_md</span><span class="p">)</span>
    <span class="nv">ival</span> <span class="o">=</span> <span class="nv">ival</span> <span class="o">+</span> <span class="nb">mod</span><span class="p">(</span><span class="nv">ncz</span><span class="p">,</span><span class="nv">npz_md</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">ival</span><span class="ow">.ne.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then </span>

<span class="k">        </span><span class="nv">string</span> <span class="o">=</span> <span class="s2">&quot;The number of cells in the cfd domain is not an &quot;</span>    <span class="o">//</span> <span class="p">&amp;</span>
                 <span class="s2">&quot;integer multiple of the number of processors in &quot;</span>    <span class="o">//</span> <span class="p">&amp;</span>
                 <span class="s2">&quot;the x and z directions. Aborting simulation.&quot;</span> 
        <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="nv">string</span><span class="p">)</span>

    <span class="k">end if</span>

    <span class="c">! Check that the MD region is large enough to cover overlap</span>
    <span class="nv">xL_olap</span> <span class="o">=</span> <span class="nv">ncx_olap</span> <span class="o">*</span> <span class="nv">dx</span>
    <span class="nv">yL_olap</span> <span class="o">=</span> <span class="nv">ncy_olap</span> <span class="o">*</span> <span class="nv">dy</span>
    <span class="nv">zL_olap</span> <span class="o">=</span> <span class="nv">ncz_olap</span> <span class="o">*</span> <span class="nv">dz</span>
    <span class="c">! Tolerance of half a cell width</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">xL_md</span> <span class="ow">.lt.</span> <span class="p">(</span><span class="nv">xL_olap</span> <span class="o">-</span> <span class="nv">dx</span><span class="o">/</span><span class="mf">2.</span><span class="nv">d0</span><span class="p">)</span> <span class="ow">.or.</span> <span class="p">&amp;</span>
        <span class="nv">yL_md</span> <span class="ow">.lt.</span> <span class="p">(</span><span class="nv">yL_olap</span> <span class="o">-</span> <span class="nv">dy</span><span class="o">/</span><span class="mf">2.</span><span class="nv">d0</span><span class="p">)</span> <span class="ow">.or.</span> <span class="p">&amp;</span>
        <span class="nv">zL_md</span> <span class="ow">.lt.</span> <span class="p">(</span><span class="nv">zL_olap</span> <span class="o">-</span> <span class="nv">dz</span><span class="o">/</span><span class="mf">2.</span><span class="nv">d0</span><span class="p">)</span>      <span class="p">)</span> <span class="k">then</span>

<span class="k">        </span><span class="nv">string</span> <span class="o">=</span> <span class="s2">&quot;Overlap region is larger than the MD region. &quot;</span>       <span class="o">//</span> <span class="p">&amp;</span>
                 <span class="s2">&quot;Aborting simulation.&quot;</span>
        <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="nv">string</span><span class="p">)</span>

    <span class="k">end if</span>

    <span class="c">! Check overlap cells are within CFD extents</span>
    <span class="nv">ival</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">icmin_olap</span><span class="ow">.lt.</span><span class="nv">icmin</span><span class="p">)</span> <span class="nv">ival</span> <span class="o">=</span> <span class="nv">ival</span> <span class="o">+</span> <span class="mi">1</span>        
    <span class="k">if</span> <span class="p">(</span><span class="nv">icmax_olap</span><span class="ow">.gt.</span><span class="nv">icmax</span><span class="p">)</span> <span class="nv">ival</span> <span class="o">=</span> <span class="nv">ival</span> <span class="o">+</span> <span class="mi">1</span>        
    <span class="k">if</span> <span class="p">(</span><span class="nv">jcmin_olap</span><span class="ow">.lt.</span><span class="nv">jcmin</span><span class="p">)</span> <span class="nv">ival</span> <span class="o">=</span> <span class="nv">ival</span> <span class="o">+</span> <span class="mi">1</span>        
    <span class="k">if</span> <span class="p">(</span><span class="nv">jcmax_olap</span><span class="ow">.gt.</span><span class="nv">jcmax</span><span class="p">)</span> <span class="nv">ival</span> <span class="o">=</span> <span class="nv">ival</span> <span class="o">+</span> <span class="mi">1</span>        
    <span class="k">if</span> <span class="p">(</span><span class="nv">kcmin_olap</span><span class="ow">.lt.</span><span class="nv">kcmin</span><span class="p">)</span> <span class="nv">ival</span> <span class="o">=</span> <span class="nv">ival</span> <span class="o">+</span> <span class="mi">1</span>        
    <span class="k">if</span> <span class="p">(</span><span class="nv">kcmax_olap</span><span class="ow">.gt.</span><span class="nv">kcmax</span><span class="p">)</span> <span class="nv">ival</span> <span class="o">=</span> <span class="nv">ival</span> <span class="o">+</span> <span class="mi">1</span>        
    <span class="k">if</span> <span class="p">(</span><span class="nv">ival</span><span class="ow">.ne.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        print</span><span class="s1">&#39;(a,6i10)&#39;</span><span class="p">,</span> <span class="s1">&#39;ijkcmin,ijkcmax = &#39;</span> <span class="p">,</span> <span class="nv">icmin</span><span class="p">,</span> <span class="nv">icmax</span> <span class="p">&amp;</span> 
                            <span class="p">,</span> <span class="nv">jcmin</span><span class="p">,</span> <span class="nv">jcmax</span> <span class="p">&amp;</span>
                            <span class="p">,</span> <span class="nv">kcmin</span><span class="p">,</span> <span class="nv">kcmax</span>
        <span class="k">print</span><span class="s1">&#39;(a,6i10)&#39;</span><span class="p">,</span> <span class="s1">&#39;olap extents    = &#39;</span><span class="p">,</span> <span class="nv">icmin_olap</span><span class="p">,</span> <span class="nv">icmax_olap</span><span class="p">,</span> <span class="nv">jcmin_olap</span><span class="p">,</span> <span class="p">&amp;</span>
                                   <span class="nv">jcmax_olap</span><span class="p">,</span> <span class="nv">kcmin_olap</span><span class="p">,</span> <span class="nv">kcmax_olap</span>
        <span class="nv">string</span> <span class="o">=</span> <span class="s2">&quot;Overlap region has been specified outside of the &quot;</span>  <span class="o">//</span> <span class="p">&amp;</span>
                 <span class="s2">&quot;CFD region. Aborting simulation.&quot;</span>
        <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="nv">string</span><span class="p">)</span>
    <span class="k">end if</span>
    
    <span class="c">! Check MD/CFD ratios are integers in x and z</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">mod</span><span class="p">(</span><span class="nv">npx_md</span><span class="p">,</span><span class="nv">npx_cfd</span><span class="p">)</span> <span class="ow">.ne.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        print</span><span class="s1">&#39;(a,i8,a,i8)&#39;</span><span class="p">,</span> <span class="s1">&#39; number of MD processors in x &#39;</span><span class="p">,</span> <span class="nv">npx_md</span><span class="p">,</span>     <span class="p">&amp;</span> 
                            <span class="s1">&#39; number of CFD processors in x &#39;</span><span class="p">,</span> <span class="nv">npx_cfd</span>

        <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;get_overlap_blocks error - number of MD &quot;</span>    <span class="o">//</span> <span class="p">&amp;</span> 
                         <span class="s2">&quot;processors in x must be an integer multiple &quot;</span><span class="o">//</span> <span class="p">&amp;</span>
                         <span class="s2">&quot;of number of CFD processors in x&quot;</span><span class="p">)</span>

    <span class="nv">elseif</span> <span class="p">(</span><span class="nb">mod</span><span class="p">(</span><span class="nv">npz_md</span><span class="p">,</span><span class="nv">npz_cfd</span><span class="p">)</span> <span class="ow">.ne.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        print</span><span class="s1">&#39;(a,i8,a,i8)&#39;</span><span class="p">,</span> <span class="s1">&#39; number of MD processors in z &#39;</span><span class="p">,</span> <span class="nv">npz_md</span><span class="p">,</span>     <span class="p">&amp;</span> 
                            <span class="s1">&#39; number of CFD processors in z &#39;</span><span class="p">,</span> <span class="nv">npz_cfd</span>

        <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;get_overlap_blocks error - number of MD &quot;</span>    <span class="o">//</span> <span class="p">&amp;</span>
                         <span class="s2">&quot;processors in z must be an integer multiple &quot;</span><span class="o">//</span> <span class="p">&amp;</span>
                         <span class="s2">&quot;of number of CFD processors in z&quot;</span><span class="p">)</span>

    <span class="k">endif</span>

<span class="k">end subroutine </span><span class="nv">check_config_feasibility</span>


<span class="c">!------------------------------------------------------------</span>
<span class="c">!Calculate processor cell ranges of MD code on all processors</span>
<span class="c">!------------------------------------------------------------------------------</span>
<span class="c">!                      GET MD CELL RANGES                                     -</span>
<span class="c">!------------------------------------------------------------------------------</span>
<span class="c">!&gt;</span>
<span class="c">!! Store the minimum and maximum CFD cell coordinates that overlap each</span>
<span class="c">!! MD processor.   </span>
<span class="c">!!</span>
<span class="c">!! - Synopsis</span>
<span class="c">!!</span>
<span class="c">!!  - get_md_cell_ranges()</span>
<span class="c">!!</span>
<span class="c">!! - Input</span>
<span class="c">!!  - NONE </span>
<span class="c">!! - Input/Output</span>
<span class="c">!!  - NONE </span>
<span class="c">!! - Output</span>
<span class="c">!!  - NONE </span>
<span class="c">!! </span>
<span class="c">!! @author David Trevelyan </span>
<span class="k">subroutine </span><span class="nv">get_md_cell_ranges</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">n</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">olap_jmin_mdcoord</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">ncxl</span><span class="p">,</span> <span class="nv">nczl</span><span class="c">!, ncyl</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">ncy_mdonly</span><span class="p">,</span> <span class="nv">ncy_md</span><span class="p">,</span> <span class="nv">ncyP_md</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">funit</span>

    <span class="k">allocate</span><span class="p">(</span><span class="nv">icPmin_md</span><span class="p">(</span><span class="nv">npx_md</span><span class="p">));</span> <span class="nv">icPmin_md</span> <span class="o">=</span> <span class="nv">VOID</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">jcPmin_md</span><span class="p">(</span><span class="nv">npy_md</span><span class="p">));</span> <span class="nv">jcPmin_md</span> <span class="o">=</span> <span class="nv">VOID</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">kcPmin_md</span><span class="p">(</span><span class="nv">npz_md</span><span class="p">));</span> <span class="nv">kcPmin_md</span> <span class="o">=</span> <span class="nv">VOID</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">icPmax_md</span><span class="p">(</span><span class="nv">npx_md</span><span class="p">));</span> <span class="nv">icPmax_md</span> <span class="o">=</span> <span class="nv">VOID</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">jcPmax_md</span><span class="p">(</span><span class="nv">npy_md</span><span class="p">));</span> <span class="nv">jcPmax_md</span> <span class="o">=</span> <span class="nv">VOID</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">kcPmax_md</span><span class="p">(</span><span class="nv">npz_md</span><span class="p">));</span> <span class="nv">kcPmax_md</span> <span class="o">=</span> <span class="nv">VOID</span>

    <span class="c">! - - x - -</span>
    <span class="nv">ncxl</span> <span class="o">=</span> <span class="nb">ceiling</span><span class="p">(</span><span class="nb">dble</span><span class="p">(</span><span class="nv">ncx</span><span class="p">)</span><span class="o">/</span><span class="nb">dble</span><span class="p">(</span><span class="nv">npx_md</span><span class="p">))</span>
    <span class="k">do </span><span class="nv">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nv">npx_md</span>
        <span class="nv">icPmax_md</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span> <span class="o">=</span> <span class="nv">n</span> <span class="o">*</span> <span class="nv">ncxl</span>
        <span class="nv">icPmin_md</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span> <span class="o">=</span> <span class="nv">icPmax_md</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span> <span class="o">-</span> <span class="nv">ncxl</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">end do</span>  

    <span class="c">! - - y - -</span>
    <span class="nv">ncy_md</span>   <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="nv">yL_md</span><span class="o">/</span><span class="nv">dy</span><span class="p">)</span>
    <span class="nv">ncy_mdonly</span> <span class="o">=</span> <span class="nv">ncy_md</span> <span class="o">-</span> <span class="nv">ncy_olap</span>
    <span class="nv">ncyP_md</span> <span class="o">=</span> <span class="nv">ncy_md</span> <span class="o">/</span> <span class="nv">npy_md</span>
    <span class="nv">olap_jmin_mdcoord</span> <span class="o">=</span> <span class="nv">npy_md</span> <span class="o">-</span> <span class="nb">ceiling</span><span class="p">(</span><span class="nb">dble</span><span class="p">(</span><span class="nv">ncy_olap</span><span class="p">)</span><span class="o">/</span><span class="nb">dble</span><span class="p">(</span><span class="nv">ncyP_md</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">do </span><span class="nv">n</span> <span class="o">=</span> <span class="nv">olap_jmin_mdcoord</span><span class="p">,</span><span class="nv">npy_md</span>
        <span class="nv">jcPmax_md</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span> <span class="o">=</span> <span class="nv">n</span> <span class="o">*</span> <span class="nv">ncyP_md</span> <span class="o">-</span> <span class="nv">ncy_mdonly</span>
        <span class="nv">jcPmin_md</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span> <span class="o">=</span> <span class="nv">jcPmax_md</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span> <span class="o">-</span> <span class="nv">ncyP_md</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">jcPmin_md</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span><span class="ow">.le.</span><span class="mi">0</span><span class="p">)</span> <span class="nv">jcPmin_md</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">end do</span>  

    <span class="c">! - - z - -</span>
    <span class="nv">nczl</span> <span class="o">=</span> <span class="nb">ceiling</span><span class="p">(</span><span class="nb">dble</span><span class="p">(</span><span class="nv">ncz</span><span class="p">)</span><span class="o">/</span><span class="nb">dble</span><span class="p">(</span><span class="nv">npz_md</span><span class="p">))</span>
    <span class="k">do </span><span class="nv">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nv">npz_md</span>
        <span class="nv">kcPmax_md</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span> <span class="o">=</span> <span class="nv">n</span> <span class="o">*</span> <span class="nv">nczl</span>
        <span class="nv">kcPmin_md</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span> <span class="o">=</span> <span class="nv">kcPmax_md</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span> <span class="o">-</span> <span class="nv">nczl</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">end do</span>

<span class="k">    if</span> <span class="p">(</span><span class="nv">myid_world</span> <span class="ow">.eq.</span> <span class="nv">rootid_world</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        </span><span class="nv">funit</span> <span class="o">=</span> <span class="nv">CPL_new_fileunit</span><span class="p">()</span>
        <span class="k">open</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span> <span class="nv">file</span><span class="o">=</span><span class="s2">&quot;cpl/map_MD&quot;</span><span class="p">,</span> <span class="nv">action</span><span class="o">=</span><span class="s2">&quot;write&quot;</span><span class="p">,</span> <span class="nv">status</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;===========================================&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;------------ M D   M A P ------------------&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;===========================================&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;npx_md = &#39;</span><span class="p">,</span> <span class="nv">npx_md</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;ncx    = &#39;</span><span class="p">,</span> <span class="nv">ncx</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;ncxl   = &#39;</span><span class="p">,</span> <span class="nv">ncxl</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;  icoord_md     icPmin_md     icPmax_md    &#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
        <span class="k">do </span><span class="nv">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nv">npx_md</span>
            <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="s1">&#39;(1x,3i11)&#39;</span><span class="p">),</span> <span class="nv">n</span><span class="p">,</span> <span class="nv">icPmin_md</span><span class="p">(</span><span class="nv">n</span><span class="p">),</span> <span class="nv">icPmax_md</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span>
        <span class="k">end do  </span>
<span class="k">        write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;npy_md     = &#39;</span><span class="p">,</span> <span class="nv">npy_md</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;ncy_md     = &#39;</span><span class="p">,</span> <span class="nv">ncy_md</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;ncyP_md    = &#39;</span><span class="p">,</span> <span class="nv">ncyP_md</span> 
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;ncy_olap   = &#39;</span><span class="p">,</span> <span class="nv">ncy_olap</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;ncy_mdonly = &#39;</span><span class="p">,</span> <span class="nv">ncy_mdonly</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;olap_jmin_mdcoord = &#39;</span><span class="p">,</span> <span class="nv">olap_jmin_mdcoord</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;dy         = &#39;</span><span class="p">,</span> <span class="nv">dy</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;  jcoord_md     jcPmin_md       jcPmax_md  &#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
        <span class="k">do </span><span class="nv">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">npy_md</span> 
            <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="s1">&#39;(1x,3i11)&#39;</span><span class="p">)</span> <span class="nv">n</span><span class="p">,</span> <span class="nv">jcPmin_md</span><span class="p">(</span><span class="nv">n</span><span class="p">),</span> <span class="nv">jcPmax_md</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span>
        <span class="k">end do</span>
<span class="k">        write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;npz_md = &#39;</span><span class="p">,</span> <span class="nv">npz_md</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;ncz    = &#39;</span><span class="p">,</span> <span class="nv">ncz</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;nczl   = &#39;</span><span class="p">,</span> <span class="nv">nczl</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;  kcoord_md     kcPmin_md       kcPmax_md  &#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
        <span class="k">do </span><span class="nv">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nv">npz_md</span>
            <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="s1">&#39;(1x,3i11)&#39;</span><span class="p">),</span> <span class="nv">n</span><span class="p">,</span> <span class="nv">kcPmin_md</span><span class="p">(</span><span class="nv">n</span><span class="p">),</span> <span class="nv">kcPmax_md</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span>
        <span class="k">end do</span>
<span class="k">        write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
        <span class="k">close</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span> <span class="nv">status</span><span class="o">=</span><span class="s2">&quot;keep&quot;</span><span class="p">)</span>

    <span class="k">endif</span>

    <span class="c">!Sanity Check min not less than max</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">icPmin_md</span><span class="p">(</span><span class="nv">iblock_realm</span><span class="p">)</span> <span class="ow">.gt.</span> <span class="nv">icPmax_md</span><span class="p">(</span><span class="nv">iblock_realm</span><span class="p">))</span> <span class="p">&amp;</span> 
        <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;Error in get_md_cell_ranges - mapping failure imin greater than imax&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">jcPmin_md</span><span class="p">(</span><span class="nv">jblock_realm</span><span class="p">)</span> <span class="ow">.gt.</span> <span class="nv">jcPmax_md</span><span class="p">(</span><span class="nv">jblock_realm</span><span class="p">))</span> <span class="p">&amp;</span>
        <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;Error in get_md_cell_ranges - mapping failure jmin greater than jmax&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">kcPmin_md</span><span class="p">(</span><span class="nv">kblock_realm</span><span class="p">)</span> <span class="ow">.gt.</span> <span class="nv">kcPmax_md</span><span class="p">(</span><span class="nv">kblock_realm</span><span class="p">))</span> <span class="p">&amp;</span> 
        <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s2">&quot;Error in get_md_cell_ranges - mapping failure kmin greater than kmax&quot;</span><span class="p">)</span>

<span class="k">end subroutine </span><span class="nv">get_md_cell_ranges</span>

<span class="c">!------------------------------------------------------------</span>
<span class="c">!Calculate processor overlap between CFD/MD on all processors</span>

<span class="c">!------------------------------------------------------------------------------</span>
<span class="c">!                          GET OVERLAP BLOCKS                                 -</span>
<span class="c">!------------------------------------------------------------------------------</span>
<span class="c">!&gt;</span>
<span class="c">!! Store MD processor coordinates that overlap each CFD processor coordinate. </span>
<span class="c">!!</span>
<span class="c">!! - Synopsis</span>
<span class="c">!!</span>
<span class="c">!!  - get_overlap_blocks()</span>
<span class="c">!!</span>
<span class="c">!! - Input</span>
<span class="c">!!  - NONE </span>
<span class="c">!! - Input/Output</span>
<span class="c">!!  - NONE </span>
<span class="c">!! - Output</span>
<span class="c">!!  - NONE </span>
<span class="c">!! </span>
<span class="c">!! @author David Trevelyan</span>
<span class="k">subroutine </span><span class="nv">get_overlap_blocks</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span>             <span class="kd">::</span> <span class="nv">i</span><span class="p">,</span><span class="nv">n</span><span class="p">,</span><span class="nv">endproc</span><span class="p">,</span><span class="nv">nolapsx</span><span class="p">,</span><span class="nv">nolapsy</span><span class="p">,</span><span class="nv">nolapsz</span>
    <span class="kt">integer</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="kd">::</span> <span class="nv">pcoords</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">funit</span>

    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">))</span>    <span class="kd">::</span> <span class="nv">xLl_md</span><span class="p">,</span> <span class="nv">yLl_md</span><span class="p">,</span> <span class="nv">zLl_md</span><span class="p">,</span> <span class="nv">yLl_cfd</span>

    <span class="nv">xL_olap</span> <span class="o">=</span> <span class="nv">ncx_olap</span> <span class="o">*</span> <span class="nv">dx</span> 
    <span class="nv">yL_olap</span> <span class="o">=</span> <span class="nv">ncy_olap</span> <span class="o">*</span> <span class="nv">dy</span> 
    <span class="nv">zL_olap</span> <span class="o">=</span> <span class="nv">ncz_olap</span> <span class="o">*</span> <span class="nv">dz</span> 

    <span class="nv">xLl_md</span>  <span class="o">=</span> <span class="nv">xL_md</span> <span class="o">/</span> <span class="nv">npx_md</span>
    <span class="nv">yLl_md</span>  <span class="o">=</span> <span class="nv">yL_md</span> <span class="o">/</span> <span class="nv">npy_md</span>
    <span class="nv">zLl_md</span>  <span class="o">=</span> <span class="nv">zL_md</span> <span class="o">/</span> <span class="nv">npz_md</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">realm</span> <span class="ow">.eq.</span> <span class="nv">md_realm</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="nv">xLl</span> <span class="o">=</span> <span class="nv">xLl_md</span><span class="p">;</span> <span class="nv">yLl</span> <span class="o">=</span> <span class="nv">yLl_md</span> <span class="p">;</span> <span class="nv">zLl</span> <span class="o">=</span> <span class="nv">zLl_md</span> 
    <span class="k">endif</span>

<span class="k">    </span><span class="nv">nolapsx</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span> <span class="nb">dble</span><span class="p">(</span> <span class="nv">npx_md</span> <span class="p">)</span> <span class="o">/</span> <span class="nb">dble</span><span class="p">(</span> <span class="nv">npx_cfd</span> <span class="p">)</span> <span class="p">)</span>
    <span class="nv">nolapsy</span> <span class="o">=</span> <span class="nb">ceiling</span> <span class="p">(</span> <span class="nv">yL_olap</span> <span class="o">/</span> <span class="nv">yLl_md</span> <span class="p">)</span> 
    <span class="nv">nolapsz</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span> <span class="nb">dble</span><span class="p">(</span> <span class="nv">npz_md</span> <span class="p">)</span> <span class="o">/</span> <span class="nb">dble</span><span class="p">(</span> <span class="nv">npz_cfd</span> <span class="p">)</span> <span class="p">)</span>

    <span class="c">!Get cartesian coordinate of overlapping md cells &amp; cfd cells</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">cfd_icoord2olap_md_icoords</span><span class="p">(</span><span class="nv">npx_cfd</span><span class="p">,</span><span class="nv">nolapsx</span><span class="p">))</span> 
    <span class="k">allocate</span><span class="p">(</span><span class="nv">cfd_jcoord2olap_md_jcoords</span><span class="p">(</span><span class="nv">npy_cfd</span><span class="p">,</span><span class="nv">nolapsy</span><span class="p">))</span> 
    <span class="k">allocate</span><span class="p">(</span><span class="nv">cfd_kcoord2olap_md_kcoords</span><span class="p">(</span><span class="nv">npz_cfd</span><span class="p">,</span><span class="nv">nolapsz</span><span class="p">))</span> 
    <span class="nv">cfd_icoord2olap_md_icoords</span> <span class="o">=</span> <span class="nv">VOID</span>
    <span class="nv">cfd_jcoord2olap_md_jcoords</span> <span class="o">=</span> <span class="nv">VOID</span>
    <span class="nv">cfd_kcoord2olap_md_kcoords</span> <span class="o">=</span> <span class="nv">VOID</span>

    <span class="c">! - - x - -</span>
    <span class="k">do </span><span class="nv">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">npx_cfd</span>
    <span class="k">do </span><span class="nv">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">nolapsx</span>    
        <span class="nv">cfd_icoord2olap_md_icoords</span><span class="p">(</span><span class="nv">n</span><span class="p">,</span><span class="nv">i</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nv">nolapsx</span> <span class="o">+</span> <span class="nv">i</span>
    <span class="k">end do</span>
<span class="k">    end do</span>

    <span class="c">! - - y - -</span>
    <span class="nv">yLl_cfd</span> <span class="o">=</span> <span class="nv">yL_cfd</span><span class="o">/</span><span class="nv">npy_cfd</span>
    <span class="nv">endproc</span> <span class="o">=</span> <span class="nb">ceiling</span><span class="p">(</span><span class="nv">yL_olap</span><span class="o">/</span><span class="nv">yLl_cfd</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">endproc</span> <span class="ow">.gt.</span> <span class="nv">npy_cfd</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;Warning in get_overlap_blocks -- top processor in CFD greater than number&quot;</span>
        <span class="k">print</span><span class="o">*</span><span class="p">,</span>  <span class="s2">&quot;  of processors. This may be correct if some MD domain exists above CFD.&quot;</span>
        <span class="nv">endproc</span> <span class="o">=</span> <span class="nv">npy_cfd</span>
        <span class="nv">nolapsy</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="nv">endproc</span><span class="p">,</span> <span class="nv">nolapsy</span>
    <span class="k">endif</span>
<span class="k">    do </span><span class="nv">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">endproc</span>
    <span class="k">do </span><span class="nv">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">nolapsy</span>
        <span class="nv">cfd_jcoord2olap_md_jcoords</span><span class="p">(</span><span class="nv">n</span><span class="p">,</span><span class="nv">i</span><span class="p">)</span> <span class="o">=</span>   <span class="p">(</span><span class="nv">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nv">nolapsy</span> <span class="o">+</span> <span class="nv">i</span> <span class="p">&amp;</span>
                                          <span class="o">+</span> <span class="p">(</span><span class="nv">npy_md</span> <span class="o">-</span> <span class="nv">nolapsy</span><span class="p">)</span>
    <span class="k">end do</span>
<span class="k">    end do</span>


    <span class="c">! - - z - -</span>
    <span class="k">do </span><span class="nv">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">npz_cfd</span>
    <span class="k">do </span><span class="nv">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">nolapsz</span>    
        <span class="nv">cfd_kcoord2olap_md_kcoords</span><span class="p">(</span><span class="nv">n</span><span class="p">,</span><span class="nv">i</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nv">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nv">nolapsz</span> <span class="o">+</span> <span class="nv">i</span>
    <span class="k">end do</span>
<span class="k">    end do</span>


<span class="k">    if</span> <span class="p">(</span><span class="nv">myid_world</span> <span class="ow">.eq.</span> <span class="nv">rootid_world</span><span class="p">)</span> <span class="k">then </span>
<span class="k">    </span>
<span class="k">        </span><span class="nv">funit</span> <span class="o">=</span> <span class="nv">CPL_new_fileunit</span><span class="p">()</span>
        <span class="k">open</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span> <span class="nv">file</span><span class="o">=</span><span class="s2">&quot;cpl/map_CFD&quot;</span><span class="p">,</span> <span class="nv">action</span><span class="o">=</span><span class="s2">&quot;write&quot;</span><span class="p">,</span> <span class="nv">status</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;===========================================&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;------------ C F D   M A P ----------------&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;===========================================&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;npx_cfd = &#39;</span><span class="p">,</span> <span class="nv">npx_cfd</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;nolapsx = &#39;</span><span class="p">,</span> <span class="nv">nolapsx</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;  icoord_cfd       olapmin     olapmax     &#39;</span> 
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
        <span class="k">do </span><span class="nv">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nv">npx_cfd</span>
            <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="s1">&#39;(1x,3i11)&#39;</span><span class="p">),</span> <span class="nv">n</span><span class="p">,</span>               <span class="p">&amp;</span>
                  <span class="nv">cfd_icoord2olap_md_icoords</span><span class="p">(</span><span class="nv">n</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>         <span class="p">&amp;</span>
                  <span class="nv">cfd_icoord2olap_md_icoords</span><span class="p">(</span><span class="nv">n</span><span class="p">,</span><span class="nv">nolapsx</span><span class="p">)</span>
        <span class="k">end do  </span>
<span class="k">        write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>

        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;npy_cfd = &#39;</span><span class="p">,</span> <span class="nv">npy_cfd</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;nolapsy = &#39;</span><span class="p">,</span> <span class="nv">nolapsy</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;  jcoord_cfd       olapmin     olapmax     &#39;</span> 
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
        <span class="k">do </span><span class="nv">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nv">npy_cfd</span>
            <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="s1">&#39;(1x,3i11)&#39;</span><span class="p">),</span> <span class="nv">n</span><span class="p">,</span>               <span class="p">&amp;</span>
                  <span class="nv">cfd_jcoord2olap_md_jcoords</span><span class="p">(</span><span class="nv">n</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>         <span class="p">&amp;</span>
                  <span class="nv">cfd_jcoord2olap_md_jcoords</span><span class="p">(</span><span class="nv">n</span><span class="p">,</span><span class="nv">nolapsy</span><span class="p">)</span>
        <span class="k">end do  </span>
<span class="k">        write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>

        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;npz_cfd = &#39;</span><span class="p">,</span> <span class="nv">npz_cfd</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;nolapsz = &#39;</span><span class="p">,</span> <span class="nv">nolapsz</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;  kcoord_cfd       olapmin     olapmax     &#39;</span> 
        <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
        <span class="k">do </span><span class="nv">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nv">npz_cfd</span>
            <span class="k">write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="s1">&#39;(1x,3i11)&#39;</span><span class="p">),</span> <span class="nv">n</span><span class="p">,</span>               <span class="p">&amp;</span>
                  <span class="nv">cfd_kcoord2olap_md_kcoords</span><span class="p">(</span><span class="nv">n</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>         <span class="p">&amp;</span>
                  <span class="nv">cfd_kcoord2olap_md_kcoords</span><span class="p">(</span><span class="nv">n</span><span class="p">,</span><span class="nv">nolapsz</span><span class="p">)</span>
        <span class="k">end do  </span>
<span class="k">        write</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
        <span class="k">close</span><span class="p">(</span><span class="nv">funit</span><span class="p">,</span> <span class="nv">status</span><span class="o">=</span><span class="s2">&quot;keep&quot;</span><span class="p">)</span>

    <span class="k">endif</span>

<span class="k">end subroutine </span><span class="nv">get_overlap_blocks</span>

<span class="c">!subroutine intersect_comm</span>
<span class="c">!   use coupler_module</span>
<span class="c">!   use mpi</span>
<span class="c">!   implicit none</span>

<span class="c">!   integer :: n</span>
<span class="c">!   integer,dimension(3)   :: pcoords</span>

    <span class="c">!Create communicator for all intersecting processors</span>
<span class="c">!   if (realm .eq. cfd_realm) then</span>
<span class="c">!       map%n = npx_md/npx_cfd</span>
<span class="c">!       allocate(map%rank_list(map%n))</span>
        <span class="c">!Get rank(s) of overlapping MD processor(s)</span>
<span class="c">!       do n = 1,map%n</span>
<span class="c">!           pcoords(1)=cfd_icoord2olap_md_icoords(rank2coord_cfd(1,rank_realm),n)</span>
<span class="c">!           pcoords(2)=cfd_jcoord2olap_md_jcoords(rank2coord_cfd(2,rank_realm),n)</span>
<span class="c">!           pcoords(3)=cfd_kcoord2olap_md_kcoords(rank2coord_cfd(3,rank_realm),n)</span>
<span class="c">!           if (any(pcoords(:).eq.VOID)) then</span>
<span class="c">!               map%n = 0; map%rank_list(:) = VOID</span>
<span class="c">!           else</span>
<span class="c">!               map%rank_list(n) = coord2rank_md(pcoords(1),pcoords(2),pcoords(3))</span>
<span class="c">!           endif</span>
<span class="c">!           write(250+rank_realm,&#39;(2a,6i5)&#39;), &#39;overlap&#39;,realm_name(realm),rank_realm,map%n,map%rank_list(n),pcoords</span>
<span class="c">!       enddo</span>
<span class="c">!   else if (realm .eq. md_realm) then</span>
<span class="c">!       map%n = 1</span>
<span class="c">!       allocate(map%rank_list(map%n))  </span>
        <span class="c">!Get rank of overlapping CFD processor</span>
<span class="c">!       pcoords(1) = rank2coord_md(1,rank_realm)*(dble(npx_cfd)/dble(npx_md))</span>
<span class="c">!       pcoords(2) = npy_cfd !rank2coord_md(2,rank_realm)*(dble(npy_cfd)/dble(npy_md))</span>
<span class="c">!       pcoords(3) = rank2coord_md(3,rank_realm)*(dble(npz_cfd)/dble(npz_md))</span>
<span class="c">!!      map%rank_list(1) = coord2rank_cfd(pcoords(1),pcoords(2),pcoords(3))</span>
<span class="c">!       write(300+rank_realm,&#39;(2a,6i5)&#39;), &#39;overlap&#39;,realm_name(realm),rank_realm,map%n,map%rank_list(1),pcoords</span>
<span class="c">!   endif</span>

<span class="c">!end subroutine intersect_comm</span>

<span class="c">!=========================================================================</span>

<span class="c">!------------------------------------------------------------------------------</span>
<span class="c">!                    PREPARE OVERLAP COMMS                                    -</span>
<span class="c">!------------------------------------------------------------------------------</span>
<span class="c">!&gt;</span>
<span class="c">!! @author David Trevelyan </span>
<span class="c">!! Splits the world communicator into &quot;overlap&quot; communicators. Each overlap </span>
<span class="c">!! communicator consists of a CFD root processor and the MD processors which</span>
<span class="c">!! lie on top of it in the domain. </span>
<span class="c">!!</span>
<span class="c">!! - Synopsis</span>
<span class="c">!!</span>
<span class="c">!!  - prepare_overlap_comms()</span>
<span class="c">!!</span>
<span class="c">!! - Input</span>
<span class="c">!!  - NONE</span>
<span class="c">!! - Input/Output</span>
<span class="c">!!  - NONE </span>
<span class="c">!! - Output</span>
<span class="c">!!  - NONE </span>
<span class="c">!! </span>
<span class="k">subroutine </span><span class="nv">prepare_overlap_comms</span>
    <span class="k">use </span><span class="nv">mpi</span>
    <span class="k">implicit none</span>

    <span class="c">!General idea:</span>
    <span class="c">!   1. loop over cfd cart ranks</span>
    <span class="c">!   2. find cfd cart coords from cfd cart rank</span>
    <span class="c">!   3. find overlapping md cart coords (from cfd_icoord2olap_md_icoords)</span>
    <span class="c">!   4. find md cart rank from md cart coords (coord2rank_md) </span>
    <span class="c">!   5. find md world rank from md cart rank (rank_mdcart2rank_world)</span>
    <span class="c">!   6. set group(md_world_rank) to cfd cart rank</span>
    <span class="c">!   7. split world comm according to groups</span>
    <span class="c">!      if group(world_rank) == 0, set olap_comm to null </span>

    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">i</span><span class="p">,</span><span class="nv">j</span><span class="p">,</span><span class="nv">k</span><span class="p">,</span><span class="nv">ic</span><span class="p">,</span><span class="nv">jc</span><span class="p">,</span><span class="nv">kc</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">trank_md</span><span class="p">,</span> <span class="nv">trank_cfd</span><span class="p">,</span> <span class="nv">trank_world</span><span class="p">,</span> <span class="nv">nolap</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="nv">mdicoords</span><span class="p">,</span> <span class="nv">mdjcoords</span><span class="p">,</span> <span class="nv">mdkcoords</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="nv">olap_null</span> <span class="o">=</span> <span class="o">-</span><span class="mi">666</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">group</span><span class="p">(</span><span class="nv">nproc_world</span><span class="p">)</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">cfdcoord</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">tempsize</span>

    <span class="nv">tempsize</span> <span class="o">=</span> <span class="nv">size</span><span class="p">(</span><span class="nv">cfd_icoord2olap_md_icoords</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">mdicoords</span><span class="p">(</span><span class="nv">tempsize</span><span class="p">))</span>
    <span class="nv">tempsize</span> <span class="o">=</span> <span class="nv">size</span><span class="p">(</span><span class="nv">cfd_jcoord2olap_md_jcoords</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">mdjcoords</span><span class="p">(</span><span class="nv">tempsize</span><span class="p">))</span>
    <span class="nv">tempsize</span> <span class="o">=</span> <span class="nv">size</span><span class="p">(</span><span class="nv">cfd_kcoord2olap_md_kcoords</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">allocate</span><span class="p">(</span><span class="nv">mdkcoords</span><span class="p">(</span><span class="nv">tempsize</span><span class="p">))</span>

    <span class="k">allocate</span><span class="p">(</span><span class="nv">olap_mask</span><span class="p">(</span><span class="nv">nproc_world</span><span class="p">))</span>

    <span class="c">!Set default values, must be done because coord2rank_md cannot</span>
    <span class="c">!take &quot;null&quot; coordinates.</span>
    <span class="nv">group</span><span class="p">(:)</span> <span class="o">=</span> <span class="nv">olap_null</span>
    <span class="nv">olap_mask</span><span class="p">(:)</span> <span class="o">=</span> <span class="nb">.false.</span>
    <span class="nv">nolap</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c">! Every process loop over all cfd ranks</span>
    <span class="k">do </span><span class="nv">trank_cfd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">nproc_cfd</span>

        <span class="c">! Get cart coords of cfd rank</span>
        <span class="nv">cfdcoord</span><span class="p">(:)</span>  <span class="o">=</span> <span class="nv">rank2coord_cfd</span><span class="p">(:,</span><span class="nv">trank_cfd</span><span class="p">)</span>

        <span class="c">! Get md cart coords overlapping cfd proc</span>
        <span class="nv">mdicoords</span><span class="p">(:)</span> <span class="o">=</span> <span class="nv">cfd_icoord2olap_md_icoords</span><span class="p">(</span><span class="nv">cfdcoord</span><span class="p">(</span><span class="mi">1</span><span class="p">),:)</span>
        <span class="nv">mdjcoords</span><span class="p">(:)</span> <span class="o">=</span> <span class="nv">cfd_jcoord2olap_md_jcoords</span><span class="p">(</span><span class="nv">cfdcoord</span><span class="p">(</span><span class="mi">2</span><span class="p">),:)</span>
        <span class="nv">mdkcoords</span><span class="p">(:)</span> <span class="o">=</span> <span class="nv">cfd_kcoord2olap_md_kcoords</span><span class="p">(</span><span class="nv">cfdcoord</span><span class="p">(</span><span class="mi">3</span><span class="p">),:)</span>

        <span class="c">! Set group and olap_mask for CFD processor if it overlaps</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="nv">mdicoords</span><span class="ow">.ne.</span><span class="nv">olap_null</span><span class="p">)</span> <span class="ow">.and.</span> <span class="p">&amp;</span>
            <span class="nb">any</span><span class="p">(</span><span class="nv">mdjcoords</span><span class="ow">.ne.</span><span class="nv">olap_null</span><span class="p">)</span> <span class="ow">.and.</span> <span class="p">&amp;</span>
            <span class="nb">any</span><span class="p">(</span><span class="nv">mdkcoords</span><span class="ow">.ne.</span><span class="nv">olap_null</span><span class="p">))</span> <span class="k">then</span>

<span class="k">            </span><span class="nv">trank_world</span> <span class="o">=</span> <span class="nv">rank_cfdcart2rank_world</span><span class="p">(</span><span class="nv">trank_cfd</span><span class="p">)</span>
            <span class="nv">olap_mask</span><span class="p">(</span><span class="nv">trank_world</span><span class="p">)</span> <span class="o">=</span> <span class="nb">.true.</span>
            <span class="nv">group</span>    <span class="p">(</span><span class="nv">trank_world</span><span class="p">)</span> <span class="o">=</span> <span class="nv">trank_cfd</span>

        <span class="k">end if</span>

        <span class="c">! Set group and olap_mask for MD processors</span>
        <span class="k">do </span><span class="nv">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">size</span><span class="p">(</span><span class="nv">mdicoords</span><span class="p">)</span>
        <span class="k">do </span><span class="nv">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">size</span><span class="p">(</span><span class="nv">mdjcoords</span><span class="p">)</span>
        <span class="k">do </span><span class="nv">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">size</span><span class="p">(</span><span class="nv">mdkcoords</span><span class="p">)</span>

            <span class="nv">ic</span> <span class="o">=</span> <span class="nv">mdicoords</span><span class="p">(</span><span class="nv">i</span><span class="p">)</span>
            <span class="nv">jc</span> <span class="o">=</span> <span class="nv">mdjcoords</span><span class="p">(</span><span class="nv">j</span><span class="p">)</span>
            <span class="nv">kc</span> <span class="o">=</span> <span class="nv">mdkcoords</span><span class="p">(</span><span class="nv">k</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">((</span><span class="o">/</span><span class="nv">ic</span><span class="p">,</span><span class="nv">jc</span><span class="p">,</span><span class="nv">kc</span><span class="o">/</span><span class="p">)</span><span class="ow">.eq.</span><span class="nv">olap_null</span><span class="p">))</span> <span class="k">cycle</span>

<span class="k">            </span><span class="nv">trank_md</span> <span class="o">=</span> <span class="nv">coord2rank_md</span><span class="p">(</span><span class="nv">ic</span><span class="p">,</span><span class="nv">jc</span><span class="p">,</span><span class="nv">kc</span><span class="p">)</span>
            <span class="nv">trank_world</span> <span class="o">=</span> <span class="nv">rank_mdcart2rank_world</span><span class="p">(</span><span class="nv">trank_md</span><span class="p">)</span>

            <span class="nv">olap_mask</span><span class="p">(</span><span class="nv">trank_world</span><span class="p">)</span> <span class="o">=</span> <span class="nb">.true.</span>
            <span class="nv">group</span>    <span class="p">(</span><span class="nv">trank_world</span><span class="p">)</span> <span class="o">=</span> <span class="nv">trank_cfd</span>
            
        <span class="k">end do</span>
<span class="k">        end do  </span>
<span class="k">        end do</span>


<span class="k">    end do</span>
<span class="k">    </span>
<span class="k">    call </span><span class="nv">MPI_Barrier</span><span class="p">(</span><span class="nv">CPL_REALM_COMM</span><span class="p">,</span> <span class="nv">ierr</span><span class="p">)</span>

    <span class="c">! Split world Comm into a set of comms for overlapping processors</span>
    <span class="k">call </span><span class="nv">MPI_comm_split</span><span class="p">(</span><span class="nv">CPL_WORLD_COMM</span><span class="p">,</span><span class="nv">group</span><span class="p">(</span><span class="nv">rank_world</span><span class="p">),</span><span class="nv">realm</span><span class="p">,</span> <span class="p">&amp;</span>
                        <span class="nv">CPL_OLAP_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>

    <span class="c">!Setup Overlap comm sizes and id</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">realm</span><span class="ow">.eq.</span><span class="nv">cfd_realm</span><span class="p">)</span> <span class="nv">CFDid_olap</span> <span class="o">=</span> <span class="nv">myid_olap</span>
    <span class="k">call </span><span class="nv">MPI_bcast</span><span class="p">(</span><span class="nv">CFDid_olap</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">CFDid_olap</span><span class="p">,</span><span class="nv">CPL_OLAP_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>

    <span class="c">! USED ONLY FOR OUTPUT/TESTING??</span>
    <span class="c">!if (myid_olap .eq. CFDid_olap) testval = group(rank_world)</span>
    <span class="c">!call MPI_bcast(testval,1,MPI_INTEGER,CFDid_olap,CPL_OLAP_COMM,ierr)</span>

    <span class="c">! Set all non-overlapping processors to MPI_COMM_NULL</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">olap_mask</span><span class="p">(</span><span class="nv">rank_world</span><span class="p">)</span><span class="ow">.eqv.</span><span class="nb">.false.</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="nv">myid_olap</span> <span class="o">=</span> <span class="nv">olap_null</span>
        <span class="nv">rank_olap</span> <span class="o">=</span> <span class="nv">olap_null</span>
        <span class="nv">CPL_OLAP_COMM</span> <span class="o">=</span> <span class="nv">MPI_COMM_NULL</span>
    <span class="k">end if</span>

    <span class="c">!Setup overlap map</span>
    <span class="k">call </span><span class="nv">CPL_rank_map</span><span class="p">(</span><span class="nv">CPL_OLAP_COMM</span><span class="p">,</span><span class="nv">rank_olap</span><span class="p">,</span><span class="nv">nproc_olap</span><span class="p">,</span> <span class="p">&amp;</span> 
                      <span class="nv">rank_olap2rank_world</span><span class="p">,</span><span class="nv">rank_world2rank_olap</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="nv">myid_olap</span> <span class="o">=</span> <span class="nv">rank_olap</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">deallocate</span><span class="p">(</span><span class="nv">mdicoords</span><span class="p">)</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="nv">mdjcoords</span><span class="p">)</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="nv">mdkcoords</span><span class="p">)</span>
    
    <span class="c">!if (realm.eq.md_realm) call write_overlap_comms_md</span>

<span class="k">end subroutine </span><span class="nv">prepare_overlap_comms</span>

<span class="c">!=========================================================================</span>
<span class="c">!Setup topology graph of overlaps between CFD &amp; MD processors</span>

<span class="k">subroutine </span><span class="nv">CPL_overlap_topology</span>
    <span class="k">use </span><span class="nv">mpi</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span>                             <span class="kd">::</span> <span class="nv">i</span><span class="p">,</span> <span class="nv">n</span><span class="p">,</span> <span class="nv">nconnections</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span>   <span class="kd">::</span> <span class="nb">index</span><span class="p">,</span> <span class="nv">edges</span>
    <span class="kt">logical</span>                             <span class="kd">::</span> <span class="nv">reorder</span>

    <span class="c">!Allow optimisations of ordering</span>
    <span class="nv">reorder</span> <span class="o">=</span> <span class="nb">.true.</span>

    <span class="c">!Get number of processors in communicating overlap region </span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">olap_mask</span><span class="p">(</span><span class="nv">rank_world</span><span class="p">)</span><span class="ow">.eqv.</span><span class="nb">.true.</span><span class="p">)</span> <span class="k">then</span>

        <span class="c">!CFD processor is root and has mapping to all MD processors</span>
        <span class="k">allocate</span><span class="p">(</span><span class="nb">index</span><span class="p">(</span><span class="nv">nproc_olap</span><span class="p">))</span>         <span class="c">! Index for each processor</span>
        <span class="k">allocate</span><span class="p">(</span><span class="nv">edges</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="nv">nproc_olap</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>   <span class="c">! nproc_olap-1 for CFD and one for</span>
                                            <span class="c">! each of nproc_olap MD processors</span>
        <span class="nb">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="nv">edges</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c">!CFD processor has connections to nproc_olap MD processors</span>
        <span class="nv">nconnections</span> <span class="o">=</span> <span class="nv">nproc_olap</span><span class="o">-</span><span class="mi">1</span>
        <span class="nb">index</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nv">nconnections</span>
        <span class="k">do </span><span class="nv">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">nconnections</span>
            <span class="nv">edges</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span> <span class="o">=</span> <span class="nv">n</span> <span class="c">!olap_list(n+1) !CFD connected to all MD processors 1 to nconnections</span>
        <span class="nv">enddo</span>

        <span class="c">!MD processor has a single connection to CFD</span>
        <span class="nv">nconnections</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">i</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">do </span><span class="nv">n</span> <span class="o">=</span> <span class="nv">nproc_olap</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="nv">nproc_olap</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="nb">index</span><span class="p">(</span><span class="nv">i</span><span class="p">)</span> <span class="o">=</span> <span class="nb">index</span><span class="p">(</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nv">nconnections</span> <span class="c">!Each successive index incremented by one</span>
            <span class="nv">edges</span><span class="p">(</span><span class="nv">n</span><span class="p">)</span> <span class="o">=</span> <span class="nv">CFDid_olap</span>   <span class="c">!Connected to CFD processor</span>
            <span class="nv">i</span> <span class="o">=</span> <span class="nv">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="nv">enddo</span>

        <span class="c">!Create graph topology for overlap region</span>
        <span class="k">call </span><span class="nv">MPI_Graph_create</span><span class="p">(</span><span class="nv">CPL_OLAP_COMM</span><span class="p">,</span> <span class="nv">nproc_olap</span><span class="p">,</span><span class="nb">index</span><span class="p">,</span><span class="nv">edges</span><span class="p">,</span><span class="nv">reorder</span><span class="p">,</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">CPL_GRAPH_COMM</span> <span class="o">=</span> <span class="nv">MPI_COMM_NULL</span>
    <span class="k">endif</span>

    <span class="c">! Setup graph map</span>
    <span class="k">call </span><span class="nv">CPL_rank_map</span><span class="p">(</span><span class="nv">CPL_GRAPH_COMM</span><span class="p">,</span><span class="nv">rank_graph</span><span class="p">,</span><span class="nv">nproc_olap</span><span class="p">,</span> <span class="p">&amp;</span> 
                     <span class="nv">rank_graph2rank_world</span><span class="p">,</span><span class="nv">rank_world2rank_graph</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="nv">myid_graph</span> <span class="o">=</span> <span class="nv">rank_graph</span> <span class="o">-</span> <span class="mi">1</span>

<span class="k">end subroutine </span><span class="nv">CPL_overlap_topology</span>


<span class="k">subroutine </span><span class="nv">print_overlap_comms</span>
    <span class="k">use </span><span class="nv">mpi</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="nv">trank</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">myid_world</span><span class="ow">.eq.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        write</span><span class="p">(</span><span class="mi">7500</span><span class="o">+</span><span class="nv">rank_realm</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="mi">7500</span><span class="o">+</span><span class="nv">rank_realm</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;----------- OVERLAP COMMS INFO ------------&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="mi">7500</span><span class="o">+</span><span class="nv">rank_realm</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="mi">7500</span><span class="o">+</span><span class="nv">rank_realm</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;        RANKS              BROADCAST TEST  &#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="mi">7500</span><span class="o">+</span><span class="nv">rank_realm</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;  world  realm  olap      testval( = group)&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="mi">7500</span><span class="o">+</span><span class="nv">rank_realm</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------------------------------------------&#39;</span>
    <span class="k">end if</span>
<span class="k">    </span>
<span class="k">    do </span><span class="nv">trank</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="nv">nproc_world</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">rank_world</span><span class="ow">.eq.</span><span class="nv">trank</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="mi">7500</span><span class="o">+</span><span class="nv">rank_realm</span><span class="p">,</span><span class="s1">&#39;(3i7,i16)&#39;</span><span class="p">),</span> <span class="nv">rank_world</span><span class="p">,</span><span class="nv">rank_realm</span><span class="p">,</span> <span class="p">&amp;</span>
                                <span class="nv">rank_olap</span><span class="p">,</span> <span class="nv">testval</span>  
        <span class="k">end if</span>
<span class="k">    end do</span>

<span class="k">    if</span> <span class="p">(</span><span class="nv">myid_world</span><span class="ow">.eq.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        write</span><span class="p">(</span><span class="mi">7500</span><span class="o">+</span><span class="nv">rank_realm</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;-------- END OVERLAP COMMS INFO  ----------&#39;</span>
        <span class="k">write</span><span class="p">(</span><span class="mi">7500</span><span class="o">+</span><span class="nv">rank_realm</span><span class="p">,</span><span class="o">*</span><span class="p">),</span> <span class="s1">&#39;===========================================&#39;</span>
    <span class="k">end if</span>
<span class="k">    </span>
<span class="k">end subroutine </span><span class="nv">print_overlap_comms</span>

<span class="k">end subroutine </span><span class="nv">CPL_create_map</span>

<span class="c">!=============================================================================</span>
<span class="c">!   Adjust CFD domain size to an integer number of lattice units used by  </span>
<span class="c">!   MD if sizes are given in sigma units</span>
<span class="c">!-----------------------------------------------------------------------------</span>

<span class="k">subroutine </span><span class="nv">CPL_cfd_adjust_domain</span><span class="p">(</span><span class="nv">xL</span><span class="p">,</span> <span class="nv">yL</span><span class="p">,</span> <span class="nv">zL</span><span class="p">,</span> <span class="nv">nx</span><span class="p">,</span> <span class="nv">ny</span><span class="p">,</span> <span class="nv">nz</span><span class="p">,</span> <span class="nv">density_output</span><span class="p">)</span>
    <span class="k">use </span><span class="nv">mpi</span>
    <span class="c">!use coupler_module, only : density_cfd,CPL_REALM_COMM, rank_realm, ierr</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">,</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">inout</span><span class="p">)</span>            <span class="kd">::</span> <span class="nv">nx</span><span class="p">,</span> <span class="nv">ny</span><span class="p">,</span> <span class="nv">nz</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">inout</span><span class="p">)</span>   <span class="kd">::</span> <span class="nv">xL</span><span class="p">,</span><span class="nv">yL</span><span class="p">,</span><span class="nv">zL</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">optional</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">inout</span><span class="p">)</span>   <span class="kd">::</span> <span class="nv">density_output</span>

    <span class="c">! Internal variables</span>
    <span class="kt">integer</span>                                     <span class="kd">::</span> <span class="nv">ierror</span><span class="p">,</span> <span class="nv">root</span>
    <span class="c">!character(1)                                :: direction</span>
    <span class="kt">logical</span>                                     <span class="kd">::</span> <span class="nv">changed</span>

    <span class="c">!Define root processes</span>
    <span class="nv">root</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="nv">density_output</span> <span class="o">=</span> <span class="nv">density_cfd</span>

    <span class="c">! Check CFD domain and MD domain are compatible sizes to allow a</span>
    <span class="c">! stable initial MD lattice structure - resize if possible or</span>
    <span class="c">! stop code and demand a regeneration of grid if vary by more than 0.01</span>
    <span class="nv">changed</span> <span class="o">=</span> <span class="nb">.false.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">xL</span><span class="p">))</span> <span class="k">then</span>
<span class="k">        call </span><span class="nv">init_length</span><span class="p">(</span><span class="nv">xL</span><span class="p">,</span><span class="nv">resize</span><span class="o">=</span><span class="nb">.true.</span><span class="p">,</span><span class="nv">direction</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
                         <span class="nv">print_warning</span><span class="o">=</span><span class="nv">changed</span><span class="p">)</span>
    <span class="k">endif</span>

    <span class="c">! No need to adjust y because we can adjust DY in MD to</span>
    <span class="c">! have an integer number of FCC units. ??????? What</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">zL</span><span class="p">))</span> <span class="k">then</span>
<span class="k">        call </span><span class="nv">init_length</span><span class="p">(</span><span class="nv">zL</span><span class="p">,</span><span class="nv">resize</span><span class="o">=</span><span class="nb">.true.</span><span class="p">,</span><span class="nv">direction</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
                         <span class="nv">print_warning</span><span class="o">=</span><span class="nv">changed</span><span class="p">)</span>
    <span class="k">endif</span>

<span class="k">    if</span> <span class="p">(</span> <span class="nv">changed</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">        print</span><span class="o">*</span><span class="p">,</span> <span class="s2">&quot;Regenerate Grid with corrected sizes as above&quot;</span>
        <span class="k">call </span><span class="nv">MPI_Abort</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span><span class="nv">ierror</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="k">endif</span>

    <span class="c">! check id CFD cell sizes are larger than 2*sigma </span>
    <span class="k">call </span><span class="nv">test_cfd_cell_sizes</span>

<span class="k">contains</span>

<span class="c">!-----------------------------------------------------------------------------</span>

<span class="k">subroutine </span><span class="nv">init_length</span><span class="p">(</span><span class="nv">rout</span><span class="p">,</span><span class="nv">resize</span><span class="p">,</span><span class="nv">direction</span><span class="p">,</span><span class="nv">print_warning</span><span class="p">)</span>
    <span class="c">!use coupler_module, only: dx,dy,dz,error_abort</span>
    <span class="k">implicit none</span>
<span class="k">            </span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">intent</span><span class="p">(</span><span class="nv">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">rout</span>
    <span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>                  <span class="kd">::</span> <span class="nv">resize</span>
    <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>              <span class="kd">::</span> <span class="nv">direction</span>
    <span class="kt">logical</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>                  <span class="kd">::</span> <span class="nv">print_warning</span>

    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">))</span> <span class="kd">::</span> <span class="nv">dxyz</span>  <span class="c">! dx, dy or dz</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">))</span> <span class="kd">::</span> <span class="nv">rinit</span> <span class="c">! initial val of rout or rin for print</span>

    <span class="nv">print_warning</span><span class="o">=</span><span class="nb">.false.</span>

    <span class="k">select case</span> <span class="p">(</span><span class="nv">direction</span><span class="p">)</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
        <span class="nv">dxyz</span> <span class="o">=</span> <span class="nv">dx</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
        <span class="nv">dxyz</span> <span class="o">=</span> <span class="nv">dy</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span>
        <span class="nv">dxyz</span> <span class="o">=</span> <span class="nv">dz</span>
    <span class="k">case </span><span class="nv">default</span>
        <span class="k">call </span><span class="nv">error_abort</span><span class="p">(</span><span class="s1">&#39;Wrong direction specified in init_length&#39;</span><span class="p">)</span>
    <span class="k">end select</span>

<span class="k">    if</span> <span class="p">(</span> <span class="nv">resize</span> <span class="p">)</span> <span class="k">then</span>

<span class="k">        </span><span class="nv">rinit</span> <span class="o">=</span> <span class="nv">rout</span>
        <span class="nv">rout</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="nb">nint</span><span class="p">(</span><span class="nv">rout</span><span class="o">/</span><span class="nv">dxyz</span><span class="p">),</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">))</span><span class="o">*</span><span class="nv">dxyz</span>
        <span class="nv">print_warning</span> <span class="o">=</span> <span class="nb">.true.</span>
        <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="nv">direction</span><span class="p">,</span> <span class="s1">&#39;dxyz = &#39;</span><span class="p">,</span> <span class="nv">dxyz</span> 

    <span class="k">endif</span>

<span class="k">    if</span> <span class="p">(</span><span class="nv">print_warning</span><span class="p">)</span> <span class="k">then</span> 

        <span class="c">!if (rank_realm .eq. root) then </span>

            <span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(3(a,/),3a,/,2(a,f20.10),/a,/,a)&#39;</span><span class="p">)</span> <span class="p">&amp;</span>
                    <span class="s2">&quot;*********************************************************************&quot;</span><span class="p">,</span>    <span class="p">&amp;</span>
                    <span class="s2">&quot;WARNING - this is a coupled run which resets CFD domain size         &quot;</span><span class="p">,</span>    <span class="p">&amp;</span>
                    <span class="s2">&quot; to an integer number of MD initial cells:                           &quot;</span><span class="p">,</span>    <span class="p">&amp;</span>
                    <span class="s2">&quot;   Domain resized in the &quot;</span><span class="p">,</span> <span class="nv">direction</span><span class="p">,</span> <span class="s2">&quot; direction                   &quot;</span><span class="p">,</span>    <span class="p">&amp;</span>
                    <span class="s2">&quot; inital size =&quot;</span><span class="p">,</span> <span class="nv">rinit</span><span class="p">,</span> <span class="s2">&quot; resized &quot;</span><span class="p">,</span> <span class="nv">rout</span><span class="p">,</span>                                 <span class="p">&amp;</span>
                    <span class="s2">&quot;                                                                     &quot;</span><span class="p">,</span>    <span class="p">&amp;</span> 
                    <span class="s2">&quot;*********************************************************************&quot;</span>   
        <span class="c">!endif</span>

        <span class="c">!If resize is insignificant then return flag print_warning as false</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nv">rinit</span><span class="o">-</span><span class="nv">rout</span><span class="p">)</span> <span class="ow">.lt.</span> <span class="mf">0.01</span><span class="p">)</span> <span class="nv">print_warning</span> <span class="o">=</span> <span class="nb">.false.</span>

    <span class="k">end if</span>
<span class="k">    </span>
<span class="k">end subroutine </span><span class="nv">init_length</span>

<span class="c">!-----------------------------------------------------------------------------</span>

<span class="k">subroutine </span><span class="nv">test_cfd_cell_sizes</span>
    <span class="k">implicit none</span>

<span class="k">    if</span> <span class="p">(</span><span class="nv">rank_realm</span> <span class="ow">.eq.</span> <span class="nv">root</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">xL</span><span class="p">)</span> <span class="ow">.and.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">nx</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            if</span> <span class="p">(</span><span class="nv">xL</span><span class="o">/</span><span class="nv">nx</span> <span class="o">&lt;</span> <span class="mf">2.0</span><span class="nv">d0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="s2">&quot; WARNING: CFD cell size in x direction is less that 2 * sigma. Does this make sense?&quot;</span> 
                <span class="k">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="s2">&quot;          xL=&quot;</span><span class="p">,</span><span class="nv">xL</span><span class="p">,</span><span class="s2">&quot;nx=&quot;</span><span class="p">,</span><span class="nv">nx</span>
            <span class="k">endif</span>
<span class="k">        endif</span>

<span class="k">        if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">yL</span><span class="p">)</span> <span class="ow">.and.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">ny</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            if</span> <span class="p">(</span><span class="nv">yL</span><span class="o">/</span><span class="nv">ny</span> <span class="o">&lt;</span> <span class="mf">2.0</span><span class="nv">d0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="s2">&quot; WARNING: CFD cell size in y direction is less that 2 * sigma. Does this make sense?&quot;</span> 
                <span class="k">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="s2">&quot;          yL=&quot;</span><span class="p">,</span><span class="nv">yL</span><span class="p">,</span><span class="s2">&quot;nx=&quot;</span><span class="p">,</span><span class="nv">ny</span>
            <span class="k">endif</span>
<span class="k">        endif</span>

<span class="k">        if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">zL</span><span class="p">)</span> <span class="ow">.and.</span> <span class="nb">present</span><span class="p">(</span><span class="nv">nz</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            if</span> <span class="p">(</span><span class="nv">zL</span><span class="o">/</span><span class="nv">nz</span> <span class="o">&lt;</span> <span class="mf">2.0</span><span class="nv">d0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="s2">&quot; WARNING: CFD cell size in z direction is less that 2 * sigma. Does this make sense?&quot;</span> 
                <span class="k">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="s2">&quot;          zL=&quot;</span><span class="p">,</span><span class="nv">zL</span><span class="p">,</span><span class="s2">&quot;nx=&quot;</span><span class="p">,</span><span class="nv">nz</span>
            <span class="k">endif</span>
<span class="k">        endif</span>
<span class="k">    end if</span>
<span class="k">        </span>
<span class="k">end subroutine </span><span class="nv">test_cfd_cell_sizes</span>
            
<span class="k">end subroutine </span><span class="nv">CPL_cfd_adjust_domain</span>



<span class="c">!-------------------------------------------------------------------</span>
<span class="c">!                   CPL_rank_map                                   -</span>
<span class="c">!-------------------------------------------------------------------</span>

<span class="c">! Get COMM map for current communicator and relationship to </span>
<span class="c">! world rank used to link to others in the coupler hierachy</span>

<span class="c">! - - - Synopsis - - -</span>

<span class="c">! CPL_rank_map(COMM, rank, comm2world, world2comm, ierr)</span>

<span class="c">! - - - Input Parameters - - -</span>

<span class="c">!comm</span>
<span class="c">!    communicator with cartesian structure (handle) </span>

<span class="c">! - - - Output Parameter - - -</span>

<span class="c">!rank</span>
<span class="c">!    rank of a process within group of comm (integer)</span>
<span class="c">!    NOTE - fortran convention rank=1 to nproc  </span>
<span class="c">!nproc</span>
<span class="c">!    number of processes within group of comm (integer) </span>
<span class="c">!comm2world</span>
<span class="c">!   Array of size nproc_world which for element at </span>
<span class="c">!   world_rank has local rank in COMM</span>
<span class="c">!world2comm</span>
<span class="c">!   Array of size nproc_COMM which for element at </span>
<span class="c">!   for local ranks in COMM has world rank </span>
<span class="c">!ierr</span>
<span class="c">!    error flag</span>


<span class="k">subroutine </span><span class="nv">CPL_rank_map</span><span class="p">(</span><span class="nv">COMM</span><span class="p">,</span><span class="nv">rank</span><span class="p">,</span><span class="nv">nproc</span><span class="p">,</span><span class="nv">comm2world</span><span class="p">,</span><span class="nv">world2comm</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="c">!use coupler_module, only : rank_world, nproc_world, CPL_WORLD_COMM, VOID</span>
    <span class="k">use </span><span class="nv">mpi</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>                             <span class="kd">::</span> <span class="nv">COMM</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>                            <span class="kd">::</span> <span class="nv">rank</span><span class="p">,</span><span class="nv">nproc</span><span class="p">,</span><span class="nv">ierr</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>   <span class="kd">::</span> <span class="nv">comm2world</span><span class="p">,</span><span class="nv">world2comm</span>

    <span class="k">allocate</span><span class="p">(</span><span class="nv">world2comm</span><span class="p">(</span> <span class="nv">nproc_world</span><span class="p">))</span>
    <span class="nv">world2comm</span><span class="p">(</span> <span class="nv">nproc_world</span><span class="p">)</span> <span class="o">=</span> <span class="nv">VOID</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">COMM</span> <span class="ow">.ne.</span> <span class="nv">MPI_COMM_NULL</span><span class="p">)</span> <span class="k">then</span>

        <span class="c">!Mapping from comm rank to world rank</span>
        <span class="k">call </span><span class="nv">MPI_comm_rank</span><span class="p">(</span><span class="nv">COMM</span><span class="p">,</span><span class="nv">rank</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
        <span class="nv">rank</span> <span class="o">=</span> <span class="nv">rank</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">call </span><span class="nv">MPI_comm_size</span><span class="p">(</span><span class="nv">COMM</span><span class="p">,</span><span class="nv">nproc</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
        <span class="k">allocate</span><span class="p">(</span><span class="nv">comm2world</span><span class="p">(</span><span class="nv">nproc</span><span class="p">))</span>
        <span class="k">call </span><span class="nv">MPI_allgather</span><span class="p">(</span><span class="nv">rank_world</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span> <span class="p">&amp;</span> 
                           <span class="nv">comm2world</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="k">else</span>
<span class="k">        </span><span class="nv">rank</span> <span class="o">=</span> <span class="nv">VOID</span>
        <span class="k">allocate</span><span class="p">(</span><span class="nv">comm2world</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">endif</span>

    <span class="c">!Mapping from world rank to comm rank</span>
    <span class="k">call </span><span class="nv">MPI_allgather</span><span class="p">(</span><span class="nv">rank</span>      <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span> <span class="p">&amp;</span> 
                       <span class="nv">world2comm</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">MPI_INTEGER</span><span class="p">,</span><span class="nv">CPL_WORLD_COMM</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>

<span class="k">end subroutine </span><span class="nv">CPL_rank_map</span>

<span class="c">!---------------------------------------------------</span>
<span class="c">! Locate file in input</span>

<span class="k">subroutine </span><span class="nv">locate</span><span class="p">(</span><span class="nv">fileid</span><span class="p">,</span><span class="nv">keyword</span><span class="p">,</span><span class="nv">have_data</span><span class="p">)</span>
    <span class="k">implicit none</span>
<span class="k">    </span>
<span class="k">    </span><span class="kt">integer</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span>          <span class="kd">::</span> <span class="nv">fileid</span>               <span class="c">! File unit number</span>
    <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">keyword</span>              <span class="c">! Input keyword </span>
    <span class="kt">logical</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="nv">out</span><span class="p">)</span>         <span class="kd">::</span> <span class="nv">have_data</span>            <span class="c">! Flag: input found</span>

    <span class="kt">character</span><span class="o">*</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>             <span class="kd">::</span> <span class="nv">linestring</span>           <span class="c">! First 100 chars</span>
    <span class="kt">integer</span>                     <span class="kd">::</span> <span class="nv">keyword_length</span>       <span class="c">! Length of keyword</span>
    <span class="kt">integer</span>                     <span class="kd">::</span> <span class="nv">io</span>                   <span class="c">! File status flag</span>

    <span class="nv">keyword_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nv">keyword</span><span class="p">)</span>
    <span class="k">rewind</span><span class="p">(</span><span class="nv">fileid</span><span class="p">)</span>
    
    <span class="c">! Loop until end of file or keyword found</span>
    <span class="k">do</span>
        <span class="c">! Read first 100 characters of line</span>
        <span class="k">read</span> <span class="p">(</span><span class="nv">fileid</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">,</span><span class="nv">iostat</span><span class="o">=</span><span class="nv">io</span><span class="p">)</span> <span class="nv">linestring</span>

        <span class="c">! If end of file is reached, exit</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">io</span><span class="ow">.ne.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then </span>
<span class="k">            </span><span class="nv">have_data</span> <span class="o">=</span> <span class="nb">.false.</span>
            <span class="k">exit</span>
<span class="k">        end if</span>
        
        <span class="c">! If the first characters match keyword, exit</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">linestring</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="nv">keyword_length</span><span class="p">)</span><span class="ow">.eq.</span><span class="nv">keyword</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            </span><span class="nv">have_data</span> <span class="o">=</span> <span class="nb">.true.</span>
            <span class="k">exit</span>
<span class="k">        endif</span>

<span class="k">    end do</span>

<span class="k">end subroutine </span><span class="nv">locate</span>

<span class="c">!===========================================================================</span>
<span class="c">!Error handling subroutines</span>

<span class="k">subroutine </span><span class="nv">error_abort_s</span><span class="p">(</span><span class="nv">msg</span><span class="p">)</span>
    <span class="k">use </span><span class="nv">mpi</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">),</span> <span class="k">optional</span> <span class="kd">::</span> <span class="nv">msg</span>
   
    <span class="kt">integer </span><span class="nv">errcode</span><span class="p">,</span><span class="nv">ierr</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">msg</span><span class="p">))</span> <span class="k">then </span>
<span class="k">        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">msg</span>
    <span class="k">endif</span>

<span class="k">    call </span><span class="nv">MPI_Abort</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span><span class="nv">errcode</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>

<span class="k">end subroutine </span><span class="nv">error_abort_s</span>


<span class="k">subroutine </span><span class="nv">error_abort_si</span><span class="p">(</span><span class="nv">msg</span><span class="p">,</span><span class="nv">i</span><span class="p">)</span>
    <span class="k">use </span><span class="nv">mpi</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">msg</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span> <span class="kd">::</span> <span class="nv">i</span>

    <span class="kt">integer </span><span class="nv">errcode</span><span class="p">,</span><span class="nv">ierr</span>

    <span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">msg</span><span class="p">,</span><span class="nv">i</span>

    <span class="k">call </span><span class="nv">MPI_Abort</span><span class="p">(</span><span class="nv">MPI_COMM_WORLD</span><span class="p">,</span><span class="nv">errcode</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>

<span class="k">end subroutine </span><span class="nv">error_abort_si</span>


<span class="k">subroutine </span><span class="nv">messenger_lasterrorcheck</span>
    <span class="k">use </span><span class="nv">mpi</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer </span><span class="nv">resultlen</span>
    <span class="kt">character</span><span class="o">*</span><span class="mi">12</span> <span class="nv">err_buffer</span>

    <span class="k">call </span><span class="nv">MPI_Error_string</span><span class="p">(</span><span class="nv">ierr</span><span class="p">,</span><span class="nv">err_buffer</span><span class="p">,</span><span class="nv">resultlen</span><span class="p">,</span><span class="nv">ierr</span><span class="p">)</span>
    <span class="k">print</span><span class="o">*</span><span class="p">,</span> <span class="nv">err_buffer</span>

<span class="k">end subroutine </span><span class="nv">messenger_lasterrorcheck</span>


<span class="c">!--------------------------------------------------------------------------------------</span>
<span class="c">! Prints formatted debug statements</span>
<span class="k">subroutine </span><span class="nv">printf</span><span class="p">(</span><span class="nv">buf</span><span class="p">,</span><span class="nv">dplaces_in</span><span class="p">)</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">)</span><span class="kd">::</span> <span class="nv">buf</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="nv">in</span><span class="p">),</span> <span class="k">optional</span>           <span class="kd">::</span> <span class="nv">dplaces_in</span>

    <span class="kt">integer</span>             <span class="kd">::</span> <span class="nv">n</span><span class="p">,</span><span class="nv">dplaces</span><span class="p">,</span> <span class="nv">space</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">))</span>    <span class="kd">::</span> <span class="nv">maxbuf</span><span class="p">,</span><span class="nv">minbuf</span><span class="p">,</span><span class="nv">order</span>
    <span class="kt">character</span><span class="o">*</span><span class="mi">19</span>        <span class="kd">::</span> <span class="nv">string</span>
    <span class="kt">character</span><span class="o">*</span><span class="mi">42</span>        <span class="kd">::</span> <span class="nv">buf_precision</span>

    <span class="nv">space</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c">!Default number of decimal places if not supplied</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nv">dplaces_in</span><span class="p">))</span> <span class="k">then</span>
<span class="k">        if</span> <span class="p">(</span><span class="nv">dplaces_in</span> <span class="ow">.le.</span> <span class="mi">9</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            </span><span class="nv">dplaces</span> <span class="o">=</span> <span class="nv">dplaces_in</span>
        <span class="k">else</span>
<span class="k">            print</span><span class="o">*</span><span class="p">,</span> <span class="s1">&#39;Number of decimal places in printf if limited to 9&#39;</span>
            <span class="nv">dplaces</span> <span class="o">=</span> <span class="mi">9</span> <span class="c">!Maximum</span>
        <span class="k">endif</span>
<span class="k">    else</span>
<span class="k">        </span><span class="nv">dplaces</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">endif</span>

    <span class="c">!Find out required format to display maximum element in buffer</span>
    <span class="nv">maxbuf</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="nv">buf</span><span class="p">);</span> <span class="nv">minbuf</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="nv">buf</span><span class="p">)</span>
    <span class="nv">maxbuf</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nv">maxbuf</span><span class="p">,</span><span class="mi">10</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="nv">minbuf</span><span class="p">))</span> <span class="c">!10*Ensures extra space for minus sign</span>
    <span class="nv">order</span> <span class="o">=</span> <span class="mf">1.</span><span class="nv">d0</span><span class="p">;</span> <span class="nv">n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">do while</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nv">maxbuf</span><span class="p">,</span><span class="nv">order</span><span class="p">)</span> <span class="ow">.ne.</span> <span class="nv">order</span><span class="p">)</span>
        <span class="nv">order</span> <span class="o">=</span> <span class="nv">order</span><span class="o">*</span><span class="mi">1</span><span class="mf">0.</span><span class="nv">d0</span>
        <span class="nv">n</span> <span class="o">=</span> <span class="nv">n</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nv">enddo</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">maxbuf</span> <span class="ow">.lt.</span> <span class="mf">0.</span><span class="nv">d0</span> <span class="ow">.and.</span> <span class="nv">maxbuf</span> <span class="ow">.gt.</span> <span class="o">-</span><span class="mf">1.</span><span class="nv">d0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="nv">n</span> <span class="o">=</span> <span class="nv">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="c">!For the case of -0.something</span>
    <span class="k">endif</span>
<span class="k">    if</span> <span class="p">(</span><span class="nv">n</span><span class="o">+</span><span class="nv">dplaces</span><span class="o">+</span><span class="nv">space</span> <span class="ow">.le.</span> <span class="mi">9</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        write</span><span class="p">(</span><span class="nv">buf_precision</span><span class="p">,</span><span class="s1">&#39;(a,i1,a,i1)&#39;</span><span class="p">),</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span><span class="nv">n</span><span class="o">+</span><span class="nv">dplaces</span><span class="o">+</span><span class="nv">space</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="nv">dplaces</span>
    <span class="k">else</span>
<span class="k">        write</span><span class="p">(</span><span class="nv">buf_precision</span><span class="p">,</span><span class="s1">&#39;(a,i2,a,i1)&#39;</span><span class="p">),</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span><span class="nv">n</span><span class="o">+</span><span class="nv">dplaces</span><span class="o">+</span><span class="nv">space</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="nv">dplaces</span>
    <span class="k">endif</span>

    <span class="c">! Build up format specifier string based on size of passed array</span>
    <span class="nv">string</span><span class="o">=</span><span class="s1">&#39;(a6,i3,   &#39;</span> <span class="o">//</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">buf_precision</span><span class="p">)</span> <span class="o">//</span> <span class="s1">&#39;)&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="nv">string</span><span class="p">(</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">),</span><span class="s1">&#39;(i3)&#39;</span><span class="p">),</span> <span class="nv">size</span><span class="p">(</span><span class="nv">buf</span><span class="p">)</span> 

    <span class="c">!Write formatted data </span>
    <span class="k">print</span><span class="p">(</span><span class="nv">string</span><span class="p">),</span><span class="s1">&#39;printf&#39;</span><span class="p">,</span><span class="nv">rank_world</span><span class="p">,</span><span class="nv">buf</span>

<span class="k">end subroutine </span><span class="nv">printf</span>


<span class="c">!--------------------------------------------------------------------------------------</span>
<span class="c">!Write matrix in correct format</span>

<span class="k">subroutine </span><span class="nv">write_matrix_int</span><span class="p">(</span><span class="nv">a</span><span class="p">,</span><span class="nv">varname</span><span class="p">,</span><span class="nv">fh</span><span class="p">)</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span>                 <span class="kd">::</span> <span class="nv">i</span><span class="p">,</span><span class="nv">j</span><span class="p">,</span><span class="nv">fh</span>
    <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>            <span class="kd">::</span> <span class="nv">varname</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,:)</span> <span class="kd">::</span> <span class="nv">a</span>

    <span class="k">write</span><span class="p">(</span><span class="nv">fh</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">varname</span>
    <span class="k">do </span><span class="nv">i</span> <span class="o">=</span> <span class="nb">lbound</span><span class="p">(</span><span class="nv">a</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="nb">ubound</span><span class="p">(</span><span class="nv">a</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">fh</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="nv">a</span><span class="p">(</span><span class="nv">i</span><span class="p">,</span><span class="nv">j</span><span class="p">),</span> <span class="nv">j</span> <span class="o">=</span> <span class="nb">lbound</span><span class="p">(</span><span class="nv">a</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="nb">ubound</span><span class="p">(</span><span class="nv">a</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">end do</span>

<span class="k">end subroutine </span><span class="nv">write_matrix_int</span>

<span class="k">subroutine </span><span class="nv">write_matrix</span><span class="p">(</span><span class="nv">a</span><span class="p">,</span><span class="nv">varname</span><span class="p">,</span><span class="nv">fh</span><span class="p">)</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span>                          <span class="kd">::</span> <span class="nv">i</span><span class="p">,</span><span class="nv">j</span><span class="p">,</span><span class="nv">fh</span>
    <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>                     <span class="kd">::</span> <span class="nv">varname</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="p">(</span><span class="mf">0.</span><span class="nv">d0</span><span class="p">)),</span> <span class="k">dimension</span><span class="p">(:,:)</span> <span class="kd">::</span> <span class="nv">a</span>

    <span class="k">write</span><span class="p">(</span><span class="nv">fh</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nv">varname</span>
    <span class="k">do </span><span class="nv">i</span> <span class="o">=</span> <span class="nb">lbound</span><span class="p">(</span><span class="nv">a</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="nb">ubound</span><span class="p">(</span><span class="nv">a</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">write</span><span class="p">(</span><span class="nv">fh</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="nv">a</span><span class="p">(</span><span class="nv">i</span><span class="p">,</span><span class="nv">j</span><span class="p">),</span> <span class="nv">j</span> <span class="o">=</span> <span class="nb">lbound</span><span class="p">(</span><span class="nv">a</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="nb">ubound</span><span class="p">(</span><span class="nv">a</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">end do</span>

<span class="k">end subroutine </span><span class="nv">write_matrix</span>

<span class="c">!===========================================================================</span>
<span class="c">! Subroutine that can be used to stop the code when reaching a given </span>
<span class="c">! point in coupler -- useful when coupling new codes</span>
<span class="c">!---------------------------------------------------------------------------</span>
<span class="c">!subroutine request_stop(tag)</span>
<span class="c">!    use mpi</span>
<span class="c">!    implicit none</span>
<span class="c">!</span>
<span class="c">!    character(len=*),intent(in) ::tag</span>
<span class="c">!    integer myid, ierr</span>
<span class="c">!</span>
<span class="c">!    ! do nothing, get out quick </span>
<span class="c">!    if(.not. stop_request_activated ) return</span>
<span class="c">!</span>
<span class="c">!    if (tag /= stop_request_name) return</span>
<span class="c">!</span>
<span class="c">!    select case(stop_request_name)</span>
<span class="c">!    case(&quot;create_comm&quot;,&quot;CREATE_COMM&quot;)</span>
<span class="c">!        call mpi_comm_rank(CPL_REALM_COMM, myid,ierr)</span>
<span class="c">!        write(0,*) &#39;stop as requested at &#39;, trim(stop_request_name), &#39;, realm&#39;,realm, &#39;rank&#39;, myid</span>
<span class="c">!        call MPI_Finalize(ierr)</span>
<span class="c">!        stop</span>
<span class="c">!    case(&quot;create_map&quot;,&quot;CREATE_MAP&quot;)</span>
<span class="c">!        call mpi_comm_rank(CPL_REALM_COMM, myid,ierr)</span>
<span class="c">!        write(0,*) &#39;stop as requested at &#39;, trim(stop_request_name), &#39;, realm&#39;,realm, &#39;rank&#39;, myid</span>
<span class="c">!        call MPI_Finalize(ierr)</span>
<span class="c">!        stop    </span>
<span class="c">!    case default</span>
<span class="c">!        write(0,*) &quot;WARNING: request abort activated, but the tag is unrecognized, check COUPLER.in&quot;</span>
<span class="c">!        write(0,*) &quot;         accepted stop tags are: create_comm&quot;</span>
<span class="c">!    end select</span>
<span class="c">!</span>
<span class="c">!end subroutine request_stop</span>

<span class="k">function </span><span class="nv">CPL_new_fileunit</span><span class="p">()</span> <span class="nv">result</span> <span class="p">(</span><span class="nv">f</span><span class="p">)</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">logical</span> <span class="kd">::</span> <span class="nv">op</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="nv">f</span>

    <span class="nv">f</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">do </span>
<span class="k">        inquire</span><span class="p">(</span><span class="nv">f</span><span class="p">,</span><span class="nv">opened</span><span class="o">=</span><span class="nv">op</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">op</span> <span class="ow">.eqv.</span> <span class="nb">.false.</span><span class="p">)</span> <span class="k">exit</span>
<span class="k">        </span><span class="nv">f</span> <span class="o">=</span> <span class="nv">f</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nv">enddo</span>

<span class="k">end function</span>


<span class="k">end module </span><span class="nv">coupler_module</span>
</pre></div>

    </section>
    </div>
  </div>

    <hr>
    <footer>
        <div class="row">
        <div class="col-md-6">&copy; 2015 Fortran Program was written by Edward Smith
David Trevelyan. </div>
        <div class="col-md-6"><span class="pull-right">Documentation generated by <a href="https://github.com/cmacmackin/ford">FORD</a>.</span></div>
        </div>
        <br>
    </footer>
    </div> <!-- /container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],
        'HTML-CSS': { 
           styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: '#000000 ! important'} }
        }
      });
    </script>
    <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </body>
</html>